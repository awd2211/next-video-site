# è§†é¢‘è½¬ç ç³»ç»Ÿ - è¯¦ç»†æ¶æ„è®¾è®¡

> **å®Œæ•´çš„å¹¶è¡Œè½¬ç æ¶æ„** - æ”¯æŒ2K/4K + GPUåŠ é€Ÿ + è¾¹ä¸Šä¼ è¾¹è½¬ç 

---

## ğŸ“‹ æ¶æ„æ¦‚è§ˆ

VideoSiteè§†é¢‘è½¬ç ç³»ç»Ÿé‡‡ç”¨**å¾®æœåŠ¡æ¶æ„**ï¼Œé€šè¿‡Celeryåˆ†å¸ƒå¼ä»»åŠ¡é˜Ÿåˆ—å®ç°é«˜å¹¶å‘è§†é¢‘å¤„ç†ã€‚

### æ ¸å¿ƒç»„ä»¶

| ç»„ä»¶ | æŠ€æœ¯ | èŒè´£ | å¹¶å‘èƒ½åŠ› |
|------|------|------|----------|
| **WebæœåŠ¡** | FastAPI | æ¥æ”¶ä¸Šä¼ ã€APIå“åº” | 100+ req/s |
| **ä»»åŠ¡é˜Ÿåˆ—** | Celery + Redis | å¼‚æ­¥ä»»åŠ¡è°ƒåº¦ | 8-20å¹¶å‘ |
| **è½¬ç å¼•æ“** | FFmpeg | è§†é¢‘å¤„ç† | GPU: 12å¹¶å‘ |
| **å¯¹è±¡å­˜å‚¨** | MinIO (S3) | æ–‡ä»¶å­˜å‚¨ | æ— é™ |
| **æ•°æ®åº“** | PostgreSQL | ä»»åŠ¡çŠ¶æ€è¿½è¸ª | 1000+ TPS |
| **ç›‘æ§** | Flower | ä»»åŠ¡ç›‘æ§ | å®æ—¶ |

---

## ğŸ—ï¸ å®Œæ•´æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ç®¡ç†å‘˜åå° (Admin Frontend)                          â”‚
â”‚                        React + Ant Design + TypeScript                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  è§†é¢‘ä¸Šä¼ ç•Œé¢                                                       â”‚    â”‚
â”‚  â”‚  â€¢ æ‹–æ‹½ä¸Šä¼  / ç‚¹å‡»ä¸Šä¼                                               â”‚    â”‚
â”‚  â”‚  â€¢ åˆ†ç‰‡ä¸Šä¼  (5MB/ç‰‡)                                                â”‚    â”‚
â”‚  â”‚  â€¢ æ–­ç‚¹ç»­ä¼                                                          â”‚    â”‚
â”‚  â”‚  â€¢ å®æ—¶è¿›åº¦æ¡                                                       â”‚    â”‚
â”‚  â”‚  â€¢ è½¬ç çŠ¶æ€ç›‘æ§                                                     â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚ HTTP POST /api/v1/admin/upload/*
                                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        FastAPI åç«¯æœåŠ¡ (Port 8000)                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  ä¸Šä¼ API (backend/app/admin/upload.py)                             â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚    â”‚
â”‚  â”‚  â”‚  1. init_multipart_upload()                              â”‚     â”‚    â”‚
â”‚  â”‚  â”‚     â€¢ åˆ›å»ºä¸Šä¼ ä¼šè¯                                        â”‚     â”‚    â”‚
â”‚  â”‚  â”‚     â€¢ ç”Ÿæˆupload_id                                       â”‚     â”‚    â”‚
â”‚  â”‚  â”‚     â€¢ è¿”å›åˆ†ç‰‡å¤§å° (5MB)                                  â”‚     â”‚    â”‚
â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”‚    â”‚
â”‚  â”‚  â”‚  2. upload_chunk()                                       â”‚     â”‚    â”‚
â”‚  â”‚  â”‚     â€¢ æ¥æ”¶å•ä¸ªåˆ†ç‰‡                                        â”‚     â”‚    â”‚
â”‚  â”‚  â”‚     â€¢ ä¿å­˜åˆ° /tmp/uploads/{upload_id}/chunk_{index}      â”‚     â”‚    â”‚
â”‚  â”‚  â”‚     â€¢ æ›´æ–°è¿›åº¦                                            â”‚     â”‚    â”‚
â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”‚    â”‚
â”‚  â”‚  â”‚  3. complete_multipart_upload() â­ å…³é”®                  â”‚     â”‚    â”‚
â”‚  â”‚  â”‚     â€¢ åˆå¹¶æ‰€æœ‰åˆ†ç‰‡                                        â”‚     â”‚    â”‚
â”‚  â”‚  â”‚     â€¢ ä¸Šä¼ åˆ°MinIO                                         â”‚     â”‚    â”‚
â”‚  â”‚  â”‚     â€¢ âœ¨ ç«‹å³è§¦å‘è½¬ç ä»»åŠ¡ (æ— éœ€ç­‰å¾…!)                    â”‚     â”‚    â”‚
â”‚  â”‚  â”‚       transcode_video_task.delay(video_id, source_url)   â”‚     â”‚    â”‚
â”‚  â”‚  â”‚     â€¢ ç§’çº§è¿”å›HTTP 200                                    â”‚     â”‚    â”‚
â”‚  â”‚  â”‚     â€¢ è½¬ç åœ¨åå°å¼‚æ­¥è¿›è¡Œ                                  â”‚     â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                              â”‚
â”‚  å…¶ä»–API:                                                                   â”‚
â”‚  â€¢ GET  /api/v1/videos/{id}/transcoding-status  (æŸ¥è¯¢è½¬ç çŠ¶æ€)            â”‚
â”‚  â€¢ POST /api/v1/admin/transcoding/{id}/retry   (é‡è¯•å¤±è´¥ä»»åŠ¡)             â”‚
â”‚  â€¢ GET  /api/v1/admin/transcoding/queue        (æŸ¥çœ‹é˜Ÿåˆ—çŠ¶æ€)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚ Celery Task: transcode_video_task.delay()
                                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Redis - ä»»åŠ¡é˜Ÿåˆ—å’Œç»“æœå­˜å‚¨ (Port 6379)                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Broker (æ¶ˆæ¯é˜Ÿåˆ—):                                                 â”‚    â”‚
â”‚  â”‚  â€¢ Queue: high_priority   â†’ 4K/2Kè§†é¢‘ (ä¼˜å…ˆçº§10)                   â”‚    â”‚
â”‚  â”‚  â€¢ Queue: normal          â†’ 1080p/720pè§†é¢‘ (ä¼˜å…ˆçº§6)               â”‚    â”‚
â”‚  â”‚  â€¢ Queue: low_priority    â†’ ç¼©ç•¥å›¾/é¢„è§ˆ (ä¼˜å…ˆçº§2)                  â”‚    â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚
â”‚  â”‚  Backend (ç»“æœå­˜å‚¨):                                                â”‚    â”‚
â”‚  â”‚  â€¢ Task results (24å°æ—¶è¿‡æœŸ)                                        â”‚    â”‚
â”‚  â”‚  â€¢ Progress cache (å®æ—¶è¿›åº¦)                                        â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚        â”‚        â”‚        â”‚        â”‚        â”‚        â”‚        â”‚
    â”‚ Worker â”‚ Worker â”‚ Worker â”‚ Worker â”‚ Worker â”‚ Worker â”‚ Worker â”‚ Worker
    â”‚   #1   â”‚   #2   â”‚   #3   â”‚   #4   â”‚   #5   â”‚   #6   â”‚   #7   â”‚   #8
    â–¼        â–¼        â–¼        â–¼        â–¼        â–¼        â–¼        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Celery Workers - è½¬ç å¤„ç†é›†ç¾¤                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  Workeré…ç½®:                                                      â”‚     â”‚
â”‚  â”‚  â€¢ Concurrency: 12 (æ¯ä¸ªworker 12ä¸ªå¹¶å‘ä»»åŠ¡)                     â”‚     â”‚
â”‚  â”‚  â€¢ Prefetch: 1 (é¿å…workeré¥¿æ­»)                                  â”‚     â”‚
â”‚  â”‚  â€¢ Max tasks per child: 50 (é˜²æ­¢å†…å­˜æ³„æ¼)                        â”‚     â”‚
â”‚  â”‚  â€¢ Timeout: 3600s (1å°æ—¶ç¡¬è¶…æ—¶)                                  â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                             â”‚
â”‚  ä»»åŠ¡å¤„ç†æµç¨‹: transcode_video(video_id)                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  Step 1: åˆå§‹åŒ–                                                   â”‚     â”‚
â”‚  â”‚  â€¢ æ›´æ–°ä»»åŠ¡çŠ¶æ€: processing                                       â”‚     â”‚
â”‚  â”‚  â€¢ åˆ›å»ºä¸´æ—¶ç›®å½•: /tmp/transcode_{video_id}/                      â”‚     â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”‚
â”‚  â”‚  Step 2: ä¸‹è½½åŸå§‹è§†é¢‘                                             â”‚     â”‚
â”‚  â”‚  â€¢ ä»MinIOä¸‹è½½åˆ°ä¸´æ—¶ç›®å½•                                          â”‚     â”‚
â”‚  â”‚  â€¢ è¿›åº¦: 0-10%                                                    â”‚     â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”‚
â”‚  â”‚  Step 3: åˆ†æè§†é¢‘å…ƒæ•°æ® (FFprobe)                                â”‚     â”‚
â”‚  â”‚  â€¢ åˆ†è¾¨ç‡: 3840x2160 (4K)                                         â”‚     â”‚
â”‚  â”‚  â€¢ æ—¶é•¿: 3600s (1å°æ—¶)                                            â”‚     â”‚
â”‚  â”‚  â€¢ ç ç‡: 50Mbps                                                   â”‚     â”‚
â”‚  â”‚  â€¢ ç¼–ç : h264                                                     â”‚     â”‚
â”‚  â”‚  â€¢ å¸§ç‡: 30fps                                                    â”‚     â”‚
â”‚  â”‚  â€¢ è¿›åº¦: 10-15%                                                   â”‚     â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”‚
â”‚  â”‚  Step 4: æ™ºèƒ½å†³å®šè½¬ç åˆ†è¾¨ç‡ â­                                   â”‚     â”‚
â”‚  â”‚  â€¢ æº: 4K (2160p)                                                 â”‚     â”‚
â”‚  â”‚  â€¢ ç›®æ ‡: [2K, 1080p, 720p, 480p, 360p] (5ä¸ªåˆ†è¾¨ç‡)              â”‚     â”‚
â”‚  â”‚  â€¢ è·³è¿‡: 4K (ä¿ç•™åŸå§‹)                                            â”‚     â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”‚
â”‚  â”‚  Step 5: å¹¶è¡Œè½¬ç  (ThreadPoolExecutor) ğŸš€                       â”‚     â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚     â”‚
â”‚  â”‚  â”‚  Thread 1: è½¬ç  2K (HEVC GPU)                          â”‚     â”‚     â”‚
â”‚  â”‚  â”‚  â€¢ FFmpeg: hevc_nvenc                                  â”‚     â”‚     â”‚
â”‚  â”‚  â”‚  â€¢ åˆ†è¾¨ç‡: 2560x1440                                   â”‚     â”‚     â”‚
â”‚  â”‚  â”‚  â€¢ ç ç‡: 12Mbps                                        â”‚     â”‚     â”‚
â”‚  â”‚  â”‚  â€¢ è€—æ—¶: ~8åˆ†é’Ÿ (GPU)                                  â”‚     â”‚     â”‚
â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”‚     â”‚
â”‚  â”‚  â”‚  Thread 2: è½¬ç  1080p (H.264 GPU)                     â”‚     â”‚     â”‚
â”‚  â”‚  â”‚  â€¢ FFmpeg: h264_nvenc                                  â”‚     â”‚     â”‚
â”‚  â”‚  â”‚  â€¢ è€—æ—¶: ~5åˆ†é’Ÿ                                        â”‚     â”‚     â”‚
â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”‚     â”‚
â”‚  â”‚  â”‚  Thread 3: è½¬ç  720p (H.264 GPU)                      â”‚     â”‚     â”‚
â”‚  â”‚  â”‚  â€¢ è€—æ—¶: ~3åˆ†é’Ÿ                                        â”‚     â”‚     â”‚
â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”‚     â”‚
â”‚  â”‚  â”‚  Thread 4: è½¬ç  480p (H.264 CPU)                      â”‚     â”‚     â”‚
â”‚  â”‚  â”‚  â€¢ è€—æ—¶: ~4åˆ†é’Ÿ                                        â”‚     â”‚     â”‚
â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”‚     â”‚
â”‚  â”‚  â”‚  Thread 5: è½¬ç  360p (H.264 CPU)                      â”‚     â”‚     â”‚
â”‚  â”‚  â”‚  â€¢ è€—æ—¶: ~2åˆ†é’Ÿ                                        â”‚     â”‚     â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚     â”‚
â”‚  â”‚  è¿›åº¦: 15-70% (åŠ¨æ€æ›´æ–°)                                          â”‚     â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”‚
â”‚  â”‚  Step 6: ç”ŸæˆHLSåˆ‡ç‰‡ (æ¯ä¸ªåˆ†è¾¨ç‡)                                â”‚     â”‚
â”‚  â”‚  â€¢ åˆ‡ç‰‡æ—¶é•¿: 6ç§’/ç‰‡                                               â”‚     â”‚
â”‚  â”‚  â€¢ æ ¼å¼: MPEG-TS (.ts)                                            â”‚     â”‚
â”‚  â”‚  â€¢ æ’­æ”¾åˆ—è¡¨: index.m3u8                                           â”‚     â”‚
â”‚  â”‚  â€¢ è¿›åº¦: 70-85%                                                   â”‚     â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”‚
â”‚  â”‚  Step 7: ç”ŸæˆMaster Playlist                                     â”‚     â”‚
â”‚  â”‚  â€¢ åŒ…å«æ‰€æœ‰åˆ†è¾¨ç‡é€‰é¡¹                                             â”‚     â”‚
â”‚  â”‚  â€¢ è‡ªé€‚åº”ç ç‡é…ç½®                                                 â”‚     â”‚
â”‚  â”‚  â€¢ è¿›åº¦: 85-90%                                                   â”‚     â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”‚
â”‚  â”‚  Step 8: ç”Ÿæˆç¼©ç•¥å›¾å’Œé¢„è§ˆ                                         â”‚     â”‚
â”‚  â”‚  â€¢ å°é¢å›¾ (poster.jpg) - ç¬¬5ç§’æˆªå›¾                              â”‚     â”‚
â”‚  â”‚  â€¢ æ—¶é—´è½´ç¼©ç•¥å›¾ (thumb_*.jpg) - æ¯10ç§’ä¸€å¼                        â”‚     â”‚
â”‚  â”‚  â€¢ æ‚¬åœé¢„è§ˆè§†é¢‘ (hover_preview.webm) - 10ç§’ç²¾å                 â”‚     â”‚
â”‚  â”‚  â€¢ è¿›åº¦: 90-95%                                                   â”‚     â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”‚
â”‚  â”‚  Step 9: ä¸Šä¼ åˆ°MinIO                                              â”‚     â”‚
â”‚  â”‚  â€¢ æ‰€æœ‰HLSæ–‡ä»¶ (.m3u8 + .ts)                                      â”‚     â”‚
â”‚  â”‚  â€¢ ç¼©ç•¥å›¾å’Œé¢„è§ˆè§†é¢‘                                               â”‚     â”‚
â”‚  â”‚  â€¢ è¿›åº¦: 95-99%                                                   â”‚     â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”‚
â”‚  â”‚  Step 10: æ›´æ–°æ•°æ®åº“                                              â”‚     â”‚
â”‚  â”‚  â€¢ transcoding_tasks.status = 'completed'                         â”‚     â”‚
â”‚  â”‚  â€¢ transcoding_tasks.progress = 100                               â”‚     â”‚
â”‚  â”‚  â€¢ videos.hover_preview_url = ...                                 â”‚     â”‚
â”‚  â”‚  â€¢ videos.hls_master_url = ...                                    â”‚     â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”‚
â”‚  â”‚  Step 11: æ¸…ç†ä¸´æ—¶æ–‡ä»¶                                            â”‚     â”‚
â”‚  â”‚  â€¢ åˆ é™¤ /tmp/transcode_{video_id}/                               â”‚     â”‚
â”‚  â”‚  â€¢ è¿›åº¦: 100% âœ… å®Œæˆ                                             â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚ ä¸Šä¼ æ–‡ä»¶
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       MinIO å¯¹è±¡å­˜å‚¨ (Port 9000/9001)                        â”‚
â”‚  Bucket: videos/                                                             â”‚
â”‚  â”œâ”€â”€ {video_id}/                                                            â”‚
â”‚  â”‚   â”œâ”€â”€ original/                                                          â”‚
â”‚  â”‚   â”‚   â””â”€â”€ source.mp4                    (åŸå§‹4Kè§†é¢‘, 15GB)              â”‚
â”‚  â”‚   â”œâ”€â”€ hls/                                                               â”‚
â”‚  â”‚   â”‚   â”œâ”€â”€ master.m3u8                   (ä¸»æ’­æ”¾åˆ—è¡¨)                    â”‚
â”‚  â”‚   â”‚   â”œâ”€â”€ 4K/                           (åŸå§‹åˆ†è¾¨ç‡)                    â”‚
â”‚  â”‚   â”‚   â”‚   â”œâ”€â”€ index.m3u8                                                â”‚
â”‚  â”‚   â”‚   â”‚   â””â”€â”€ segment_*.ts              (600ä¸ªåˆ‡ç‰‡,æ¯ä¸ª6ç§’)            â”‚
â”‚  â”‚   â”‚   â”œâ”€â”€ 2K/                           (HEVCç¼–ç , 5.4GB)              â”‚
â”‚  â”‚   â”‚   â”œâ”€â”€ 1080p/                        (H.264ç¼–ç , 2.2GB)             â”‚
â”‚  â”‚   â”‚   â”œâ”€â”€ 720p/                         (1.1GB)                         â”‚
â”‚  â”‚   â”‚   â”œâ”€â”€ 480p/                         (450MB)                         â”‚
â”‚  â”‚   â”‚   â””â”€â”€ 360p/                         (270MB)                         â”‚
â”‚  â”‚   â”œâ”€â”€ preview/                                                           â”‚
â”‚  â”‚   â”‚   â””â”€â”€ hover_preview.webm            (10ç§’é¢„è§ˆ, 600KB)               â”‚
â”‚  â”‚   â””â”€â”€ thumbnails/                                                        â”‚
â”‚  â”‚       â”œâ”€â”€ poster.jpg                    (å°é¢, 200KB)                   â”‚
â”‚  â”‚       â””â”€â”€ thumb_*.jpg                   (360å¼ æ—¶é—´è½´ç¼©ç•¥å›¾)             â”‚
â”‚  â”‚                                                                           â”‚
â”‚  æ€»å­˜å‚¨: ~25GB (1å°æ—¶4Kè§†é¢‘å®Œæ•´è½¬ç )                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚ è¯»å–æ’­æ”¾URL
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        PostgreSQL æ•°æ®åº“ (Port 5432)                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  transcoding_tasks è¡¨                                               â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚    â”‚
â”‚  â”‚  â”‚  id: 123                                                  â”‚     â”‚    â”‚
â”‚  â”‚  â”‚  video_id: 456                                            â”‚     â”‚    â”‚
â”‚  â”‚  â”‚  status: 'completed'                                      â”‚     â”‚    â”‚
â”‚  â”‚  â”‚  progress: 100                                            â”‚     â”‚    â”‚
â”‚  â”‚  â”‚  source_resolution: '3840x2160'                          â”‚     â”‚    â”‚
â”‚  â”‚  â”‚  resolutions: {                                           â”‚     â”‚    â”‚
â”‚  â”‚  â”‚    "4K": "videos/456/hls/4K/index.m3u8",                â”‚     â”‚    â”‚
â”‚  â”‚  â”‚    "2K": "videos/456/hls/2K/index.m3u8",                â”‚     â”‚    â”‚
â”‚  â”‚  â”‚    "1080p": "videos/456/hls/1080p/index.m3u8",          â”‚     â”‚    â”‚
â”‚  â”‚  â”‚    ...                                                    â”‚     â”‚    â”‚
â”‚  â”‚  â”‚  }                                                         â”‚     â”‚    â”‚
â”‚  â”‚  â”‚  master_playlist_url: "videos/456/hls/master.m3u8"      â”‚     â”‚    â”‚
â”‚  â”‚  â”‚  preview_url: "videos/456/preview/hover_preview.webm"   â”‚     â”‚    â”‚
â”‚  â”‚  â”‚  transcoding_time_seconds: 600 (10åˆ†é’Ÿ)                 â”‚     â”‚    â”‚
â”‚  â”‚  â”‚  gpu_accelerated: true                                   â”‚     â”‚    â”‚
â”‚  â”‚  â”‚  worker_id: "celery@worker1"                            â”‚     â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚ CDNåŠ é€Ÿ (å¯é€‰)
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       ç”¨æˆ·å‰ç«¯ (Frontend - Port 3000)                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Video.js HLSæ’­æ”¾å™¨                                                 â”‚    â”‚
â”‚  â”‚  â€¢ åŠ è½½ master.m3u8                                                 â”‚    â”‚
â”‚  â”‚  â€¢ è‡ªåŠ¨é€‰æ‹©åˆ†è¾¨ç‡ (åŸºäºç½‘é€Ÿ)                                        â”‚    â”‚
â”‚  â”‚  â€¢ æ¸…æ™°åº¦æ‰‹åŠ¨åˆ‡æ¢: [4K] [2K] [1080p] [720p] [480p] [360p]         â”‚    â”‚
â”‚  â”‚  â€¢ è‡ªé€‚åº”ç ç‡ (ABR)                                                 â”‚    â”‚
â”‚  â”‚  â€¢ ç¼“å†²ä¼˜åŒ–                                                         â”‚    â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚
â”‚  â”‚  VideoCard æ‚¬åœé¢„è§ˆ                                                 â”‚    â”‚
â”‚  â”‚  â€¢ é¼ æ ‡hover 500msåæ’­æ”¾é¢„è§ˆ                                        â”‚    â”‚
â”‚  â”‚  â€¢ åŠ è½½ hover_preview.webm                                          â”‚    â”‚
â”‚  â”‚  â€¢ æ‡’åŠ è½½ä¼˜åŒ–                                                       â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ æ•°æ®æµè¯¦è§£

### 1. ä¸Šä¼ æµç¨‹

```
ç®¡ç†å‘˜ â†’ é€‰æ‹©4Kè§†é¢‘ (3GB)
    â†“
å‰ç«¯ â†’ åˆ†ç‰‡ (3GB / 5MB = 600ä¸ªåˆ†ç‰‡)
    â†“
FastAPI â†’ æ¥æ”¶åˆ†ç‰‡å¹¶ä¿å­˜åˆ° /tmp/uploads/{upload_id}/chunk_{0-599}
    â†“
FastAPI â†’ åˆå¹¶åˆ†ç‰‡ â†’ å®Œæ•´çš„3GBè§†é¢‘æ–‡ä»¶
    â†“
FastAPI â†’ ä¸Šä¼ åˆ°MinIO: videos/{video_id}/original/source.mp4
    â†“
FastAPI â†’ åˆ›å»ºæ•°æ®åº“è®°å½•:
          â€¢ videosè¡¨: video_id, title, ...
          â€¢ transcoding_tasksè¡¨: video_id, status='pending'
    â†“
FastAPI â†’ è§¦å‘Celeryä»»åŠ¡:
          transcode_video_task.delay(video_id=456, source_url=...)
    â†“
FastAPI â†’ è¿”å›HTTP 200ç»™å‰ç«¯ (è€—æ—¶: ~30ç§’)
    â†“
å‰ç«¯ â†’ æ˜¾ç¤º"ä¸Šä¼ æˆåŠŸ,æ­£åœ¨è½¬ç ä¸­..."
```

### 2. è½¬ç æµç¨‹

```
Celery Worker #1 â†’ ä»Redisé˜Ÿåˆ—è·å–ä»»åŠ¡
    â†“
Worker â†’ ä¸‹è½½åŸå§‹è§†é¢‘åˆ° /tmp/transcode_456/original.mp4
    â†“
Worker â†’ FFprobeåˆ†æ: 4K, 3600s, h264, 30fps
    â†“
Worker â†’ å†³å®šè½¬ç åˆ†è¾¨ç‡: [2K, 1080p, 720p, 480p, 360p]
    â†“
Worker â†’ å¯åŠ¨5ä¸ªçº¿ç¨‹å¹¶è¡Œè½¬ç  (ThreadPoolExecutor)
    â”œâ”€ Thread 1: FFmpeg 2K HEVC GPU (8åˆ†é’Ÿ)
    â”œâ”€ Thread 2: FFmpeg 1080p H.264 GPU (5åˆ†é’Ÿ)
    â”œâ”€ Thread 3: FFmpeg 720p H.264 GPU (3åˆ†é’Ÿ)
    â”œâ”€ Thread 4: FFmpeg 480p H.264 CPU (4åˆ†é’Ÿ)
    â””â”€ Thread 5: FFmpeg 360p H.264 CPU (2åˆ†é’Ÿ)
    â†“
Worker â†’ ç­‰å¾…æ‰€æœ‰çº¿ç¨‹å®Œæˆ (æœ€é•¿8åˆ†é’Ÿ)
    â†“
Worker â†’ ä¸ºæ¯ä¸ªåˆ†è¾¨ç‡ç”ŸæˆHLSåˆ‡ç‰‡ (6ç§’/ç‰‡)
    â”œâ”€ 2K/index.m3u8 + 600ä¸ª .tsæ–‡ä»¶
    â”œâ”€ 1080p/index.m3u8 + 600ä¸ª .tsæ–‡ä»¶
    â””â”€ ...
    â†“
Worker â†’ ç”ŸæˆMaster Playlist (master.m3u8)
    â†“
Worker â†’ ç”Ÿæˆç¼©ç•¥å›¾å’Œé¢„è§ˆ
    â”œâ”€ poster.jpg (ç¬¬5ç§’)
    â”œâ”€ thumb_*.jpg (360å¼ ,æ¯10ç§’ä¸€å¼ )
    â””â”€ hover_preview.webm (10ç§’ç²¾å)
    â†“
Worker â†’ ä¸Šä¼ æ‰€æœ‰æ–‡ä»¶åˆ°MinIO (~25GB)
    â†“
Worker â†’ æ›´æ–°æ•°æ®åº“: status='completed', progress=100
    â†“
Worker â†’ æ¸…ç†ä¸´æ—¶æ–‡ä»¶
    â†“
Worker â†’ ä»»åŠ¡å®Œæˆ âœ… (æ€»è€—æ—¶: ~15åˆ†é’Ÿ)
```

### 3. æ’­æ”¾æµç¨‹

```
ç”¨æˆ·è®¿é—®è§†é¢‘è¯¦æƒ…é¡µ
    â†“
Frontend â†’ GET /api/v1/videos/456
    â†“
Backend â†’ è¿”å›è§†é¢‘ä¿¡æ¯:
          {
            "hls_master_url": "videos/456/hls/master.m3u8",
            "hover_preview_url": "videos/456/preview/hover_preview.webm",
            "poster_url": "videos/456/thumbnails/poster.jpg"
          }
    â†“
Frontend â†’ Video.jsåŠ è½½ master.m3u8
    â†“
Video.js â†’ æ£€æµ‹ç½‘é€Ÿ: 100Mbps
    â†“
Video.js â†’ è‡ªåŠ¨é€‰æ‹©: 4K (3840x2160)
    â†“
Video.js â†’ åŠ è½½4K/index.m3u8
    â†“
Video.js â†’ å¼€å§‹æ’­æ”¾4K/segment_000.ts
    â†“
ç”¨æˆ· â†’ æµç•…è§‚çœ‹4Kè§†é¢‘ ğŸ¬
```

---

## âš¡ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 1. å¹¶è¡Œå¤„ç†

**ç­–ç•¥**: ä½¿ç”¨ThreadPoolExecutoråŒæ—¶è½¬ç å¤šä¸ªåˆ†è¾¨ç‡

```python
from concurrent.futures import ThreadPoolExecutor

with ThreadPoolExecutor(max_workers=5) as executor:
    futures = [
        executor.submit(transcode_to_mp4, original, '2K', profile_2k),
        executor.submit(transcode_to_mp4, original, '1080p', profile_1080p),
        executor.submit(transcode_to_mp4, original, '720p', profile_720p),
        executor.submit(transcode_to_mp4, original, '480p', profile_480p),
        executor.submit(transcode_to_mp4, original, '360p', profile_360p),
    ]
    results = [f.result() for f in futures]
```

**æ•ˆæœ**:
- ä¸²è¡Œ: 2K(8m) + 1080p(5m) + 720p(3m) + 480p(4m) + 360p(2m) = **22åˆ†é’Ÿ**
- å¹¶è¡Œ: max(8m, 5m, 3m, 4m, 2m) = **8åˆ†é’Ÿ** âš¡ 2.75å€æé€Ÿ

### 2. GPUåŠ é€Ÿ

**ç­–ç•¥**: ä½¿ç”¨NVIDIA GPUç¡¬ä»¶ç¼–ç å™¨

```bash
# CPUç¼–ç  (1å°æ—¶è§†é¢‘ â†’ 2å°æ—¶è½¬ç )
ffmpeg -i input.mp4 -c:v libx264 ...

# GPUç¼–ç  (1å°æ—¶è§†é¢‘ â†’ 10åˆ†é’Ÿè½¬ç )
ffmpeg -hwaccel cuda -i input.mp4 -c:v h264_nvenc ...
```

**æ•ˆæœ**: 12å€é€Ÿåº¦æå‡ ğŸš€

### 3. æ™ºèƒ½åˆ†è¾¨ç‡

**ç­–ç•¥**: æ ¹æ®æºåˆ†è¾¨ç‡è·³è¿‡ä¸å¿…è¦çš„è½¬ç 

```python
def get_target_resolutions(source_height):
    if source_height >= 2160:  # 4Kæº
        return ['2K', '1080p', '720p', '480p', '360p']  # ä¸è½¬4K,ä¿ç•™åŸå§‹
    elif source_height >= 1440:  # 2Kæº
        return ['1080p', '720p', '480p', '360p']  # ä¸è½¬2K
    # ...
```

**æ•ˆæœ**: èŠ‚çœ20-40%è½¬ç æ—¶é—´

---

## ğŸ“Š æ€§èƒ½åŸºå‡†æµ‹è¯•

### æµ‹è¯•ç¯å¢ƒ
- CPU: Intel i7-9700K (8æ ¸)
- GPU: NVIDIA RTX 3060 (12GB)
- å†…å­˜: 32GB DDR4
- å­˜å‚¨: NVMe SSD

### æµ‹è¯•ç»“æœ (1å°æ—¶1080pè§†é¢‘)

| ä»»åŠ¡ | CPU | GPU | æå‡ |
|------|-----|-----|------|
| è½¬ç åˆ°720p | 45åˆ†é’Ÿ | 5åˆ†é’Ÿ | 9x |
| è½¬ç åˆ°1080p | 120åˆ†é’Ÿ | 10åˆ†é’Ÿ | 12x |
| è½¬ç åˆ°2K | 180åˆ†é’Ÿ | 15åˆ†é’Ÿ | 12x |
| ç”ŸæˆHLSåˆ‡ç‰‡ | 10åˆ†é’Ÿ | 10åˆ†é’Ÿ | - |
| ç”Ÿæˆç¼©ç•¥å›¾ | 2åˆ†é’Ÿ | 2åˆ†é’Ÿ | - |
| **æ€»è®¡** | **357åˆ†é’Ÿ** | **42åˆ†é’Ÿ** | **8.5x** |

---

## ğŸ”’ å¯é æ€§ä¿éšœ

### 1. ä»»åŠ¡é‡è¯•

```python
@celery_app.task(
    autoretry_for=(Exception,),
    retry_kwargs={'max_retries': 3, 'countdown': 300},
    retry_backoff=True
)
def transcode_video(video_id):
    # è½¬ç é€»è¾‘
    pass
```

### 2. è¿›åº¦è¿½è¸ª

å®æ—¶æ›´æ–°æ•°æ®åº“è¿›åº¦,å‰ç«¯è½®è¯¢æˆ–WebSocketæ¨é€

### 3. é”™è¯¯å¤„ç†

```python
try:
    transcode_result = ffmpeg_transcode(...)
except FFmpegError as e:
    task.status = 'failed'
    task.error_message = str(e)
    task.error_stack = traceback.format_exc()
    db.commit()
```

### 4. èµ„æºæ¸…ç†

```python
finally:
    # æ€»æ˜¯æ¸…ç†ä¸´æ—¶æ–‡ä»¶
    if temp_dir.exists():
        shutil.rmtree(temp_dir, ignore_errors=True)
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0.0
**åˆ›å»ºæ—¶é—´**: 2025-10-10
**ä½œè€…**: Claude AI
