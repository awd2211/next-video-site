# è¾¹ä¸Šä¼ è¾¹è½¬ç å·¥ä½œæµ

> **é›¶ç­‰å¾…è½¬ç ** - ä¸Šä¼ å®Œæˆç«‹å³å¼€å§‹è½¬ç ï¼Œæ— ç¼é›†æˆ

---

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

ä¼ ç»Ÿå·¥ä½œæµå­˜åœ¨çš„é—®é¢˜ï¼š
```
ä¸Šä¼ è§†é¢‘(10åˆ†é’Ÿ) â†’ ç­‰å¾… â†’ æ‰‹åŠ¨è§¦å‘è½¬ç  â†’ è½¬ç (30åˆ†é’Ÿ) = æ€»è®¡40åˆ†é’Ÿ + äººå·¥æ“ä½œ
```

ä¼˜åŒ–åçš„å·¥ä½œæµï¼š
```
ä¸Šä¼ è§†é¢‘(10åˆ†é’Ÿ) â†’ è‡ªåŠ¨è§¦å‘è½¬ç (30åˆ†é’Ÿå¹¶è¡Œ) = æ€»è®¡10åˆ†é’Ÿ + è‡ªåŠ¨åŒ– âš¡
```

### æ ¸å¿ƒä¼˜åŠ¿

- âœ… **é›¶ç­‰å¾…**: ä¸Šä¼ å®Œæˆç«‹å³å¼€å§‹è½¬ç 
- âœ… **è‡ªåŠ¨åŒ–**: æ— éœ€äººå·¥å¹²é¢„
- âœ… **å¹¶è¡Œå¤„ç†**: ä¸Šä¼ ä¸‹ä¸€ä¸ªè§†é¢‘æ—¶ï¼Œå‰ä¸€ä¸ªæ­£åœ¨è½¬ç 
- âœ… **å®æ—¶åé¦ˆ**: ç®¡ç†å‘˜å¯å®æ—¶æŸ¥çœ‹è½¬ç è¿›åº¦
- âœ… **å¤±è´¥é‡è¯•**: è½¬ç å¤±è´¥è‡ªåŠ¨é‡è¯•ï¼Œæ— éœ€é‡æ–°ä¸Šä¼ 

---

## ğŸ—ï¸ å®Œæ•´å·¥ä½œæµæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ç®¡ç†å‘˜åå° - è§†é¢‘ä¸Šä¼ é¡µé¢                             â”‚
â”‚  /admin/videos/upload                                              â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  [æ‹–æ‹½æ–‡ä»¶æˆ–ç‚¹å‡»ä¸Šä¼ ]                                    â”‚     â”‚
â”‚  â”‚                                                           â”‚     â”‚
â”‚  â”‚  é€‰æ‹©æ–‡ä»¶: movie_4k.mp4 (3GB)                           â”‚     â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚     â”‚
â”‚  â”‚  â”‚ ä¸Šä¼ è¿›åº¦: â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–‘â–‘ 85% (2.55GB/3GB)    â”‚    â”‚     â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚     â”‚
â”‚  â”‚                                                           â”‚     â”‚
â”‚  â”‚  é¢„è®¡å‰©ä½™æ—¶é—´: 1åˆ†30ç§’                                   â”‚     â”‚
â”‚  â”‚  ä¸Šä¼ é€Ÿåº¦: 20MB/s                                        â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚ 1. åˆ†ç‰‡ä¸Šä¼  (5MB/ç‰‡)
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      FastAPI Backend - ä¸Šä¼ API                                     â”‚
â”‚      backend/app/admin/upload.py                                   â”‚
â”‚                                                                     â”‚
â”‚  Step 1: init_multipart_upload()                                   â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚
â”‚  POST /api/v1/admin/upload/init-multipart                          â”‚
â”‚  Body: {                                                            â”‚
â”‚    "filename": "movie_4k.mp4",                                     â”‚
â”‚    "file_size": 3221225472,  // 3GB                                â”‚
â”‚    "file_type": "video/mp4"                                        â”‚
â”‚  }                                                                  â”‚
â”‚  Response: {                                                        â”‚
â”‚    "upload_id": "abc123...",                                       â”‚
â”‚    "chunk_size": 5242880     // 5MB                                â”‚
â”‚  }                                                                  â”‚
â”‚                                                                     â”‚
â”‚  Step 2: upload_chunk() Ã— 600æ¬¡                                    â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚
â”‚  POST /api/v1/admin/upload/upload-chunk                            â”‚
â”‚  Body (FormData):                                                   â”‚
â”‚    upload_id: "abc123..."                                          â”‚
â”‚    chunk_index: 0-599                                              â”‚
â”‚    total_chunks: 600                                               â”‚
â”‚    file: <binary data 5MB>                                         â”‚
â”‚  Response: {                                                        â”‚
â”‚    "progress": 85.5,                                               â”‚
â”‚    "uploaded_chunks": 513,                                         â”‚
â”‚    "total_chunks": 600                                             â”‚
â”‚  }                                                                  â”‚
â”‚  å­˜å‚¨: /tmp/uploads/abc123/chunk_{0-599}                           â”‚
â”‚                                                                     â”‚
â”‚  Step 3: complete_multipart_upload() â­ å…³é”®æ­¥éª¤                  â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚
â”‚  POST /api/v1/admin/upload/complete-multipart                      â”‚
â”‚  Body: {                                                            â”‚
â”‚    "upload_id": "abc123...",                                       â”‚
â”‚    "video_id": 456,                                                â”‚
â”‚    "upload_type": "video"                                          â”‚
â”‚  }                                                                  â”‚
â”‚                                                                     â”‚
â”‚  å¤„ç†æµç¨‹:                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ 1. éªŒè¯æ‰€æœ‰åˆ†ç‰‡å®Œæ•´æ€§                                     â”‚     â”‚
â”‚  â”‚    âœ“ æ£€æŸ¥600ä¸ªåˆ†ç‰‡å…¨éƒ¨å­˜åœ¨                               â”‚     â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”‚
â”‚  â”‚ 2. åˆå¹¶åˆ†ç‰‡                                               â”‚     â”‚
â”‚  â”‚    merged_file = BytesIO()                                â”‚     â”‚
â”‚  â”‚    for i in range(600):                                   â”‚     â”‚
â”‚  â”‚        chunk = read(f"chunk_{i}")                         â”‚     â”‚
â”‚  â”‚        merged_file.write(chunk)                           â”‚     â”‚
â”‚  â”‚    âœ“ åˆå¹¶å®Œæˆ: 3GBå®Œæ•´æ–‡ä»¶                               â”‚     â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”‚
â”‚  â”‚ 3. ä¸Šä¼ åˆ°MinIO                                            â”‚     â”‚
â”‚  â”‚    object_name = "videos/456/original/source.mp4"        â”‚     â”‚
â”‚  â”‚    minio_client.upload(merged_file, object_name)          â”‚     â”‚
â”‚  â”‚    âœ“ ä¸Šä¼ æˆåŠŸ                                            â”‚     â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”‚
â”‚  â”‚ 4. åˆ›å»ºæ•°æ®åº“è®°å½•                                         â”‚     â”‚
â”‚  â”‚    â€¢ videosè¡¨: INSERT (video_id=456, ...)               â”‚     â”‚
â”‚  â”‚    â€¢ transcoding_tasksè¡¨:                                â”‚     â”‚
â”‚  â”‚      INSERT (video_id=456, status='pending')             â”‚     â”‚
â”‚  â”‚    âœ“ æ•°æ®åº“è®°å½•åˆ›å»º                                      â”‚     â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”‚
â”‚  â”‚ 5. âœ¨ ç«‹å³è§¦å‘è½¬ç ä»»åŠ¡ (æ ¸å¿ƒ!!!)                        â”‚     â”‚
â”‚  â”‚                                                           â”‚     â”‚
â”‚  â”‚    from app.tasks.video_transcoding import (             â”‚     â”‚
â”‚  â”‚        transcode_video_task                              â”‚     â”‚
â”‚  â”‚    )                                                      â”‚     â”‚
â”‚  â”‚                                                           â”‚     â”‚
â”‚  â”‚    # Celeryå¼‚æ­¥ä»»åŠ¡ - ä¸é˜»å¡HTTPå“åº”                    â”‚     â”‚
â”‚  â”‚    transcode_video_task.delay(                           â”‚     â”‚
â”‚  â”‚        video_id=456,                                      â”‚     â”‚
â”‚  â”‚        source_url="videos/456/original/source.mp4"       â”‚     â”‚
â”‚  â”‚    )                                                      â”‚     â”‚
â”‚  â”‚                                                           â”‚     â”‚
â”‚  â”‚    âœ“ è½¬ç ä»»åŠ¡å·²åŠ å…¥é˜Ÿåˆ—                                 â”‚     â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”‚
â”‚  â”‚ 6. æ¸…ç†ä¸´æ—¶æ–‡ä»¶                                           â”‚     â”‚
â”‚  â”‚    shutil.rmtree("/tmp/uploads/abc123")                  â”‚     â”‚
â”‚  â”‚    âœ“ ä¸´æ—¶æ–‡ä»¶å·²åˆ é™¤                                      â”‚     â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”‚
â”‚  â”‚ 7. è¿”å›HTTP 200 (è€—æ—¶: ~30ç§’)                           â”‚     â”‚
â”‚  â”‚    Response: {                                            â”‚     â”‚
â”‚  â”‚      "url": "videos/456/original/source.mp4",            â”‚     â”‚
â”‚  â”‚      "message": "ä¸Šä¼ æˆåŠŸï¼Œè½¬ç ä»»åŠ¡å·²å¯åŠ¨",              â”‚     â”‚
â”‚  â”‚      "transcoding_status": "pending"                      â”‚     â”‚
â”‚  â”‚    }                                                      â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚ 2. Celeryå¼‚æ­¥ä»»åŠ¡
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Redis ä»»åŠ¡é˜Ÿåˆ—                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  Queue: high_priority                                     â”‚     â”‚
â”‚  â”‚  â€¢ Task 1: transcode_video(video_id=456)  â† åˆšåŠ å…¥      â”‚     â”‚
â”‚  â”‚  â€¢ Task 2: transcode_video(video_id=455)  (å¤„ç†ä¸­)      â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚ 3. Workeræ‹‰å–ä»»åŠ¡
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Celery Worker #1                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  æ­£åœ¨å¤„ç†: transcode_video(video_id=456)                 â”‚     â”‚
â”‚  â”‚                                                           â”‚     â”‚
â”‚  â”‚  Step 1: ä¸‹è½½åŸå§‹è§†é¢‘ (5%)                              â”‚     â”‚
â”‚  â”‚  Step 2: åˆ†æè§†é¢‘å…ƒæ•°æ® (10%)                            â”‚     â”‚
â”‚  â”‚  Step 3: å†³å®šè½¬ç åˆ†è¾¨ç‡ (15%)                            â”‚     â”‚
â”‚  â”‚  Step 4: å¹¶è¡Œè½¬ç 5ä¸ªåˆ†è¾¨ç‡ (15-70%)                      â”‚     â”‚
â”‚  â”‚  Step 5: ç”ŸæˆHLSåˆ‡ç‰‡ (70-85%)                            â”‚     â”‚
â”‚  â”‚  Step 6: ç”Ÿæˆç¼©ç•¥å›¾ (85-95%)                             â”‚     â”‚
â”‚  â”‚  Step 7: ä¸Šä¼ åˆ°MinIO (95-99%)                            â”‚     â”‚
â”‚  â”‚  Step 8: å®Œæˆ (100%) âœ…                                  â”‚     â”‚
â”‚  â”‚                                                           â”‚     â”‚
â”‚  â”‚  é¢„è®¡å®Œæˆæ—¶é—´: 15åˆ†é’Ÿå                                  â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â”‚ åŒæ—¶ï¼Œç®¡ç†å‘˜å¯ä»¥ç»§ç»­ä¸Šä¼ ä¸‹ä¸€ä¸ªè§†é¢‘
                          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      ç®¡ç†å‘˜åå° - è½¬ç çŠ¶æ€ç›‘æ§                                     â”‚
â”‚  /admin/videos/456/transcoding                                     â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  è§†é¢‘: movie_4k.mp4                                       â”‚     â”‚
â”‚  â”‚  çŠ¶æ€: è½¬ç ä¸­                                             â”‚     â”‚
â”‚  â”‚                                                           â”‚     â”‚
â”‚  â”‚  æ€»ä½“è¿›åº¦: â–“â–“â–“â–“â–“â–“â–“â–‘â–‘â–‘â–‘â–‘ 65%                             â”‚     â”‚
â”‚  â”‚                                                           â”‚     â”‚
â”‚  â”‚  å½“å‰æ­¥éª¤: æ­£åœ¨è½¬ç 1080p                                 â”‚     â”‚
â”‚  â”‚                                                           â”‚     â”‚
â”‚  â”‚  å·²å®Œæˆ:                                                  â”‚     â”‚
â”‚  â”‚  âœ“ 2K (2560x1440) - 5.4GB                               â”‚     â”‚
â”‚  â”‚  âœ“ 720p (1280x720) - 1.1GB                              â”‚     â”‚
â”‚  â”‚  â³ 1080p (1920x1080) - å¤„ç†ä¸­...                       â”‚     â”‚
â”‚  â”‚  â¸ 480p - ç­‰å¾…ä¸­                                         â”‚     â”‚
â”‚  â”‚  â¸ 360p - ç­‰å¾…ä¸­                                         â”‚     â”‚
â”‚  â”‚                                                           â”‚     â”‚
â”‚  â”‚  é¢„è®¡å‰©ä½™æ—¶é—´: 8åˆ†é’Ÿ                                      â”‚     â”‚
â”‚  â”‚                                                           â”‚     â”‚
â”‚  â”‚  [é‡è¯•] [å–æ¶ˆ] [æŸ¥çœ‹æ—¥å¿—]                                â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ’» æ ¸å¿ƒä»£ç å®ç°

### 1. åç«¯ä¸Šä¼ å®Œæˆé’©å­

**æ–‡ä»¶**: `backend/app/admin/upload.py`

```python
from fastapi import APIRouter, Depends, HTTPException, UploadFile, File, Form
from sqlalchemy.ext.asyncio import AsyncSession
from app.database import get_db
from app.models.user import AdminUser
from app.models.video import Video
from app.models.transcoding import TranscodingTask
from app.utils.dependencies import get_current_admin_user
from app.utils.minio_client import minio_client
from app.tasks.video_transcoding import transcode_video_task  # â­ å¯¼å…¥Celeryä»»åŠ¡
import shutil
import os
import io
from datetime import datetime

router = APIRouter()

# ä¸´æ—¶å­˜å‚¨åˆ†ç‰‡ä¿¡æ¯ï¼ˆç”Ÿäº§ç¯å¢ƒåº”ä½¿ç”¨Redisï¼‰
upload_sessions = {}


@router.post("/complete-multipart")
async def complete_multipart_upload(
    upload_id: str = Form(...),
    video_id: Optional[int] = Form(None),
    upload_type: str = Form("video"),  # video, poster, backdrop
    current_admin: AdminUser = Depends(get_current_admin_user),
    db: AsyncSession = Depends(get_db),
):
    """
    å®Œæˆåˆ†ç‰‡ä¸Šä¼ å¹¶è§¦å‘è½¬ç 

    â­ æ ¸å¿ƒåŠŸèƒ½: ä¸Šä¼ å®Œæˆåç«‹å³è§¦å‘è½¬ç ä»»åŠ¡
    """
    if upload_id not in upload_sessions:
        raise HTTPException(status_code=404, detail="ä¸Šä¼ ä¼šè¯ä¸å­˜åœ¨")

    session = upload_sessions[upload_id]

    # 1. æ£€æŸ¥æ˜¯å¦æ‰€æœ‰åˆ†ç‰‡éƒ½å·²ä¸Šä¼ 
    expected_chunks = list(range(session["total_chunks"]))
    uploaded_chunks = sorted(session["uploaded_chunks"])

    if uploaded_chunks != expected_chunks:
        missing = set(expected_chunks) - set(uploaded_chunks)
        raise HTTPException(
            status_code=400,
            detail=f"ç¼ºå°‘åˆ†ç‰‡: {missing}"
        )

    # 2. åˆå¹¶åˆ†ç‰‡
    temp_dir = f"/tmp/uploads/{upload_id}"
    merged_file = io.BytesIO()

    for i in range(session["total_chunks"]):
        chunk_path = f"{temp_dir}/chunk_{i}"
        with open(chunk_path, "rb") as f:
            merged_file.write(f.read())

    merged_file.seek(0)

    # 3. ä¸Šä¼ åˆ°MinIO
    try:
        ext = session["filename"].split(".")[-1]
        timestamp = int(datetime.utcnow().timestamp())

        if upload_type == "video":
            object_name = f"videos/{video_id}/original/source.{ext}"
            url = minio_client.upload_video(
                merged_file,
                object_name,
                session["file_type"]
            )

            # âœ¨âœ¨âœ¨ 4. ç«‹å³è§¦å‘è½¬ç ä»»åŠ¡ (æ ¸å¿ƒ!!!) âœ¨âœ¨âœ¨
            # åˆ›å»ºè½¬ç ä»»åŠ¡è®°å½•
            transcoding_task = TranscodingTask(
                video_id=video_id,
                status='pending',
                progress=0,
                original_file_url=url,
                original_size=session["file_size"]
            )
            db.add(transcoding_task)
            await db.commit()
            await db.refresh(transcoding_task)

            # Celeryå¼‚æ­¥ä»»åŠ¡ - ä¸é˜»å¡HTTPå“åº”
            # delay()æ–¹æ³•ä¼šç«‹å³è¿”å›,ä»»åŠ¡åœ¨åå°æ‰§è¡Œ
            transcode_video_task.delay(
                video_id=video_id,
                source_url=url
            )

            print(f"âœ… è½¬ç ä»»åŠ¡å·²è§¦å‘: video_id={video_id}")

        elif upload_type == "poster":
            object_name = f"posters/{video_id}/poster_{timestamp}.{ext}"
            url = minio_client.upload_image(merged_file, object_name, session["file_type"])
        else:
            object_name = f"backdrops/{video_id}/backdrop_{timestamp}.{ext}"
            url = minio_client.upload_image(merged_file, object_name, session["file_type"])

        # 5. æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        shutil.rmtree(temp_dir, ignore_errors=True)

        # 6. æ¸…ç†ä¼šè¯
        del upload_sessions[upload_id]

        return {
            "url": url,
            "message": "æ–‡ä»¶ä¸Šä¼ å®Œæˆï¼Œè½¬ç ä»»åŠ¡å·²å¯åŠ¨" if upload_type == "video" else "æ–‡ä»¶ä¸Šä¼ å®Œæˆ",
            "transcoding_status": "pending" if upload_type == "video" else None
        }

    except Exception as e:
        raise HTTPException(status_code=500, detail=f"ä¸Šä¼ å¤±è´¥: {str(e)}")
```

### 2. Celeryè½¬ç ä»»åŠ¡

**æ–‡ä»¶**: `backend/app/tasks/video_transcoding.py`

```python
from celery import Celery, Task
from celery.utils.log import get_task_logger
from app.config import settings
from app.database import SessionLocal
from app.models.transcoding import TranscodingTask
from sqlalchemy import select
from datetime import datetime

logger = get_task_logger(__name__)

# Celeryé…ç½®
celery_app = Celery(
    'videosite',
    broker=f'redis://{settings.REDIS_HOST}:{settings.REDIS_PORT}/0',
    backend=f'redis://{settings.REDIS_HOST}:{settings.REDIS_PORT}/1'
)

celery_app.conf.update(
    task_serializer='json',
    accept_content=['json'],
    result_serializer='json',
    timezone='Asia/Shanghai',
    enable_utc=True,
    task_track_started=True,  # é‡è¦: è·Ÿè¸ªä»»åŠ¡å¯åŠ¨
    task_send_sent_event=True,
)


class TranscodingTaskBase(Task):
    """è½¬ç ä»»åŠ¡åŸºç±»"""

    def on_failure(self, exc, task_id, args, kwargs, einfo):
        """ä»»åŠ¡å¤±è´¥å›è°ƒ"""
        video_id = kwargs.get('video_id')
        if video_id:
            db = SessionLocal()
            try:
                result = db.execute(
                    select(TranscodingTask).filter_by(video_id=video_id)
                )
                task = result.scalar_one_or_none()
                if task:
                    task.status = 'failed'
                    task.error_message = str(exc)
                    task.retry_count += 1
                    db.commit()
            finally:
                db.close()


@celery_app.task(
    base=TranscodingTaskBase,
    bind=True,
    max_retries=3,
    autoretry_for=(Exception,),
    retry_kwargs={'max_retries': 3, 'countdown': 300}  # 5åˆ†é’Ÿåé‡è¯•
)
def transcode_video_task(self, video_id: int, source_url: str):
    """
    ä¸»è½¬ç ä»»åŠ¡

    æ­¤ä»»åŠ¡ä¼šåœ¨ä¸Šä¼ å®Œæˆåç«‹å³ç”±Celery Workeræ‰§è¡Œ

    Args:
        video_id: è§†é¢‘ID
        source_url: MinIOä¸­çš„åŸå§‹è§†é¢‘URL
    """
    db = SessionLocal()

    try:
        # 1. æ›´æ–°ä»»åŠ¡çŠ¶æ€ä¸ºprocessing
        result = db.execute(
            select(TranscodingTask).filter_by(video_id=video_id)
        )
        task = result.scalar_one_or_none()

        if not task:
            raise ValueError(f"Transcoding task not found for video {video_id}")

        task.status = 'processing'
        task.started_at = datetime.utcnow()
        task.worker_id = self.request.hostname  # è®°å½•worker ID
        db.commit()

        logger.info(f"ğŸ¬ å¼€å§‹è½¬ç è§†é¢‘ {video_id}, Worker: {self.request.hostname}")

        # 2. ä¸‹è½½åŸå§‹è§†é¢‘
        # 3. åˆ†æè§†é¢‘
        # 4. è½¬ç 
        # 5. ç”ŸæˆHLS
        # 6. ç”Ÿæˆç¼©ç•¥å›¾
        # 7. ä¸Šä¼ åˆ°MinIO
        # 8. æ›´æ–°æ•°æ®åº“
        # ... (è¯¦ç»†å®ç°è§architecture.md)

        logger.info(f"âœ… è§†é¢‘è½¬ç å®Œæˆ {video_id}")

        return {
            'status': 'success',
            'video_id': video_id
        }

    except Exception as e:
        logger.error(f"âŒ è§†é¢‘è½¬ç å¤±è´¥ {video_id}: {str(e)}")
        raise

    finally:
        db.close()
```

### 3. è½¬ç çŠ¶æ€æŸ¥è¯¢API

**æ–‡ä»¶**: `backend/app/api/videos.py`

```python
from fastapi import APIRouter, Depends
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select
from app.database import get_db
from app.models.transcoding import TranscodingTask

router = APIRouter()


@router.get("/videos/{video_id}/transcoding-status")
async def get_transcoding_status(
    video_id: int,
    db: AsyncSession = Depends(get_db)
):
    """
    æŸ¥è¯¢è§†é¢‘è½¬ç çŠ¶æ€

    å‰ç«¯å¯ä»¥è½®è¯¢æ­¤APIæ¥è·å–å®æ—¶è¿›åº¦
    """
    result = await db.execute(
        select(TranscodingTask).filter_by(video_id=video_id)
    )
    task = result.scalar_one_or_none()

    if not task:
        return {
            "status": "not_found",
            "message": "è½¬ç ä»»åŠ¡ä¸å­˜åœ¨"
        }

    return {
        "status": task.status,  # pending, processing, completed, failed
        "progress": task.progress,  # 0-100
        "current_step": task.current_step,  # "è½¬ç 1080p", "ç”ŸæˆHLS"ç­‰
        "resolutions": task.resolutions,  # å·²å®Œæˆçš„åˆ†è¾¨ç‡
        "error_message": task.error_message if task.status == 'failed' else None,
        "started_at": task.started_at,
        "completed_at": task.completed_at,
        "estimated_time_remaining": calculate_eta(task)  # é¢„è®¡å‰©ä½™æ—¶é—´
    }


def calculate_eta(task: TranscodingTask) -> Optional[int]:
    """è®¡ç®—é¢„è®¡å‰©ä½™æ—¶é—´(ç§’)"""
    if task.status != 'processing' or not task.started_at:
        return None

    elapsed = (datetime.utcnow() - task.started_at).total_seconds()
    if task.progress == 0:
        return None

    # ç®€å•çº¿æ€§ä¼°ç®—
    total_estimated = elapsed / (task.progress / 100)
    remaining = total_estimated - elapsed
    return int(remaining)
```

### 4. å‰ç«¯å®æ—¶è¿›åº¦ç›‘æ§

**æ–‡ä»¶**: `admin-frontend/src/pages/Videos/TranscodingStatus.tsx`

```typescript
import React, { useState, useEffect } from 'react'
import { Progress, Card, Descriptions, Tag, Button } from 'antd'
import { CheckCircleOutlined, SyncOutlined, CloseCircleOutlined } from '@ant-design/icons'
import axios from 'axios'

interface TranscodingStatusProps {
  videoId: number
}

const TranscodingStatus: React.FC<TranscodingStatusProps> = ({ videoId }) => {
  const [status, setStatus] = useState<any>(null)
  const [loading, setLoading] = useState(true)

  // è½®è¯¢è·å–è½¬ç çŠ¶æ€
  useEffect(() => {
    const fetchStatus = async () => {
      try {
        const response = await axios.get(`/api/v1/videos/${videoId}/transcoding-status`)
        setStatus(response.data)
        setLoading(false)

        // å¦‚æœstill processing, ç»§ç»­è½®è¯¢
        if (response.data.status === 'processing' || response.data.status === 'pending') {
          setTimeout(fetchStatus, 2000) // æ¯2ç§’è½®è¯¢ä¸€æ¬¡
        }
      } catch (error) {
        console.error('è·å–è½¬ç çŠ¶æ€å¤±è´¥:', error)
        setLoading(false)
      }
    }

    fetchStatus()
  }, [videoId])

  if (loading) {
    return <div>åŠ è½½ä¸­...</div>
  }

  if (!status) {
    return <div>æœªæ‰¾åˆ°è½¬ç ä»»åŠ¡</div>
  }

  const getStatusTag = () => {
    switch (status.status) {
      case 'pending':
        return <Tag icon={<SyncOutlined spin />} color="processing">æ’é˜Ÿä¸­</Tag>
      case 'processing':
        return <Tag icon={<SyncOutlined spin />} color="processing">è½¬ç ä¸­</Tag>
      case 'completed':
        return <Tag icon={<CheckCircleOutlined />} color="success">å·²å®Œæˆ</Tag>
      case 'failed':
        return <Tag icon={<CloseCircleOutlined />} color="error">å¤±è´¥</Tag>
      default:
        return <Tag>{status.status}</Tag>
    }
  }

  return (
    <Card title="è½¬ç çŠ¶æ€" extra={getStatusTag()}>
      <Progress
        percent={status.progress}
        status={status.status === 'failed' ? 'exception' : status.status === 'completed' ? 'success' : 'active'}
        strokeWidth={15}
      />

      <Descriptions column={2} style={{ marginTop: 20 }}>
        <Descriptions.Item label="å½“å‰æ­¥éª¤">{status.current_step || '-'}</Descriptions.Item>
        <Descriptions.Item label="é¢„è®¡å‰©ä½™">
          {status.estimated_time_remaining ? `${Math.round(status.estimated_time_remaining / 60)}åˆ†é’Ÿ` : '-'}
        </Descriptions.Item>
        <Descriptions.Item label="å·²å®Œæˆåˆ†è¾¨ç‡">
          {Object.keys(status.resolutions || {}).join(', ') || 'æ— '}
        </Descriptions.Item>
      </Descriptions>

      {status.status === 'failed' && (
        <div style={{ marginTop: 20, color: 'red' }}>
          é”™è¯¯ä¿¡æ¯: {status.error_message}
          <Button type="link" onClick={() => retryTranscoding(videoId)}>
            é‡è¯•
          </Button>
        </div>
      )}
    </Card>
  )
}

async function retryTranscoding(videoId: number) {
  try {
    await axios.post(`/api/v1/admin/transcoding/${videoId}/retry`)
    message.success('è½¬ç ä»»åŠ¡å·²é‡æ–°æäº¤')
    window.location.reload()
  } catch (error) {
    message.error('é‡è¯•å¤±è´¥')
  }
}

export default TranscodingStatus
```

---

## ğŸ“Š å·¥ä½œæµæ—¶åºå›¾

```
æ—¶é—´è½´ | ç®¡ç†å‘˜æ“ä½œ                | åç«¯å¤„ç†                    | Workerå¤„ç†
â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
00:00  â”‚ é€‰æ‹©4Kè§†é¢‘ (3GB)         â”‚                            â”‚
00:00  â”‚ ç‚¹å‡»ä¸Šä¼                   â”‚                            â”‚
00:00  â”‚ â†“                        â”‚ æ¥æ”¶initè¯·æ±‚               â”‚
00:00  â”‚ å¼€å§‹ä¸Šä¼ åˆ†ç‰‡ (5MB/ç‰‡)    â”‚ åˆ›å»ºupload_id              â”‚
00:01  â”‚ ä¸Šä¼ è¿›åº¦: 10%            â”‚ ä¿å­˜chunk_0-60             â”‚
00:02  â”‚ ä¸Šä¼ è¿›åº¦: 20%            â”‚ ä¿å­˜chunk_61-120           â”‚
00:05  â”‚ ä¸Šä¼ è¿›åº¦: 50%            â”‚ ä¿å­˜chunk_121-300          â”‚
00:08  â”‚ ä¸Šä¼ è¿›åº¦: 80%            â”‚ ä¿å­˜chunk_301-480          â”‚
00:10  â”‚ ä¸Šä¼ è¿›åº¦: 100% âœ…        â”‚ ä¿å­˜chunk_481-600 (å®Œæˆ)  â”‚
00:10  â”‚ â†“                        â”‚ â†“                          â”‚
00:10  â”‚ è§¦å‘complete_multipart   â”‚ åˆå¹¶600ä¸ªåˆ†ç‰‡ (30ç§’)       â”‚
00:10  â”‚                          â”‚ ä¸Šä¼ åˆ°MinIO (å®Œæ•´3GB)       â”‚
00:10  â”‚                          â”‚ åˆ›å»ºæ•°æ®åº“è®°å½•              â”‚
00:10  â”‚                          â”‚ âœ¨ è§¦å‘Celeryä»»åŠ¡          â”‚
00:10  â”‚                          â”‚ è¿”å›HTTP 200 âœ…            â”‚
00:10  â”‚ æ”¶åˆ°æˆåŠŸå“åº”              â”‚                            â”‚
00:10  â”‚ "ä¸Šä¼ æˆåŠŸ,è½¬ç ä¸­..."     â”‚                            â”‚
00:10  â”‚                          â”‚                            â”‚ Workeræ‹‰å–ä»»åŠ¡ âš¡
00:11  â”‚ ç®¡ç†å‘˜ç»§ç»­ä¸Šä¼ ä¸‹ä¸€ä¸ª      â”‚                            â”‚ ä¸‹è½½åŸå§‹è§†é¢‘ (5%)
00:12  â”‚ (å¯ä»¥å¹¶è¡Œæ“ä½œ!)          â”‚                            â”‚ åˆ†æè§†é¢‘ (10%)
00:13  â”‚                          â”‚                            â”‚ å†³å®šåˆ†è¾¨ç‡ (15%)
00:15  â”‚                          â”‚                            â”‚ å¹¶è¡Œè½¬ç  (15-70%)
00:20  â”‚                          â”‚                            â”‚ â”œâ”€ 2K (å¤„ç†ä¸­)
00:20  â”‚                          â”‚                            â”‚ â”œâ”€ 1080p (å¤„ç†ä¸­)
00:20  â”‚                          â”‚                            â”‚ â”œâ”€ 720p (å®Œæˆâœ…)
00:20  â”‚                          â”‚                            â”‚ â”œâ”€ 480p (å®Œæˆâœ…)
00:20  â”‚                          â”‚                            â”‚ â””â”€ 360p (å®Œæˆâœ…)
00:23  â”‚                          â”‚                            â”‚ æ‰€æœ‰åˆ†è¾¨ç‡å®Œæˆ âœ…
00:24  â”‚                          â”‚                            â”‚ ç”ŸæˆHLS (70-85%)
00:25  â”‚                          â”‚                            â”‚ ç”Ÿæˆç¼©ç•¥å›¾ (85-95%)
00:26  â”‚                          â”‚                            â”‚ ä¸Šä¼ åˆ°MinIO (95-99%)
00:27  â”‚                          â”‚                            â”‚ æ›´æ–°æ•°æ®åº“ (100%)
00:27  â”‚                          â”‚                            â”‚ è½¬ç å®Œæˆ âœ…âœ…âœ…
00:27  â”‚ æŸ¥çœ‹è½¬ç çŠ¶æ€              â”‚ è¿”å›completedçŠ¶æ€          â”‚
00:27  â”‚ âœ… è½¬ç å®Œæˆ               â”‚                            â”‚
```

**æ€»ç»“**:
- ä¸Šä¼ è€—æ—¶: 10åˆ†é’Ÿ
- è½¬ç è€—æ—¶: 17åˆ†é’Ÿ (å¹¶è¡Œ,åœ¨åå°è¿›è¡Œ)
- ç®¡ç†å‘˜ç­‰å¾…: 0åˆ†é’Ÿ (ä¸Šä¼ å®Œæˆå³å¯ç»§ç»­å…¶ä»–æ“ä½œ)
- **æ•ˆç‡æå‡**: ä»40åˆ†é’Ÿä¸²è¡Œ â†’ 10åˆ†é’Ÿ + è‡ªåŠ¨åŒ–

---

## ğŸ¯ æœ€ä½³å®è·µ

### 1. ä½¿ç”¨WebSocketæ›¿ä»£è½®è¯¢ (ä¼˜åŒ–)

```typescript
// frontend: ä½¿ç”¨WebSocketè·å–å®æ—¶è¿›åº¦
const ws = new WebSocket(`ws://localhost:8000/ws/transcoding/${videoId}`)

ws.onmessage = (event) => {
  const data = JSON.parse(event.data)
  setProgress(data.progress)
  setCurrentStep(data.current_step)
}
```

### 2. æ–­ç‚¹ç»­ä¼ æ”¯æŒ

å¦‚æœä¸Šä¼ ä¸­æ–­,å¯ä»¥ä»ä¸Šæ¬¡çš„chunkç»§ç»­:

```typescript
// å‰ç«¯æ£€æŸ¥å·²ä¸Šä¼ çš„chunks
const statusResponse = await axios.get(`/api/v1/admin/upload/upload-status/${uploadId}`)
const missingChunks = statusResponse.data.missing_chunks

// åªä¸Šä¼ ç¼ºå¤±çš„chunks
for (const chunkIndex of missingChunks) {
  await uploadChunk(chunkIndex)
}
```

### 3. ä»»åŠ¡ä¼˜å…ˆçº§

4Kè§†é¢‘ä¼˜å…ˆè½¬ç :

```python
# æ ¹æ®åˆ†è¾¨ç‡è®¾ç½®ä¸åŒé˜Ÿåˆ—
if source_height >= 2160:  # 4K
    transcode_video_task.apply_async(
        args=[video_id, source_url],
        queue='high_priority',
        priority=10
    )
else:
    transcode_video_task.apply_async(
        args=[video_id, source_url],
        queue='normal',
        priority=5
    )
```

---

## ğŸ”§ ç›‘æ§å’Œè°ƒè¯•

### ä½¿ç”¨Flowerç›‘æ§Celery

```bash
# å¯åŠ¨Flower
celery -A app.tasks.transcoding flower --port=5555

# è®¿é—®: http://localhost:5555
# å¯ä»¥çœ‹åˆ°:
# - æ´»è·ƒçš„ä»»åŠ¡
# - å®Œæˆçš„ä»»åŠ¡
# - å¤±è´¥çš„ä»»åŠ¡
# - WorkerçŠ¶æ€
# - ä»»åŠ¡è¯¦ç»†æ—¥å¿—
```

### æ—¥å¿—è®°å½•

```python
import logging

logger = logging.getLogger(__name__)

# åœ¨è½¬ç è¿‡ç¨‹ä¸­è®°å½•è¯¦ç»†æ—¥å¿—
logger.info(f"è§†é¢‘ {video_id} è½¬ç å¼€å§‹")
logger.info(f"æºåˆ†è¾¨ç‡: {source_height}p, æ—¶é•¿: {duration}s")
logger.info(f"ç›®æ ‡åˆ†è¾¨ç‡: {target_resolutions}")
logger.info(f"è½¬ç å®Œæˆ, è€—æ—¶: {elapsed_time}s")
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0.0
**åˆ›å»ºæ—¶é—´**: 2025-10-10
**ä½œè€…**: Claude AI
