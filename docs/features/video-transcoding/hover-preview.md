# è§†é¢‘æ‚¬åœé¢„è§ˆåŠŸèƒ½

> **YouTube/Netflixé£æ ¼çš„é¼ æ ‡æ‚¬åœåŠ¨æ€é¢„è§ˆ** - æå‡ç”¨æˆ·è§†é¢‘æµè§ˆä½“éªŒ

---

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

å½“ç”¨æˆ·åœ¨è§†é¢‘åˆ—è¡¨é¡µé¢å°†é¼ æ ‡æ‚¬åœåœ¨è§†é¢‘å¡ç‰‡ä¸Šæ—¶,è‡ªåŠ¨æ’­æ”¾è¯¥è§†é¢‘çš„åŠ¨æ€é¢„è§ˆç‰‡æ®µ,ç±»ä¼¼YouTubeå’ŒNetflixçš„ä½“éªŒã€‚

###  æ•ˆæœæ¼”ç¤º

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [é™æ€å°é¢å›¾]                    â”‚  é¼ æ ‡ç§»å¼€
â”‚  è§†é¢‘æ ‡é¢˜                         â”‚  â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚  è§‚çœ‹æ¬¡æ•° â€¢ å‘å¸ƒæ—¶é—´               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â”‚ é¼ æ ‡æ‚¬åœ 500ms
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [ğŸ¬ åŠ¨æ€é¢„è§ˆè§†é¢‘æ’­æ”¾ä¸­...]       â”‚  é¼ æ ‡æ‚¬åœ
â”‚  è§†é¢‘æ ‡é¢˜                         â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
â”‚  è§‚çœ‹æ¬¡æ•° â€¢ å‘å¸ƒæ—¶é—´               â”‚
â”‚  [è¿›åº¦æ¡: â–“â–“â–“â–‘â–‘â–‘ 40%]            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒç‰¹æ€§

- âœ… **è‡ªåŠ¨æ’­æ”¾**: é¼ æ ‡æ‚¬åœ500msåè‡ªåŠ¨æ’­æ”¾é¢„è§ˆ
- âœ… **æµç•…è¿‡æ¸¡**: å°é¢å›¾åˆ°é¢„è§ˆè§†é¢‘æ— ç¼åˆ‡æ¢
- âœ… **æ‡’åŠ è½½**: ä»…åœ¨éœ€è¦æ—¶åŠ è½½é¢„è§ˆè§†é¢‘
- âœ… **æ€§èƒ½ä¼˜åŒ–**: ä½ç ç‡é¢„è§ˆ (480p, 500kbps)
- âœ… **ç²¾åç‰‡æ®µ**: 10ç§’æœ€ç²¾å½©ç‰‡æ®µæˆ–æ™ºèƒ½æˆªå–
- âœ… **é™éŸ³æ’­æ”¾**: é»˜è®¤é™éŸ³,hoveræ’­æ”¾ä¸å¹²æ‰°ç”¨æˆ·
- âœ… **ç§»åŠ¨ç«¯é€‚é…**: ç§»åŠ¨ç«¯ç‚¹å‡»é¢„è§ˆ,PCç«¯hoveré¢„è§ˆ

---

## ğŸ¯ æŠ€æœ¯æ–¹æ¡ˆ

### æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | ä¼˜ç‚¹ | ç¼ºç‚¹ | æ¨è |
|------|------|------|------|
| **A. é¢„è§ˆè§†é¢‘ç‰‡æ®µ** | æµç•…è¿è´¯ | å­˜å‚¨å¢åŠ  | â­â­â­â­â­ æ¨è |
| B. ç¼©ç•¥å›¾åºåˆ— | å­˜å‚¨å°‘ | ä¸å¤Ÿæµç•… | â­â­â­ |
| C. GIFåŠ¨å›¾ | å…¼å®¹æ€§å¥½ | æ–‡ä»¶å¤§,ç”»è´¨å·® | â­â­ |

**é€‰æ‹©æ–¹æ¡ˆA**: ç”Ÿæˆ10ç§’é¢„è§ˆè§†é¢‘ç‰‡æ®µ

---

## ğŸ”§ æŠ€æœ¯å®ç°

### 1. åç«¯ - é¢„è§ˆè§†é¢‘ç”Ÿæˆ

#### 1.1 åœ¨è½¬ç ä»»åŠ¡ä¸­ç”Ÿæˆé¢„è§ˆ

**æ–‡ä»¶**: `backend/app/tasks/video_transcoding.py`

```python
def generate_hover_preview(
    input_path: Path,
    output_dir: Path,
    duration: float
) -> Path:
    """
    ç”Ÿæˆ10ç§’æ‚¬åœé¢„è§ˆè§†é¢‘

    Args:
        input_path: åŸå§‹è§†é¢‘è·¯å¾„
        duration: è§†é¢‘æ€»æ—¶é•¿(ç§’)

    Returns:
        é¢„è§ˆè§†é¢‘è·¯å¾„
    """
    output_dir.mkdir(parents=True, exist_ok=True)
    preview_path = output_dir / 'hover_preview.webm'

    # ğŸ¯ ç­–ç•¥1: ä»è§†é¢‘ä¸­é—´æˆªå–10ç§’ç²¾åç‰‡æ®µ
    # è·³è¿‡å‰10%å’Œå10%,ä»ä¸­é—´å¼€å§‹
    start_time = max(10, duration * 0.1)
    preview_duration = min(10, duration * 0.3)  # æœ€å¤š10ç§’æˆ–30%æ—¶é•¿

    cmd = [
        'ffmpeg',
        '-ss', str(start_time),  # ä»start_timeå¼€å§‹
        '-i', str(input_path),
        '-t', str(preview_duration),  # æˆªå–preview_durationç§’

        # è§†é¢‘ç¼–ç  - ä½ç ç‡ä¼˜åŒ–
        '-c:v', 'libvpx-vp9',  # VP9ç¼–ç (WebMå®¹å™¨)
        '-vf', 'scale=854:480',  # 480påˆ†è¾¨ç‡
        '-b:v', '500k',  # 500kbpsç ç‡
        '-maxrate', '600k',
        '-bufsize', '1000k',
        '-deadline', 'realtime',  # å¿«é€Ÿç¼–ç 

        # éŸ³é¢‘ - ä½ç ç‡æˆ–ç¦ç”¨
        '-an',  # ç¦ç”¨éŸ³é¢‘(æ‚¬åœé¢„è§ˆé€šå¸¸é™éŸ³)

        # å…¶ä»–ä¼˜åŒ–
        '-threads', '4',
        '-tile-columns', '2',  # VP9ä¼˜åŒ–
        '-frame-parallel', '1',
        '-auto-alt-ref', '1',
        '-lag-in-frames', '25',

        '-y',
        str(preview_path)
    ]

    logger.info(f"Generating hover preview: {' '.join(cmd)}")

    result = subprocess.run(cmd, capture_output=True, text=True)
    if result.returncode != 0:
        logger.warning(f"Hover preview generation failed: {result.stderr}")
        # ä¸æ˜¯è‡´å‘½é”™è¯¯,ç»§ç»­è½¬ç æµç¨‹
        return None

    logger.info(f"Hover preview generated: {preview_path} ({preview_path.stat().st_size} bytes)")
    return preview_path
```

#### 1.2 é›†æˆåˆ°è½¬ç æµç¨‹

```python
@celery_app.task(base=TranscodingTaskBase, bind=True, max_retries=3)
def transcode_video(self, video_id: int):
    """ä¸»è½¬ç ä»»åŠ¡"""
    # ... ç°æœ‰è½¬ç é€»è¾‘ ...

    # 9. ç”Ÿæˆç¼©ç•¥å›¾
    task.current_step = 'generating_thumbnails'
    task.progress = 90
    db.commit()

    thumbnails = generate_thumbnails(
        input_path=original_path,
        output_dir=temp_dir / 'thumbnails',
        duration=video_info['duration']
    )

    # âœ¨ 10. ç”Ÿæˆæ‚¬åœé¢„è§ˆè§†é¢‘ (æ–°å¢)
    task.current_step = 'generating_hover_preview'
    task.progress = 95
    db.commit()

    preview_path = generate_hover_preview(
        input_path=original_path,
        output_dir=temp_dir / 'preview',
        duration=video_info['duration']
    )

    # ä¸Šä¼ é¢„è§ˆè§†é¢‘åˆ°MinIO
    preview_url = None
    if preview_path and preview_path.exists():
        preview_url = minio_client.upload_file(
            bucket=settings.MINIO_BUCKET,
            object_name=f"videos/{video_id}/preview/hover.webm",
            file_path=str(preview_path),
            content_type='video/webm'
        )
        logger.info(f"Preview uploaded: {preview_url}")

    # ... æ›´æ–°æ•°æ®åº“ ...
    video.hover_preview_url = preview_url  # æ–°å­—æ®µ
    task.preview_url = preview_url
    db.commit()
```

### 2. æ•°æ®åº“æ‰©å±•

**æ‰©å±• `videos` è¡¨**:

```sql
ALTER TABLE videos
ADD COLUMN hover_preview_url TEXT,
ADD COLUMN preview_generated_at TIMESTAMP WITH TIME ZONE;

-- ç´¢å¼•
CREATE INDEX idx_videos_preview_url ON videos(hover_preview_url);

-- æ³¨é‡Š
COMMENT ON COLUMN videos.hover_preview_url IS 'æ‚¬åœé¢„è§ˆè§†é¢‘URL (10ç§’WebMç‰‡æ®µ)';
```

**æ‰©å±• `transcoding_tasks` è¡¨**:

```sql
ALTER TABLE transcoding_tasks
ADD COLUMN preview_url TEXT,
ADD COLUMN preview_size_bytes BIGINT;

COMMENT ON COLUMN transcoding_tasks.preview_url IS 'æ‚¬åœé¢„è§ˆè§†é¢‘URL';
```

### 3. åç«¯API

**æ–‡ä»¶**: `backend/app/api/videos.py`

```python
from app.schemas.video import VideoListResponse

@router.get("/videos", response_model=PaginatedResponse)
async def list_videos(
    page: int = Query(1, ge=1),
    page_size: int = Query(20, ge=1, le=100),
    db: AsyncSession = Depends(get_db)
):
    """è·å–è§†é¢‘åˆ—è¡¨ (å«é¢„è§ˆURL)"""

    # ... æŸ¥è¯¢é€»è¾‘ ...

    # è¿”å›æ•°æ®åŒ…å«hover_preview_url
    return {
        "total": total,
        "page": page,
        "page_size": page_size,
        "items": [{
            "id": video.id,
            "title": video.title,
            "poster_url": video.poster_url,
            "hover_preview_url": video.hover_preview_url,  # âœ¨ æ–°å¢å­—æ®µ
            # ... å…¶ä»–å­—æ®µ ...
        } for video in videos]
    }
```

### 4. å‰ç«¯å®ç°

#### 4.1 VideoCardç»„ä»¶å‡çº§

**æ–‡ä»¶**: `frontend/src/components/VideoCard/VideoCardWithPreview.tsx`

```typescript
import React, { useState, useRef, useEffect } from 'react'
import { Link } from 'react-router-dom'
import { Video } from '@/types'

interface VideoCardWithPreviewProps {
  video: Video
}

const VideoCardWithPreview: React.FC<VideoCardWithPreviewProps> = ({ video }) => {
  const [showPreview, setShowPreview] = useState(false)
  const [previewLoaded, setPreviewLoaded] = useState(false)
  const videoRef = useRef<HTMLVideoElement>(null)
  const hoverTimerRef = useRef<NodeJS.Timeout | null>(null)

  // é¼ æ ‡è¿›å…¥ - å»¶è¿Ÿ500msåæ˜¾ç¤ºé¢„è§ˆ
  const handleMouseEnter = () => {
    if (!video.hover_preview_url) return

    hoverTimerRef.current = setTimeout(() => {
      setShowPreview(true)
    }, 500) // 500mså»¶è¿Ÿ,é¿å…è¯¯è§¦
  }

  // é¼ æ ‡ç¦»å¼€ - ç«‹å³éšè—é¢„è§ˆ
  const handleMouseLeave = () => {
    if (hoverTimerRef.current) {
      clearTimeout(hoverTimerRef.current)
      hoverTimerRef.current = null
    }
    setShowPreview(false)
    setPreviewLoaded(false)
  }

  // é¢„è§ˆè§†é¢‘åŠ è½½å®Œæˆåè‡ªåŠ¨æ’­æ”¾
  useEffect(() => {
    if (showPreview && videoRef.current) {
      videoRef.current.play().catch(err => {
        console.warn('Preview autoplay failed:', err)
      })
    }
  }, [showPreview])

  // æ¸…ç†å®šæ—¶å™¨
  useEffect(() => {
    return () => {
      if (hoverTimerRef.current) {
        clearTimeout(hoverTimerRef.current)
      }
    }
  }, [])

  return (
    <Link to={`/video/${video.id}`}>
      <div
        className="relative overflow-hidden rounded-lg bg-gray-900 cursor-pointer group"
        onMouseEnter={handleMouseEnter}
        onMouseLeave={handleMouseLeave}
      >
        {/* å°é¢å›¾ */}
        <div className={`relative aspect-video ${showPreview ? 'opacity-0' : 'opacity-100'} transition-opacity duration-300`}>
          <img
            src={video.poster_url}
            alt={video.title}
            className="w-full h-full object-cover"
            loading="lazy"
          />

          {/* æ’­æ”¾æŒ‰é’®å åŠ å±‚ */}
          <div className="absolute inset-0 flex items-center justify-center bg-black bg-opacity-0 group-hover:bg-opacity-30 transition-all">
            <div className="w-16 h-16 rounded-full bg-white bg-opacity-80 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
              <svg className="w-8 h-8 text-black ml-1" fill="currentColor" viewBox="0 0 20 20">
                <path d="M6 4l10 6-10 6V4z"/>
              </svg>
            </div>
          </div>
        </div>

        {/* âœ¨ æ‚¬åœé¢„è§ˆè§†é¢‘ */}
        {video.hover_preview_url && showPreview && (
          <div className="absolute inset-0">
            <video
              ref={videoRef}
              src={video.hover_preview_url}
              className="w-full h-full object-cover"
              muted  // é™éŸ³æ’­æ”¾
              loop  // å¾ªç¯æ’­æ”¾
              playsInline  // iOSå†…è”æ’­æ”¾
              onLoadedData={() => setPreviewLoaded(true)}
              onError={(e) => {
                console.error('Preview video error:', e)
                setShowPreview(false)
              }}
            />

            {/* åŠ è½½æŒ‡ç¤ºå™¨ */}
            {!previewLoaded && (
              <div className="absolute inset-0 flex items-center justify-center bg-black bg-opacity-50">
                <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-white"></div>
              </div>
            )}

            {/* é¢„è§ˆæ ‡ç­¾ */}
            <div className="absolute top-2 left-2 bg-black bg-opacity-70 text-white text-xs px-2 py-1 rounded">
              é¢„è§ˆä¸­
            </div>
          </div>
        )}

        {/* è§†é¢‘ä¿¡æ¯ */}
        <div className="p-4">
          <h3 className="text-lg font-semibold text-white line-clamp-2 mb-2">
            {video.title}
          </h3>
          <div className="flex items-center text-sm text-gray-400">
            <span>{video.view_count?.toLocaleString()} æ¬¡è§‚çœ‹</span>
            <span className="mx-2">â€¢</span>
            <span>{new Date(video.created_at).toLocaleDateString()}</span>
          </div>
        </div>
      </div>
    </Link>
  )
}

export default VideoCardWithPreview
```

#### 4.2 ç§»åŠ¨ç«¯é€‚é…

```typescript
// æ£€æµ‹è®¾å¤‡ç±»å‹
const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)

// ç§»åŠ¨ç«¯ä½¿ç”¨ç‚¹å‡»è§¦å‘,PCç«¯ä½¿ç”¨hover
const triggerEvent = isMobile ? 'onClick' : 'onMouseEnter'

<div
  {...(isMobile ? {
    onClick: handleClick  // ç§»åŠ¨ç«¯ç‚¹å‡»æ’­æ”¾
  } : {
    onMouseEnter: handleMouseEnter,  // PCç«¯hoveræ’­æ”¾
    onMouseLeave: handleMouseLeave
  })}
>
  {/* VideoCardå†…å®¹ */}
</div>
```

#### 4.3 æ€§èƒ½ä¼˜åŒ–

```typescript
// 1. ä½¿ç”¨Intersection Observeræ‡’åŠ è½½
const [isVisible, setIsVisible] = useState(false)
const cardRef = useRef<HTMLDivElement>(null)

useEffect(() => {
  const observer = new IntersectionObserver(
    ([entry]) => {
      if (entry.isIntersecting) {
        setIsVisible(true)
        observer.disconnect()
      }
    },
    { rootMargin: '50px' }  // æå‰50pxåŠ è½½
  )

  if (cardRef.current) {
    observer.observe(cardRef.current)
  }

  return () => observer.disconnect()
}, [])

// 2. é¢„åŠ è½½ä¼˜åŒ–
{isVisible && video.hover_preview_url && (
  <link rel="preload" as="video" href={video.hover_preview_url} />
)}

// 3. èŠ‚æµé˜²æŠ–
import { useDebounce } from '@/hooks/useDebounce'

const debouncedShowPreview = useDebounce(showPreview, 100)
```

---

## ğŸ“Š æ€§èƒ½åˆ†æ

### é¢„è§ˆè§†é¢‘æ–‡ä»¶å¤§å°

| æ—¶é•¿ | åˆ†è¾¨ç‡ | ç ç‡ | ç¼–ç  | æ–‡ä»¶å¤§å° | åŠ è½½æ—¶é—´(4G) |
|------|--------|------|------|----------|--------------|
| 10ç§’ | 480p | 500kbps | VP9 | ~625KB | <1ç§’ |
| 10ç§’ | 720p | 1Mbps | VP9 | ~1.25MB | 1-2ç§’ |
| 5ç§’ | 480p | 500kbps | VP9 | ~312KB | <0.5ç§’ |

**æ¨è**: 10ç§’ 480p VP9ç¼–ç ,æ–‡ä»¶çº¦600KB

### å¸¦å®½æ¶ˆè€—ä¼°ç®—

å‡è®¾æ¯ä¸ªç”¨æˆ·æµè§ˆ20ä¸ªè§†é¢‘å¡ç‰‡,hover 3ä¸ª:

- æ¯ç”¨æˆ·æµé‡: 600KB Ã— 3 = 1.8MB
- 1000ç”¨æˆ·/å¤©: 1.8GB
- 30,000ç”¨æˆ·/æœˆ: 54GB
- **æœˆæˆæœ¬** (CDN Â¥0.2/GB): ~Â¥11

### å­˜å‚¨æˆæœ¬

- æ¯è§†é¢‘é¢„è§ˆ: ~600KB
- 10,000ä¸ªè§†é¢‘: 6GB
- **å­˜å‚¨æˆæœ¬** (Â¥0.1/GB/æœˆ): ~Â¥0.6/æœˆ

**ç»“è®º**: æˆæœ¬å¯æ§,ç”¨æˆ·ä½“éªŒæå‡æ˜¾è‘— âœ…

---

## ğŸ¨ ç”¨æˆ·ä½“éªŒä¼˜åŒ–

### 1. æ¸è¿›å¼åŠ è½½

```typescript
// ä¼˜å…ˆæ˜¾ç¤ºå°é¢å›¾,åå°åŠ è½½é¢„è§ˆè§†é¢‘
const [previewReady, setPreviewReady] = useState(false)

useEffect(() => {
  if (video.hover_preview_url && isVisible) {
    // åå°é¢„åŠ è½½
    const video = document.createElement('video')
    video.src = video.hover_preview_url
    video.load()
    video.addEventListener('canplaythrough', () => {
      setPreviewReady(true)
    })
  }
}, [video.hover_preview_url, isVisible])
```

### 2. è§†è§‰åé¦ˆ

```typescript
// åŠ è½½è¿‡ç¨‹æ˜¾ç¤ºè¿›åº¦
<div className="absolute bottom-0 left-0 right-0 h-1 bg-gray-700">
  <div
    className="h-full bg-blue-500 transition-all duration-300"
    style={{ width: `${loadProgress}%` }}
  />
</div>
```

### 3. é”™è¯¯é™çº§

```typescript
const [previewError, setPreviewError] = useState(false)

// é¢„è§ˆå¤±è´¥æ—¶å›é€€åˆ°å°é¢å›¾
if (previewError) {
  return <img src={video.poster_url} alt={video.title} />
}
```

---

## ğŸ§ª æµ‹è¯•æ¸…å•

- [ ] é¢„è§ˆè§†é¢‘æ­£ç¡®ç”Ÿæˆ (10ç§’, 480p, VP9)
- [ ] æ•°æ®åº“å­—æ®µæ­£ç¡®ä¿å­˜
- [ ] APIè¿”å›hover_preview_urlå­—æ®µ
- [ ] é¼ æ ‡hoverè§¦å‘é¢„è§ˆæ’­æ”¾
- [ ] é¼ æ ‡ç¦»å¼€åœæ­¢é¢„è§ˆ
- [ ] ç§»åŠ¨ç«¯ç‚¹å‡»è§¦å‘é¢„è§ˆ
- [ ] é¢„è§ˆè§†é¢‘å¾ªç¯æ’­æ”¾
- [ ] é™éŸ³æ’­æ”¾
- [ ] æ‡’åŠ è½½æ­£å¸¸å·¥ä½œ
- [ ] é¢„è§ˆå¤±è´¥æ—¶ä¼˜é›…é™çº§
- [ ] æ€§èƒ½ç›‘æ§æ— å¼‚å¸¸
- [ ] å¤šæµè§ˆå™¨å…¼å®¹æ€§æµ‹è¯•

---

## ğŸ“š å‚è€ƒèµ„æ–™

- [YouTube Engineering Blog - Video Previews](https://blog.youtube/engineering/)
- [Netflix TechBlog - Hover Previews](https://netflixtechblog.com/)
- [WebM VP9 Encoding Guide](https://trac.ffmpeg.org/wiki/Encode/VP9)
- [MDN - HTMLVideoElement](https://developer.mozilla.org/en-US/docs/Web/API/HTMLVideoElement)

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0.0
**åˆ›å»ºæ—¶é—´**: 2025-10-09
**æœ€åæ›´æ–°**: 2025-10-09
**ä½œè€…**: Claude AI
