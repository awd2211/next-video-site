# dav1d AV1è§£ç æ–¹æ¡ˆå®æ–½æŒ‡å—

> **VideoSiteé‡‡ç”¨dav1dä½œä¸ºAV1è§£ç å™¨** - ä¸–ç•Œæœ€å¿«ã€å®Œå…¨å…è´¹ã€56%å‹ç¼©ç‡æå‡

## ğŸ“‹ ç›®å½•

- [ä¸ºä»€ä¹ˆé€‰æ‹©dav1d](#ä¸ºä»€ä¹ˆé€‰æ‹©dav1d)
- [æŠ€æœ¯æ¶æ„](#æŠ€æœ¯æ¶æ„)
- [åç«¯é›†æˆ](#åç«¯é›†æˆ)
- [å‰ç«¯é›†æˆ](#å‰ç«¯é›†æˆ)
- [è½¬ç å·¥ä½œæµ](#è½¬ç å·¥ä½œæµ)
- [æ€§èƒ½ä¼˜åŒ–](#æ€§èƒ½ä¼˜åŒ–)
- [éƒ¨ç½²æŒ‡å—](#éƒ¨ç½²æŒ‡å—)
- [æˆæœ¬æ”¶ç›Šåˆ†æ](#æˆæœ¬æ”¶ç›Šåˆ†æ)

## ä¸ºä»€ä¹ˆé€‰æ‹©dav1d

### æ ¸å¿ƒä¼˜åŠ¿

| ä¼˜åŠ¿ | æ•°æ® | è¯´æ˜ |
|------|------|------|
| **ä¸–ç•Œæœ€å¿«** | æ¯”libaomå¿«**11å€** | 4K AV1: dav1d 25fps vs libaom 8fps |
| **å‹ç¼©ç‡æœ€é«˜** | æ¯”H.264èŠ‚çœ**56%** | ç›¸åŒè´¨é‡ä¸‹æ–‡ä»¶æ›´å° |
| **å®Œå…¨å…è´¹** | $0ä¸“åˆ©è´¹ | BSD-2è®¸å¯è¯,æ— ä»»ä½•æˆæƒè´¹ç”¨ |
| **å…¨çƒé‡‡ç”¨** | 100%ä¸»æµå¹³å° | Android 12+/iOS/Chrome/Firefox/Safari |
| **åŠŸè€—æ›´ä½** | èŠ‚çœ40% | ç›¸æ¯”H.264è½¯è§£ |

### ä¸H.264å¯¹æ¯”

**å­˜å‚¨æˆæœ¬å¯¹æ¯”** (1å°æ—¶1080pè§†é¢‘):
```
H.264: 5 Mbps Ã— 3600s = 2.25 GB
AV1:   2.2 Mbps Ã— 3600s = 0.99 GB  â† èŠ‚çœ56%å­˜å‚¨! ğŸ’°

1000éƒ¨è§†é¢‘å­˜å‚¨æˆæœ¬:
H.264: 2250 GB Ã— $0.02/GB/æœˆ = $45/æœˆ
AV1:   990 GB Ã— $0.02/GB/æœˆ = $19.8/æœˆ
å¹´èŠ‚çœ: ($45 - $19.8) Ã— 12 = $302.4/å¹´
```

**å¸¦å®½æˆæœ¬å¯¹æ¯”** (100ä¸‡æ¬¡è§‚çœ‹):
```
H.264æµé‡: 2.25 GB Ã— 1,000,000 = 2250 TB
AV1æµé‡:   0.99 GB Ã— 1,000,000 = 990 TB

CDNå¸¦å®½è´¹ç”¨ ($0.05/GB):
H.264: 2250 TB Ã— $50/TB = $112,500
AV1:   990 TB Ã— $50/TB = $49,500
èŠ‚çœ: $63,000 (56%æˆæœ¬é™ä½!) ğŸ’°ğŸ’°ğŸ’°
```

### æµè§ˆå™¨æ”¯æŒç°çŠ¶ (2024)

| æµè§ˆå™¨ | AV1è§£ç  | dav1dé›†æˆ | å¸‚åœºä»½é¢ |
|--------|---------|-----------|---------|
| Chrome 90+ | âœ… | âœ… | 65% |
| Firefox 67+ | âœ… | âœ… | 3% |
| Safari 17+ | âœ… | âœ… | 20% |
| Edge 90+ | âœ… | âœ… | 5% |
| **æ€»è¦†ç›–** | **âœ…** | **âœ…** | **93%+** |

## æŠ€æœ¯æ¶æ„

### VideoSite AV1æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ç®¡ç†å‘˜ä¸Šä¼ è§†é¢‘ (åŸå§‹æ–‡ä»¶)                      â”‚
â”‚                         MP4/MKV/AVIç­‰                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    åç«¯è½¬ç æœåŠ¡ (Celery Worker)                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Step 1: FFmpegåˆ†ææºè§†é¢‘                                 â”‚   â”‚
â”‚  â”‚  â””â”€ åˆ†è¾¨ç‡: 1920x1080                                     â”‚   â”‚
â”‚  â”‚  â””â”€ ç¼–ç : H.264                                           â”‚   â”‚
â”‚  â”‚  â””â”€ ç ç‡: 5 Mbps                                          â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚  Step 2: å¤šåˆ†è¾¨ç‡å¹¶è¡Œè½¬ç  (AV1ç¼–ç )                       â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚   â”‚
â”‚  â”‚  â”‚  Thread 1: 1080p AV1                           â”‚      â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ Encoder: SVT-AV1                            â”‚      â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ Bitrate: 2.2 Mbps (vs H.264 5 Mbps)       â”‚      â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ Time: 15åˆ†é’Ÿ                                â”‚      â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      â”‚   â”‚
â”‚  â”‚  â”‚  Thread 2: 720p AV1                            â”‚      â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ Bitrate: 1.2 Mbps                          â”‚      â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ Time: 8åˆ†é’Ÿ                                 â”‚      â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      â”‚   â”‚
â”‚  â”‚  â”‚  Thread 3: 480p AV1                            â”‚      â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ Bitrate: 0.6 Mbps                          â”‚      â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ Time: 5åˆ†é’Ÿ                                 â”‚      â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚  Step 3: ç”ŸæˆHLSåˆ‡ç‰‡ (æ¯ä¸ªåˆ†è¾¨ç‡)                         â”‚   â”‚
â”‚  â”‚  â€¢ åˆ‡ç‰‡æ—¶é•¿: 6ç§’/ç‰‡                                       â”‚   â”‚
â”‚  â”‚  â€¢ æ ¼å¼: MPEG-TS (.ts)                                    â”‚   â”‚
â”‚  â”‚  â€¢ Playlist: index.m3u8                                   â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚  Step 4: ä¸Šä¼ åˆ°MinIO                                      â”‚   â”‚
â”‚  â”‚  â€¢ videos/{video_id}/av1/1080p/index.m3u8               â”‚   â”‚
â”‚  â”‚  â€¢ videos/{video_id}/av1/720p/index.m3u8                â”‚   â”‚
â”‚  â”‚  â€¢ videos/{video_id}/av1/480p/index.m3u8                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       MinIOå¯¹è±¡å­˜å‚¨                              â”‚
â”‚  videos/{video_id}/                                             â”‚
â”‚  â”œâ”€â”€ h264/ (å…¼å®¹æ€§)                                             â”‚
â”‚  â”‚   â”œâ”€â”€ 1080p/index.m3u8 (5 Mbps)                            â”‚
â”‚  â”‚   â”œâ”€â”€ 720p/index.m3u8 (3 Mbps)                             â”‚
â”‚  â”‚   â””â”€â”€ 480p/index.m3u8 (1.5 Mbps)                           â”‚
â”‚  â””â”€â”€ av1/ (é«˜æ•ˆå‹ç¼©) â­ æ¨è                                    â”‚
â”‚      â”œâ”€â”€ 1080p/index.m3u8 (2.2 Mbps) â† èŠ‚çœ56%!               â”‚
â”‚      â”œâ”€â”€ 720p/index.m3u8 (1.2 Mbps)                            â”‚
â”‚      â””â”€â”€ 480p/index.m3u8 (0.6 Mbps)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å‰ç«¯æ’­æ”¾å™¨ (Video.js)                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  æ’­æ”¾å™¨æ£€æµ‹æµè§ˆå™¨AV1æ”¯æŒ                                   â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚   â”‚
â”‚  â”‚  â”‚  if (æ”¯æŒAV1) {                                 â”‚      â”‚   â”‚
â”‚  â”‚  â”‚    åŠ è½½: videos/123/av1/master.m3u8            â”‚      â”‚   â”‚
â”‚  â”‚  â”‚    è§£ç å™¨: dav1d (æµè§ˆå™¨å†…ç½®)                  â”‚      â”‚   â”‚
â”‚  â”‚  â”‚    å¸¦å®½: èŠ‚çœ56% ğŸš€                             â”‚      â”‚   â”‚
â”‚  â”‚  â”‚  } else {                                       â”‚      â”‚   â”‚
â”‚  â”‚  â”‚    é™çº§: videos/123/h264/master.m3u8           â”‚      â”‚   â”‚
â”‚  â”‚  â”‚    è§£ç å™¨: H.264                                â”‚      â”‚   â”‚
â”‚  â”‚  â”‚  }                                              â”‚      â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### åŒæ ¼å¼ç­–ç•¥ (æ¸è¿›å¼è¿ç§»)

**é˜¶æ®µ1**: H.264ä¸ºä¸»,AV1å¯é€‰
```
æ‰€æœ‰è§†é¢‘: H.264 (å…¼å®¹æ€§)
éƒ¨åˆ†è§†é¢‘: H.264 + AV1 (æµ‹è¯•)
```

**é˜¶æ®µ2**: AV1ä¸ºä¸»,H.264é™çº§
```
æ‰€æœ‰è§†é¢‘: AV1 + H.264 (åŒæ ¼å¼)
æµè§ˆå™¨: ä¼˜å…ˆAV1,ä¸æ”¯æŒåˆ™H.264
```

**é˜¶æ®µ3**: çº¯AV1
```
æ–°è§†é¢‘: ä»…AV1 (93%+æµè§ˆå™¨æ”¯æŒ)
æ—§è§†é¢‘: ä¿ç•™H.264
```

## åç«¯é›†æˆ

### 1. å®‰è£…dav1d

#### Ubuntu/Debian

```bash
# å®‰è£…dav1dåº“
sudo apt update
sudo apt install libdav1d-dev libdav1d6

# éªŒè¯å®‰è£…
dav1d --version
# Output: dav1d 1.4.3
```

#### ç¼–è¯‘FFmpeg with dav1dæ”¯æŒ

```bash
# ä¸‹è½½FFmpegæºç 
git clone https://git.ffmpeg.org/ffmpeg.git
cd ffmpeg

# é…ç½® (å¯ç”¨dav1d)
./configure \
  --enable-libdav1d \
  --enable-libsvtav1 \
  --enable-gpl \
  --enable-nonfree

# ç¼–è¯‘å®‰è£…
make -j$(nproc)
sudo make install

# éªŒè¯dav1dæ”¯æŒ
ffmpeg -decoders | grep av1
# Output: V..... av1 (libdav1d)
```

### 2. è½¬ç è„šæœ¬ - SVT-AV1ç¼–ç å™¨

**SVT-AV1** (Scalable Video Technology for AV1) - Intel/Netflixå¼€æº

**ä¼˜åŠ¿**:
- âœ… æ¯”libaomç¼–ç å¿«**10-20å€**
- âœ… è´¨é‡ä¸libaomæ¥è¿‘
- âœ… å¤šçº¿ç¨‹ä¼˜åŒ–
- âœ… ç”Ÿäº§çº§ç¨³å®šæ€§

**å®‰è£…SVT-AV1**:

```bash
# Ubuntu
sudo apt install libsvtav1-dev libsvtav1enc1

# æˆ–ä»æºç ç¼–è¯‘
git clone https://gitlab.com/AOMediaCodec/SVT-AV1.git
cd SVT-AV1/Build
cmake .. -DCMAKE_BUILD_TYPE=Release
make -j$(nproc)
sudo make install
```

**AV1è½¬ç è„šæœ¬**:

```python
# backend/app/utils/av1_transcoder.py
import subprocess
from pathlib import Path
from typing import Dict, List

class AV1Transcoder:
    """AV1è§†é¢‘è½¬ç å™¨ (ä½¿ç”¨SVT-AV1ç¼–ç å™¨ + dav1dè§£ç å™¨)"""

    # AV1ç¼–ç é…ç½®
    PROFILES = {
        '1080p': {
            'resolution': '1920:1080',
            'bitrate': '2200k',      # 2.2 Mbps (vs H.264 5 Mbps)
            'preset': 8,             # 0-13: é€Ÿåº¦vsè´¨é‡ (8=å¿«é€Ÿ)
            'crf': 30,               # è´¨é‡å‚æ•° (30=é«˜è´¨é‡)
        },
        '720p': {
            'resolution': '1280:720',
            'bitrate': '1200k',
            'preset': 9,
            'crf': 32,
        },
        '480p': {
            'resolution': '854:480',
            'bitrate': '600k',
            'preset': 10,
            'crf': 34,
        },
        '360p': {
            'resolution': '640:360',
            'bitrate': '400k',
            'preset': 11,
            'crf': 36,
        }
    }

    @staticmethod
    def transcode_to_av1(
        input_path: Path,
        output_path: Path,
        resolution: str = '1080p',
        use_gpu: bool = False
    ) -> Path:
        """
        è½¬ç è§†é¢‘åˆ°AV1æ ¼å¼

        Args:
            input_path: è¾“å…¥è§†é¢‘è·¯å¾„
            output_path: è¾“å‡ºè§†é¢‘è·¯å¾„
            resolution: ç›®æ ‡åˆ†è¾¨ç‡ (1080p/720p/480p/360p)
            use_gpu: æ˜¯å¦ä½¿ç”¨GPUåŠ é€Ÿ (dav1dè§£ç )

        Returns:
            è¾“å‡ºæ–‡ä»¶è·¯å¾„
        """
        profile = AV1Transcoder.PROFILES[resolution]

        cmd = [
            'ffmpeg',
            '-y',  # è¦†ç›–è¾“å‡ºæ–‡ä»¶
        ]

        # ä½¿ç”¨dav1dç¡¬ä»¶åŠ é€Ÿè§£ç  (å¦‚æœè¾“å…¥æ˜¯AV1)
        if use_gpu:
            cmd.extend([
                '-hwaccel', 'auto',
            ])

        cmd.extend([
            '-i', str(input_path),

            # è§†é¢‘ç¼–ç  - SVT-AV1
            '-c:v', 'libsvtav1',
            '-preset', str(profile['preset']),
            '-crf', str(profile['crf']),
            '-b:v', profile['bitrate'],
            '-maxrate', profile['bitrate'],
            '-bufsize', str(int(profile['bitrate'].rstrip('k')) * 2) + 'k',

            # åˆ†è¾¨ç‡
            '-vf', f"scale={profile['resolution']}:flags=lanczos",

            # éŸ³é¢‘ç¼–ç  - Opus (AV1æ¨è)
            '-c:a', 'libopus',
            '-b:a', '128k',

            # å®¹å™¨æ ¼å¼
            '-f', 'mp4',
            '-movflags', '+faststart',

            str(output_path)
        ])

        # æ‰§è¡Œè½¬ç 
        print(f"è½¬ç å‘½ä»¤: {' '.join(cmd)}")
        result = subprocess.run(cmd, capture_output=True, text=True)

        if result.returncode != 0:
            raise Exception(f"è½¬ç å¤±è´¥: {result.stderr}")

        return output_path


    @staticmethod
    def transcode_to_hls_av1(
        input_path: Path,
        output_dir: Path,
        resolution: str = '1080p'
    ) -> Path:
        """
        è½¬ç ä¸ºAV1 HLSæµ

        Returns:
            master.m3u8è·¯å¾„
        """
        output_dir.mkdir(parents=True, exist_ok=True)
        profile = AV1Transcoder.PROFILES[resolution]

        cmd = [
            'ffmpeg',
            '-i', str(input_path),

            # è§†é¢‘ç¼–ç 
            '-c:v', 'libsvtav1',
            '-preset', str(profile['preset']),
            '-crf', str(profile['crf']),
            '-b:v', profile['bitrate'],
            '-vf', f"scale={profile['resolution']}",

            # éŸ³é¢‘ç¼–ç 
            '-c:a', 'libopus',
            '-b:a', '128k',

            # HLSé…ç½®
            '-f', 'hls',
            '-hls_time', '6',                    # 6ç§’/ç‰‡
            '-hls_playlist_type', 'vod',
            '-hls_segment_filename', str(output_dir / 'segment_%03d.ts'),
            '-hls_segment_type', 'mpegts',

            str(output_dir / 'index.m3u8')
        ]

        subprocess.run(cmd, check=True)
        return output_dir / 'index.m3u8'


    @staticmethod
    def create_master_playlist(
        video_id: int,
        resolutions: Dict[str, str],
        format_type: str = 'av1'
    ) -> str:
        """
        ç”ŸæˆHLS Master Playlist

        Args:
            video_id: è§†é¢‘ID
            resolutions: {'1080p': 'path/to/1080p/index.m3u8', ...}
            format_type: 'av1' or 'h264'

        Returns:
            Master playlistå†…å®¹
        """
        playlist = "#EXTM3U\n#EXT-X-VERSION:3\n\n"

        # åˆ†è¾¨ç‡é…ç½®
        resolution_configs = {
            '1080p': {'bandwidth': 2200000, 'width': 1920, 'height': 1080},
            '720p':  {'bandwidth': 1200000, 'width': 1280, 'height': 720},
            '480p':  {'bandwidth': 600000,  'width': 854,  'height': 480},
            '360p':  {'bandwidth': 400000,  'width': 640,  'height': 360},
        }

        # AV1ç¼–è§£ç å™¨å£°æ˜
        codec = 'av01.0.05M.08' if format_type == 'av1' else 'avc1.64001f'

        for res, url in resolutions.items():
            config = resolution_configs.get(res, {})
            playlist += f"""#EXT-X-STREAM-INF:BANDWIDTH={config['bandwidth']},RESOLUTION={config['width']}x{config['height']},CODECS="{codec},opus"
{url}

"""

        return playlist
```

### 3. Celeryä»»åŠ¡é›†æˆ

```python
# backend/app/tasks/transcode_av1.py
from celery import shared_task
from pathlib import Path
import shutil
from app.utils.av1_transcoder import AV1Transcoder
from app.utils.minio_client import MinIOClient
from app.database import SessionLocal
from app.models.video import Video

@shared_task(bind=True)
def transcode_video_to_av1(self, video_id: int):
    """
    è½¬ç è§†é¢‘ä¸ºAV1æ ¼å¼ (å¤šåˆ†è¾¨ç‡)

    å·¥ä½œæµ:
    1. ä¸‹è½½åŸå§‹è§†é¢‘
    2. è½¬ç ä¸ºå¤šä¸ªAV1åˆ†è¾¨ç‡
    3. ç”ŸæˆHLSåˆ‡ç‰‡
    4. ä¸Šä¼ åˆ°MinIO
    5. æ›´æ–°æ•°æ®åº“
    """
    db = SessionLocal()

    try:
        # 1. è·å–è§†é¢‘
        video = db.query(Video).filter(Video.id == video_id).first()
        if not video:
            raise ValueError(f"Video {video_id} not found")

        # 2. åˆ›å»ºä¸´æ—¶ç›®å½•
        temp_dir = Path(f'/tmp/av1_transcode_{video_id}')
        temp_dir.mkdir(exist_ok=True)

        # 3. ä¸‹è½½åŸå§‹è§†é¢‘
        original_path = temp_dir / 'original.mp4'
        minio_client = MinIOClient()
        minio_client.download_file(video.source_url, str(original_path))

        # 4. åˆ†ææºè§†é¢‘
        from app.utils.video_analyzer import analyze_video
        metadata = analyze_video(original_path)
        source_resolution = metadata['height']

        # 5. å†³å®šè¦è½¬ç çš„åˆ†è¾¨ç‡ (ä¸è¶…è¿‡æºåˆ†è¾¨ç‡)
        all_resolutions = ['1080p', '720p', '480p', '360p']
        resolution_heights = {'1080p': 1080, '720p': 720, '480p': 480, '360p': 360}

        target_resolutions = [
            res for res in all_resolutions
            if resolution_heights[res] <= source_resolution
        ]

        print(f"æºåˆ†è¾¨ç‡: {source_resolution}p")
        print(f"ç›®æ ‡åˆ†è¾¨ç‡: {target_resolutions}")

        # 6. å¹¶è¡Œè½¬ç æ‰€æœ‰åˆ†è¾¨ç‡
        from concurrent.futures import ThreadPoolExecutor
        hls_urls = {}

        def transcode_resolution(resolution: str):
            output_dir = temp_dir / 'av1' / resolution
            output_dir.mkdir(parents=True, exist_ok=True)

            # è½¬ç ä¸ºAV1 HLS
            m3u8_path = AV1Transcoder.transcode_to_hls_av1(
                original_path,
                output_dir,
                resolution
            )

            # ä¸Šä¼ åˆ°MinIO
            url = upload_hls_to_minio(
                video_id,
                resolution,
                output_dir,
                format_type='av1'
            )
            return resolution, url

        with ThreadPoolExecutor(max_workers=4) as executor:
            results = executor.map(transcode_resolution, target_resolutions)
            hls_urls = dict(results)

        # 7. ç”ŸæˆMaster Playlist
        master_content = AV1Transcoder.create_master_playlist(
            video_id,
            hls_urls,
            format_type='av1'
        )

        # ä¸Šä¼ Master Playlist
        master_path = temp_dir / 'master.m3u8'
        master_path.write_text(master_content)

        master_url = minio_client.upload_file(
            str(master_path),
            f'videos/{video_id}/av1/master.m3u8'
        )

        # 8. æ›´æ–°æ•°æ®åº“
        video.av1_master_url = master_url
        video.av1_resolutions = hls_urls
        video.is_av1_available = True
        db.commit()

        # 9. æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        shutil.rmtree(temp_dir)

        return {
            'status': 'success',
            'video_id': video_id,
            'resolutions': list(hls_urls.keys()),
            'master_url': master_url
        }

    except Exception as e:
        db.rollback()
        raise
    finally:
        db.close()


def upload_hls_to_minio(
    video_id: int,
    resolution: str,
    hls_dir: Path,
    format_type: str = 'av1'
) -> str:
    """ä¸Šä¼ HLSæ–‡ä»¶åˆ°MinIO"""
    minio_client = MinIOClient()

    for file_path in hls_dir.glob('*'):
        if file_path.is_file():
            object_name = f'videos/{video_id}/{format_type}/{resolution}/{file_path.name}'
            minio_client.upload_file(str(file_path), object_name)

    return f'videos/{video_id}/{format_type}/{resolution}/index.m3u8'
```

### 4. æ•°æ®åº“æ‰©å±•

```sql
-- æ·»åŠ AV1å­—æ®µåˆ°videosè¡¨
ALTER TABLE videos ADD COLUMN av1_master_url TEXT;
ALTER TABLE videos ADD COLUMN av1_resolutions JSONB DEFAULT '{}';
ALTER TABLE videos ADD COLUMN is_av1_available BOOLEAN DEFAULT FALSE;
ALTER TABLE videos ADD COLUMN av1_file_size BIGINT;  -- AV1æ–‡ä»¶å¤§å°
ALTER TABLE videos ADD COLUMN h264_file_size BIGINT; -- H.264æ–‡ä»¶å¤§å° (å¯¹æ¯”)

-- ç¤ºä¾‹æ•°æ®
UPDATE videos SET
  av1_master_url = 'videos/123/av1/master.m3u8',
  av1_resolutions = '{
    "1080p": "videos/123/av1/1080p/index.m3u8",
    "720p": "videos/123/av1/720p/index.m3u8",
    "480p": "videos/123/av1/480p/index.m3u8"
  }',
  is_av1_available = true,
  av1_file_size = 990000000,    -- 990 MB
  h264_file_size = 2250000000   -- 2.25 GB
WHERE id = 123;
```

**SQLAlchemyæ¨¡å‹æ›´æ–°**:

```python
# backend/app/models/video.py
from sqlalchemy import Column, Integer, String, Text, Boolean, BigInteger
from sqlalchemy.dialects.postgresql import JSONB

class Video(Base):
    __tablename__ = "videos"

    # ... ç°æœ‰å­—æ®µ ...

    # H.264å­—æ®µ
    hls_master_url = Column(Text)  # H.264 master playlist

    # AV1å­—æ®µ (æ–°å¢)
    av1_master_url = Column(Text)
    av1_resolutions = Column(JSONB, default={})
    is_av1_available = Column(Boolean, default=False)
    av1_file_size = Column(BigInteger)
    h264_file_size = Column(BigInteger)

    @property
    def compression_ratio(self) -> float:
        """è®¡ç®—AV1ç›¸å¯¹H.264çš„å‹ç¼©ç‡"""
        if self.h264_file_size and self.av1_file_size:
            return (1 - self.av1_file_size / self.h264_file_size) * 100
        return 0.0
```

## å‰ç«¯é›†æˆ

### 1. æµè§ˆå™¨AV1æ”¯æŒæ£€æµ‹

```typescript
// frontend/src/utils/codecSupport.ts

/**
 * æ£€æµ‹æµè§ˆå™¨æ˜¯å¦æ”¯æŒAV1è§£ç 
 */
export function supportsAV1(): boolean {
  const video = document.createElement('video');

  // æ–¹æ³•1: canPlayTypeæ£€æµ‹
  const canPlay = video.canPlayType('video/mp4; codecs="av01.0.05M.08"');

  if (canPlay === 'probably' || canPlay === 'maybe') {
    return true;
  }

  // æ–¹æ³•2: MediaSourceæ£€æµ‹
  if (typeof MediaSource !== 'undefined') {
    return MediaSource.isTypeSupported('video/mp4; codecs="av01.0.05M.08"');
  }

  return false;
}

/**
 * è·å–æ”¯æŒçš„ç¼–è§£ç å™¨
 */
export function getSupportedCodecs(): {
  h264: boolean;
  h265: boolean;
  vp9: boolean;
  av1: boolean;
} {
  const video = document.createElement('video');

  return {
    h264: video.canPlayType('video/mp4; codecs="avc1.42E01E"') !== '',
    h265: video.canPlayType('video/mp4; codecs="hev1.1.6.L93.B0"') !== '',
    vp9: video.canPlayType('video/webm; codecs="vp9"') !== '',
    av1: supportsAV1(),
  };
}

/**
 * è·å–æœ€ä½³è§†é¢‘URL (AV1ä¼˜å…ˆ)
 */
export function getBestVideoUrl(video: {
  av1_master_url?: string;
  hls_master_url: string;
  is_av1_available: boolean;
}): string {
  // ä¼˜å…ˆAV1 (å¦‚æœæµè§ˆå™¨æ”¯æŒ)
  if (video.is_av1_available && video.av1_master_url && supportsAV1()) {
    console.log('âœ… ä½¿ç”¨AV1æ ¼å¼ (èŠ‚çœ56%å¸¦å®½)');
    return video.av1_master_url;
  }

  // é™çº§åˆ°H.264
  console.log('âš ï¸ é™çº§åˆ°H.264æ ¼å¼');
  return video.hls_master_url;
}
```

### 2. Video.jsæ’­æ”¾å™¨é›†æˆ

```typescript
// frontend/src/components/VideoPlayer/AV1Player.tsx
import React, { useEffect, useRef, useState } from 'react';
import videojs from 'video.js';
import 'video.js/dist/video-js.css';
import { supportsAV1, getBestVideoUrl } from '@/utils/codecSupport';

interface AV1PlayerProps {
  video: {
    id: number;
    title: string;
    av1_master_url?: string;
    hls_master_url: string;
    is_av1_available: boolean;
    poster_url: string;
  };
}

export const AV1Player: React.FC<AV1PlayerProps> = ({ video }) => {
  const videoRef = useRef<HTMLVideoElement>(null);
  const playerRef = useRef<any>(null);
  const [codecUsed, setCodecUsed] = useState<'av1' | 'h264'>('h264');

  useEffect(() => {
    if (!videoRef.current) return;

    // åˆå§‹åŒ–Video.js
    const player = videojs(videoRef.current, {
      controls: true,
      fluid: true,
      poster: video.poster_url,
      html5: {
        vhs: {
          overrideNative: true,
        },
      },
    });

    playerRef.current = player;

    // é€‰æ‹©æœ€ä½³è§†é¢‘æº
    const videoUrl = getBestVideoUrl(video);
    const isAV1 = videoUrl === video.av1_master_url;

    player.src({
      src: videoUrl,
      type: 'application/x-mpegURL',
    });

    setCodecUsed(isAV1 ? 'av1' : 'h264');

    // ç›‘å¬æ’­æ”¾äº‹ä»¶
    player.on('loadedmetadata', () => {
      console.log('è§†é¢‘å…ƒæ•°æ®åŠ è½½å®Œæˆ');
      console.log('ä½¿ç”¨ç¼–è§£ç å™¨:', isAV1 ? 'AV1 (dav1d)' : 'H.264');
    });

    // ç›‘å¬é”™è¯¯ (AV1æ’­æ”¾å¤±è´¥æ—¶é™çº§)
    player.on('error', () => {
      const error = player.error();
      console.error('æ’­æ”¾é”™è¯¯:', error);

      if (isAV1 && video.hls_master_url) {
        console.warn('AV1æ’­æ”¾å¤±è´¥,é™çº§åˆ°H.264');
        player.src({
          src: video.hls_master_url,
          type: 'application/x-mpegURL',
        });
        setCodecUsed('h264');
      }
    });

    return () => {
      if (playerRef.current) {
        playerRef.current.dispose();
      }
    };
  }, [video]);

  return (
    <div className="av1-player-container">
      {/* ç¼–è§£ç å™¨æŒ‡ç¤ºå™¨ */}
      <div className="codec-indicator">
        {codecUsed === 'av1' ? (
          <span className="badge badge-success">
            âœ… AV1 (èŠ‚çœ56%æµé‡)
          </span>
        ) : (
          <span className="badge badge-warning">
            H.264 (å…¼å®¹æ¨¡å¼)
          </span>
        )}
      </div>

      <div data-vjs-player>
        <video
          ref={videoRef}
          className="video-js vjs-big-play-centered"
        />
      </div>

      {/* AV1æ”¯æŒæç¤º */}
      {!supportsAV1() && (
        <div className="alert alert-info">
          ğŸ’¡ æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒAV1,è¯·æ›´æ–°åˆ°æœ€æ–°ç‰ˆChrome/Firefox/Safariä»¥èŠ‚çœæµé‡
        </div>
      )}
    </div>
  );
};
```

### 3. ç»Ÿè®¡AV1ä½¿ç”¨ç‡

```typescript
// frontend/src/utils/analytics.ts

/**
 * ä¸ŠæŠ¥ç¼–è§£ç å™¨ä½¿ç”¨ç»Ÿè®¡
 */
export function reportCodecUsage(videoId: number, codec: 'av1' | 'h264') {
  // å‘é€åˆ°åç«¯ç»Ÿè®¡API
  fetch('/api/v1/analytics/codec-usage', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      video_id: videoId,
      codec: codec,
      browser: navigator.userAgent,
      timestamp: new Date().toISOString(),
    }),
  });
}
```

## è½¬ç å·¥ä½œæµ

### å®Œæ•´è½¬ç æµç¨‹

```python
# backend/app/tasks/video_pipeline.py
from celery import chain

def process_uploaded_video(video_id: int):
    """
    è§†é¢‘å¤„ç†ç®¡çº¿ (H.264 + AV1åŒæ ¼å¼)

    å·¥ä½œæµ:
    1. è½¬ç H.264 (å…¼å®¹æ€§ä¼˜å…ˆ)
    2. è½¬ç AV1 (é«˜æ•ˆå‹ç¼©)
    3. ç”Ÿæˆç¼©ç•¥å›¾
    4. ç”Ÿæˆhoveré¢„è§ˆ
    """

    # åˆ›å»ºä»»åŠ¡é“¾
    pipeline = chain(
        # ä»»åŠ¡1: H.264è½¬ç  (å¿«é€Ÿ,ä¼˜å…ˆä¸Šçº¿)
        transcode_video_to_h264.s(video_id),

        # ä»»åŠ¡2: AV1è½¬ç  (æ…¢é€Ÿ,åå°è¿›è¡Œ)
        transcode_video_to_av1.s(video_id),

        # ä»»åŠ¡3: ç”Ÿæˆç¼©ç•¥å›¾
        generate_thumbnails.s(video_id),

        # ä»»åŠ¡4: ç”Ÿæˆhoveré¢„è§ˆ
        generate_hover_preview.s(video_id),

        # ä»»åŠ¡5: é€šçŸ¥å®Œæˆ
        notify_transcode_complete.s(video_id)
    )

    # å¼‚æ­¥æ‰§è¡Œ
    pipeline.apply_async()
```

### è½¬ç æ—¶é—´é¢„ä¼°

| è§†é¢‘æ—¶é•¿ | åˆ†è¾¨ç‡ | H.264è½¬ç  | AV1è½¬ç  | æ€»æ—¶é•¿ |
|---------|--------|----------|---------|--------|
| 10åˆ†é’Ÿ | 1080p | 3åˆ†é’Ÿ | 15åˆ†é’Ÿ | 18åˆ†é’Ÿ |
| 30åˆ†é’Ÿ | 1080p | 8åˆ†é’Ÿ | 45åˆ†é’Ÿ | 53åˆ†é’Ÿ |
| 60åˆ†é’Ÿ | 1080p | 15åˆ†é’Ÿ | 90åˆ†é’Ÿ | 105åˆ†é’Ÿ |
| 60åˆ†é’Ÿ | 4K | 30åˆ†é’Ÿ | 180åˆ†é’Ÿ | 210åˆ†é’Ÿ |

**ä¼˜åŒ–å»ºè®®**:
- âœ… H.264ä¼˜å…ˆä¸Šçº¿ (3åˆ†é’Ÿå†…å¯æ’­æ”¾)
- âœ… AV1åå°è½¬ç  (ç”¨æˆ·æ— æ„ŸçŸ¥)
- âœ… ä½¿ç”¨GPUåŠ é€Ÿ (è½¬ç æ—¶é—´å‡åŠ)

## æ€§èƒ½ä¼˜åŒ–

### 1. SVT-AV1ç¼–ç å™¨ä¼˜åŒ–

**Presetå‚æ•°å¯¹æ¯”** (é€Ÿåº¦vsè´¨é‡):

| Preset | ç¼–ç é€Ÿåº¦ | è´¨é‡ | æ¨èåœºæ™¯ |
|--------|---------|------|---------|
| 0 | ææ…¢ (0.5x) | æœ€é«˜ | å½’æ¡£ |
| 4 | æ…¢ (2x) | é«˜ | ä»˜è´¹å†…å®¹ |
| **8** | **å¿« (10x)** | **ä¸­é«˜** | **ç”Ÿäº§æ¨è** |
| 10 | å¾ˆå¿« (20x) | ä¸­ | å®æ—¶åº”ç”¨ |
| 13 | æå¿« (50x) | ä½ | æµ‹è¯• |

**æ¨èé…ç½®** (ç”Ÿäº§ç¯å¢ƒ):

```python
PROFILES = {
    '1080p': {
        'preset': 8,      # å¹³è¡¡é€Ÿåº¦å’Œè´¨é‡
        'crf': 30,        # é«˜è´¨é‡ (28-32ä¸ºä½³)
        'bitrate': '2200k',
    }
}
```

### 2. å¤šçº¿ç¨‹å¹¶è¡Œè½¬ç 

```python
from concurrent.futures import ThreadPoolExecutor

def parallel_transcode(video_id: int, resolutions: List[str]):
    """å¹¶è¡Œè½¬ç å¤šä¸ªåˆ†è¾¨ç‡"""

    with ThreadPoolExecutor(max_workers=len(resolutions)) as executor:
        futures = [
            executor.submit(transcode_resolution, video_id, res)
            for res in resolutions
        ]

        results = [f.result() for f in futures]

    return results
```

**æ€§èƒ½æå‡**:
- ä¸²è¡Œ: 15min (1080p) + 8min (720p) + 5min (480p) = **28åˆ†é’Ÿ**
- å¹¶è¡Œ: max(15min, 8min, 5min) = **15åˆ†é’Ÿ** (1.9å€æå‡)

### 3. ä¸¤é˜¶æ®µç¼–ç  (2-pass)

```bash
# Pass 1: åˆ†æè§†é¢‘
ffmpeg -i input.mp4 \
  -c:v libsvtav1 -preset 8 -crf 30 \
  -pass 1 -f null /dev/null

# Pass 2: å®é™…ç¼–ç  (è´¨é‡æ›´é«˜)
ffmpeg -i input.mp4 \
  -c:v libsvtav1 -preset 8 -crf 30 \
  -pass 2 output.mp4
```

**æ•ˆæœ**:
- æ–‡ä»¶å¤§å°: å‡å°‘10-15%
- è´¨é‡: æå‡5-10%
- æ—¶é—´: å¢åŠ 100% (æ…ç”¨)

**å»ºè®®**: ä»…å¯¹é‡è¦å†…å®¹ä½¿ç”¨2-pass

## éƒ¨ç½²æŒ‡å—

### 1. æœåŠ¡å™¨è¦æ±‚

**æœ€ä½é…ç½®**:
- CPU: 8æ ¸å¿ƒ (æ”¯æŒAVX2æŒ‡ä»¤é›†)
- å†…å­˜: 16GB
- å­˜å‚¨: NVMe SSD (ä¸´æ—¶æ–‡ä»¶)

**æ¨èé…ç½®**:
- CPU: 16æ ¸å¿ƒ+ (AMD Ryzen 9 / Intel i9)
- å†…å­˜: 32GB+
- GPU: NVIDIA RTX 3060+ (å¯é€‰,ç”¨äºH.264åŠ é€Ÿ)

### 2. Dockeréƒ¨ç½²

```dockerfile
# backend/Dockerfile
FROM ubuntu:22.04

# å®‰è£…ä¾èµ–
RUN apt-get update && apt-get install -y \
    ffmpeg \
    libdav1d6 \
    libsvtav1enc1 \
    python3.11 \
    python3-pip

# å®‰è£…Pythonä¾èµ–
COPY requirements.txt .
RUN pip3 install -r requirements.txt

# å¤åˆ¶ä»£ç 
COPY . /app
WORKDIR /app

# Celery Workerå¯åŠ¨
CMD celery -A app.celery worker \
    --loglevel=info \
    --concurrency=4 \
    --max-tasks-per-child=50
```

### 3. ç›‘æ§å’Œå‘Šè­¦

```python
# backend/app/monitoring/av1_metrics.py
from prometheus_client import Counter, Histogram, Gauge

# è½¬ç è®¡æ•°
av1_transcodes_total = Counter(
    'av1_transcodes_total',
    'Total AV1 transcodes',
    ['resolution', 'status']
)

# è½¬ç æ—¶é•¿
av1_transcode_duration = Histogram(
    'av1_transcode_duration_seconds',
    'AV1 transcode duration',
    ['resolution']
)

# å‹ç¼©ç‡
av1_compression_ratio = Gauge(
    'av1_compression_ratio_percent',
    'AV1 vs H.264 compression ratio',
    ['video_id']
)

# ä½¿ç”¨ç¤ºä¾‹
def track_transcode(video_id: int, resolution: str):
    import time
    start = time.time()

    try:
        # è½¬ç é€»è¾‘
        transcode_to_av1(video_id, resolution)

        # è®°å½•æˆåŠŸ
        av1_transcodes_total.labels(resolution=resolution, status='success').inc()
        duration = time.time() - start
        av1_transcode_duration.labels(resolution=resolution).observe(duration)

    except Exception as e:
        av1_transcodes_total.labels(resolution=resolution, status='failed').inc()
        raise
```

## æˆæœ¬æ”¶ç›Šåˆ†æ

### VideoSiteé¡¹ç›®æˆæœ¬å¯¹æ¯”

**å‡è®¾**:
- è§†é¢‘æ•°é‡: 10,000éƒ¨
- å¹³å‡æ—¶é•¿: 60åˆ†é’Ÿ
- å¹³å‡åˆ†è¾¨ç‡: 1080p
- æœˆæ´»ç”¨æˆ·: 100,000
- äººå‡è§‚çœ‹: 10å°æ—¶/æœˆ

### å­˜å‚¨æˆæœ¬

| é¡¹ç›® | H.264 | AV1 | èŠ‚çœ |
|------|-------|-----|------|
| å•éƒ¨è§†é¢‘ | 2.25 GB | 0.99 GB | 1.26 GB (56%) |
| 10,000éƒ¨ | 22.5 TB | 9.9 TB | 12.6 TB (56%) |
| å­˜å‚¨è´¹ç”¨ ($0.02/GB/æœˆ) | $450/æœˆ | $198/æœˆ | **$252/æœˆ** |
| **å¹´åº¦èŠ‚çœ** | - | - | **$3,024** |

### å¸¦å®½æˆæœ¬

| é¡¹ç›® | H.264 | AV1 | èŠ‚çœ |
|------|-------|-----|------|
| å•ç”¨æˆ·æœˆæµé‡ | 22.5 GB | 9.9 GB | 12.6 GB (56%) |
| 100,000ç”¨æˆ· | 2250 TB | 990 TB | 1260 TB (56%) |
| CDNè´¹ç”¨ ($0.05/GB) | $112,500/æœˆ | $49,500/æœˆ | **$63,000/æœˆ** |
| **å¹´åº¦èŠ‚çœ** | - | - | **$756,000** |

### è½¬ç æˆæœ¬

| é¡¹ç›® | H.264 | AV1 | å¢åŠ  |
|------|-------|-----|------|
| CPUæ—¶é—´ (å•éƒ¨60åˆ†é’Ÿ) | 15åˆ†é’Ÿ | 90åˆ†é’Ÿ | +75åˆ†é’Ÿ |
| æœåŠ¡å™¨æˆæœ¬ (16æ ¸/$200/æœˆ) | - | - | +$100/æœˆ |
| **å¹´åº¦å¢åŠ ** | - | - | **$1,200** |

### **å‡€èŠ‚çœ** (å¹´åº¦):

```
å­˜å‚¨èŠ‚çœ:  $3,024
å¸¦å®½èŠ‚çœ:  $756,000
è½¬ç å¢åŠ : -$1,200
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å‡€èŠ‚çœ:    $757,824/å¹´  ğŸ’°ğŸ’°ğŸ’°
```

**æŠ•èµ„å›æŠ¥ç‡ (ROI)**:
- æŠ•èµ„: $1,200 (æœåŠ¡å™¨æˆæœ¬)
- å›æŠ¥: $757,824
- **ROI: 63,052%** ğŸš€

### ç¯å¢ƒå½±å“

**ç¢³æ’æ”¾å‡å°‘**:
- å¸¦å®½å‡å°‘56% â†’ æ•°æ®ä¸­å¿ƒèƒ½è€—å‡å°‘56%
- å¹´èŠ‚çœç”µåŠ›: ~500 MWh
- ç¢³æ’æ”¾å‡å°‘: ~200å¨COâ‚‚

## æ€»ç»“

### âœ… AV1 (dav1d)æ ¸å¿ƒä¼˜åŠ¿

1. **ä¸–ç•Œæœ€å¿«** - æ¯”libaomå¿«11å€
2. **å‹ç¼©ç‡æœ€é«˜** - èŠ‚çœ56%å¸¦å®½å’Œå­˜å‚¨
3. **å®Œå…¨å…è´¹** - æ— ä¸“åˆ©è´¹
4. **å…¨çƒé‡‡ç”¨** - 93%+æµè§ˆå™¨æ”¯æŒ
5. **å·¨é¢èŠ‚çœ** - å¹´èŠ‚çœ$75ä¸‡æˆæœ¬

### ğŸš€ å®æ–½è·¯çº¿å›¾

**ç¬¬1å‘¨**: ç¯å¢ƒæ­å»º
- âœ… å®‰è£…dav1d/SVT-AV1
- âœ… é…ç½®FFmpeg
- âœ… æµ‹è¯•è½¬ç 

**ç¬¬2-4å‘¨**: åç«¯å¼€å‘
- âœ… ç¼–å†™è½¬ç è„šæœ¬
- âœ… Celeryä»»åŠ¡é›†æˆ
- âœ… æ•°æ®åº“æ‰©å±•

**ç¬¬1-2æœˆ**: å‰ç«¯å¼€å‘
- âœ… AV1æ£€æµ‹é€»è¾‘
- âœ… Video.jsé›†æˆ
- âœ… é™çº§æ–¹æ¡ˆ

**ç¬¬3æœˆ**: ç°åº¦å‘å¸ƒ
- âœ… 10%æµé‡æµ‹è¯•
- âœ… ç›‘æ§è´¨é‡
- âœ… æ”¶é›†åé¦ˆ

**ç¬¬4æœˆ**: å…¨é‡ä¸Šçº¿
- âœ… 100%æ–°è§†é¢‘AV1
- âœ… é€æ­¥è¿ç§»æ—§è§†é¢‘

### ğŸ“Š é¢„æœŸæ•ˆæœ

- âœ… **å¸¦å®½èŠ‚çœ**: 56%
- âœ… **å­˜å‚¨èŠ‚çœ**: 56%
- âœ… **æˆæœ¬èŠ‚çœ**: $75ä¸‡/å¹´
- âœ… **ç”¨æˆ·ä½“éªŒ**: åŠ è½½æ›´å¿«,æµé‡æ›´çœ
- âœ… **ç¯å¢ƒå‹å¥½**: å‡å°‘200å¨COâ‚‚æ’æ”¾

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0.0
**æœ€åæ›´æ–°**: 2025-10-10
**æ¨èä¼˜å…ˆçº§**: â­â­â­â­â­ (æœ€é«˜)
