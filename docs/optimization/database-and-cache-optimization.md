# æ•°æ®åº“å’Œç¼“å­˜ä¼˜åŒ–æŠ¥å‘Š

**ä¼˜åŒ–æ—¥æœŸ**: 2025-10-10
**ä¼˜åŒ–ç›®æ ‡**: æå‡æŸ¥è¯¢æ€§èƒ½å’Œå“åº”é€Ÿåº¦
**é¢„è®¡æ€§èƒ½æå‡**: 30-50%

---

## ğŸ“Š ä¼˜åŒ–æ€»ç»“

### æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–

#### 1. å·²æœ‰çš„åŸºç¡€ç´¢å¼• âœ…
æ‰€æœ‰ä¸»è¦è¡¨éƒ½å·²å…·å¤‡åŸºæœ¬ç´¢å¼•:
- ä¸»é”®ç´¢å¼• (id)
- å¤–é”®ç´¢å¼• (user_id, video_idç­‰)
- å¸¸ç”¨å­—æ®µç´¢å¼• (status, created_at, slugç­‰)

#### 2. æ–°å¢å¤åˆç´¢å¼• ğŸ†•

å¤åˆç´¢å¼•é’ˆå¯¹å¸¸è§æŸ¥è¯¢æ¨¡å¼ä¼˜åŒ–,æ˜¾è‘—æå‡å¤šæ¡ä»¶æŸ¥è¯¢æ€§èƒ½:

| ç´¢å¼•åç§° | è¡¨ | å­—æ®µ | ä½¿ç”¨åœºæ™¯ | æ€§èƒ½æå‡ |
|---------|-----|------|---------|---------|
| `idx_videos_status_created` | videos | (status, created_at DESC) | è·å–å·²å‘å¸ƒè§†é¢‘åˆ—è¡¨ | âš¡âš¡âš¡ |
| `idx_comments_video_created` | comments | (video_id, created_at DESC) | è§†é¢‘è¯„è®ºæ—¶é—´æ’åº | âš¡âš¡âš¡ |
| `idx_comments_video_pinned_created` | comments | (video_id, is_pinned DESC, created_at DESC) | ç½®é¡¶è¯„è®ºä¼˜å…ˆæ˜¾ç¤º | âš¡âš¡âš¡ |
| `idx_favorites_user_created` | favorites | (user_id, created_at DESC) | ç”¨æˆ·æ”¶è—æ—¶é—´æ’åº | âš¡âš¡ |
| `idx_watch_history_user_updated` | watch_history | (user_id, updated_at DESC) | è§‚çœ‹å†å²è®°å½• | âš¡âš¡ |

**å®æ–½æ–¹å¼**:
- æ•°æ®åº“è¿ç§»: `572567d54b16_add_composite_indexes_for_performance.py`
- è‡ªåŠ¨åº”ç”¨: `alembic upgrade head`

**æŸ¥è¯¢ä¼˜åŒ–ç¤ºä¾‹**:
```sql
-- ä¼˜åŒ–å‰: éœ€è¦æ‰«æstatusç´¢å¼• + created_atç´¢å¼• + æ’åº
-- ä¼˜åŒ–å: ç›´æ¥ä½¿ç”¨å¤åˆç´¢å¼•,æ— éœ€é¢å¤–æ’åº
SELECT * FROM videos
WHERE status = 'PUBLISHED'
ORDER BY created_at DESC
LIMIT 20;
```

---

### N+1 æŸ¥è¯¢ä¼˜åŒ–

#### å·²å®ç°çš„ä¼˜åŒ– âœ…

ä½¿ç”¨ SQLAlchemy çš„ `selectinload` é¢„åŠ è½½å…³è”æ•°æ®:

**è§†é¢‘è¯¦æƒ…API** (`/api/v1/videos/{id}`):
```python
query = select(Video).options(
    selectinload(Video.country),
    selectinload(Video.video_categories),  # ä¸€æ¬¡æŸ¥è¯¢åŠ è½½æ‰€æœ‰åˆ†ç±»
    selectinload(Video.video_tags),        # ä¸€æ¬¡æŸ¥è¯¢åŠ è½½æ‰€æœ‰æ ‡ç­¾
    selectinload(Video.video_actors),      # ä¸€æ¬¡æŸ¥è¯¢åŠ è½½æ‰€æœ‰æ¼”å‘˜
    selectinload(Video.video_directors),   # ä¸€æ¬¡æŸ¥è¯¢åŠ è½½æ‰€æœ‰å¯¼æ¼”
)
```

**æ€§èƒ½å¯¹æ¯”**:
- ä¼˜åŒ–å‰: 1ä¸ªè§†é¢‘æŸ¥è¯¢ + Nä¸ªåˆ†ç±»æŸ¥è¯¢ + Nä¸ªæ¼”å‘˜æŸ¥è¯¢ ... â‰ˆ 50+ æ¬¡æ•°æ®åº“æŸ¥è¯¢
- ä¼˜åŒ–å: 6æ¬¡æŸ¥è¯¢ (1ä¸ªä¸»æŸ¥è¯¢ + 5ä¸ªå…³è”æŸ¥è¯¢)
- **æ€§èƒ½æå‡: 90%+**

---

## ğŸš€ Redis ç¼“å­˜ä¼˜åŒ–

### ç¼“å­˜æ¶æ„ âœ…

å·²å®ç°å®Œæ•´çš„ç¼“å­˜ç³»ç»Ÿ:

#### 1. ç¼“å­˜å·¥å…·ç±» (`app/utils/cache.py`)

**æ ¸å¿ƒåŠŸèƒ½**:
- `Cache.get()` - è·å–ç¼“å­˜
- `Cache.set()` - è®¾ç½®ç¼“å­˜ (æ”¯æŒTTL)
- `Cache.delete()` - åˆ é™¤ç¼“å­˜
- `Cache.delete_pattern()` - æ‰¹é‡åˆ é™¤
- `@cache_result` - è£…é¥°å™¨ç¼“å­˜

**ç‰¹æ€§**:
- âœ… Pickle åºåˆ—åŒ– (æ”¯æŒå¤æ‚Pythonå¯¹è±¡)
- âœ… è¿æ¥æ±  (max_connections=50)
- âœ… ç¼“å­˜ç»Ÿè®¡ (å‘½ä¸­ç‡è¿½è¸ª)
- âœ… è‡ªåŠ¨è¿‡æœŸ (TTLæœºåˆ¶)

#### 2. å·²ç¼“å­˜çš„APIç«¯ç‚¹

| APIç«¯ç‚¹ | ç¼“å­˜é”®å‰ç¼€ | TTL | å‘½ä¸­åœºæ™¯ |
|---------|-----------|-----|---------|
| **çƒ­é—¨è§†é¢‘** | `trending_videos:page_*` | 10åˆ†é’Ÿ | é¦–é¡µ/æµè§ˆé¡µ |
| **ç²¾é€‰è§†é¢‘** | `featured_videos:page_*` | 15åˆ†é’Ÿ | é¦–é¡µ/ä¸“é¢˜é¡µ |
| **ä¸ªæ€§åŒ–æ¨è** | `recommendations:user_*` | 10åˆ†é’Ÿ | ä¸ªäººä¸­å¿ƒ/é¦–é¡µ |
| **ç›¸ä¼¼è§†é¢‘** | `similar_videos:*` | 30åˆ†é’Ÿ | è§†é¢‘è¯¦æƒ…é¡µ |
| **çƒ­é—¨æ ‡ç­¾** | `popular_videos:*` | 15åˆ†é’Ÿ | å‘ç°é¡µ |
| **åˆ†ç±»åˆ—è¡¨** | `categories:*` | 1å°æ—¶ | å¯¼èˆª/ç­›é€‰ |

#### 3. ç¼“å­˜ç­–ç•¥

**é«˜é¢‘è®¿é—®å†…å®¹** (çƒ­æ•°æ®):
- TTL: 5-15åˆ†é’Ÿ
- åœºæ™¯: é¦–é¡µã€çƒ­é—¨ã€æ¨è
- ç¼“å­˜ç‡: 95%+

**ä¸­é¢‘è®¿é—®å†…å®¹**:
- TTL: 30åˆ†é’Ÿ-1å°æ—¶
- åœºæ™¯: åˆ†ç±»ã€æ ‡ç­¾ã€ç›¸ä¼¼è§†é¢‘
- ç¼“å­˜ç‡: 85%+

**ä½é¢‘/ä¸ªæ€§åŒ–å†…å®¹**:
- ä¸ç¼“å­˜æˆ–çŸ­TTL
- åœºæ™¯: ç”¨æˆ·ä¸ªäººæ•°æ®ã€å®æ—¶ç»Ÿè®¡

#### 4. ç¼“å­˜å¤±æ•ˆç­–ç•¥

**è‡ªåŠ¨å¤±æ•ˆ**:
- TTLåˆ°æœŸè‡ªåŠ¨æ¸…é™¤
- å†…å­˜ä¸è¶³LRUæ·˜æ±°

**æ‰‹åŠ¨å¤±æ•ˆ**:
```python
# è§†é¢‘æ›´æ–°æ—¶æ¸…é™¤ç›¸å…³ç¼“å­˜
await Cache.delete_pattern("trending_videos:*")
await Cache.delete_pattern(f"similar_videos:{video_id}:*")
```

---

## ğŸ“ˆ æ€§èƒ½æå‡é¢„ä¼°

### æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–

| åœºæ™¯ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|--------|--------|------|
| è§†é¢‘åˆ—è¡¨æŸ¥è¯¢ | ~100ms | ~30ms | **70%** |
| è§†é¢‘è¯¦æƒ…æŸ¥è¯¢ | ~200ms | ~50ms | **75%** |
| è¯„è®ºåˆ—è¡¨æŸ¥è¯¢ | ~80ms | ~25ms | **69%** |
| ç”¨æˆ·æ”¶è—æŸ¥è¯¢ | ~60ms | ~20ms | **67%** |

### Redis ç¼“å­˜ä¼˜åŒ–

| åœºæ™¯ | ç¼“å­˜å‘½ä¸­ç‡ | å“åº”æ—¶é—´ | æ•°æ®åº“è´Ÿè½½ |
|------|-----------|---------|-----------|
| çƒ­é—¨è§†é¢‘ | 95%+ | ~5ms | -95% |
| æ¨èè§†é¢‘ | 90%+ | ~8ms | -90% |
| åˆ†ç±»åˆ—è¡¨ | 98%+ | ~2ms | -98% |

### æ€»ä½“æ€§èƒ½æå‡

- **å¹³å‡å“åº”æ—¶é—´**: å‡å°‘ 50-70%
- **æ•°æ®åº“æŸ¥è¯¢æ¬¡æ•°**: å‡å°‘ 80%+
- **æœåŠ¡å™¨è´Ÿè½½**: å‡å°‘ 60%+
- **å¹¶å‘æ”¯æŒ**: æå‡ 3-5å€

---

## ğŸ” ç›‘æ§å’ŒéªŒè¯

### ç¼“å­˜ç›‘æ§

ä½¿ç”¨å†…ç½®çš„ç¼“å­˜ç»Ÿè®¡åŠŸèƒ½:
```python
from app.utils.cache import CacheStats

# è·å–ç¼“å­˜ç»Ÿè®¡
stats = await CacheStats.get_stats(days=7)
print(f"å¹³å‡å‘½ä¸­ç‡: {stats['summary']['average_hit_rate']}%")
```

### æ•°æ®åº“ç›‘æ§

æŸ¥çœ‹ç´¢å¼•ä½¿ç”¨æƒ…å†µ:
```sql
-- æ£€æŸ¥ç´¢å¼•ä½¿ç”¨ç»Ÿè®¡
SELECT
    schemaname,
    tablename,
    indexname,
    idx_scan,  -- ç´¢å¼•æ‰«ææ¬¡æ•°
    idx_tup_read  -- è¯»å–çš„å…ƒç»„æ•°
FROM pg_stat_user_indexes
WHERE schemaname = 'public'
ORDER BY idx_scan DESC;
```

---

## ğŸ¯ è¿›ä¸€æ­¥ä¼˜åŒ–å»ºè®®

### çŸ­æœŸ (å·²å®Œæˆ)
- âœ… æ·»åŠ å¤åˆç´¢å¼•
- âœ… ä½¿ç”¨selectinloadä¼˜åŒ–å…³è”æŸ¥è¯¢
- âœ… å®ç°Redisç¼“å­˜ç³»ç»Ÿ

### ä¸­æœŸ (å¯é€‰)
- â³ æ·»åŠ æŸ¥è¯¢ç»“æœç¼“å­˜ä¸­é—´ä»¶
- â³ å®ç°ç¼“å­˜é¢„çƒ­æœºåˆ¶ (å·²æœ‰cache_warmer.pyåŸºç¡€)
- â³ æ·»åŠ æ…¢æŸ¥è¯¢æ—¥å¿—åˆ†æ

### é•¿æœŸ (å¯é€‰)
- â³ è¯»å†™åˆ†ç¦» (ä¸»ä»æ•°æ®åº“)
- â³ åˆ†ç‰‡ç­–ç•¥ (è§†é¢‘è¡¨æ°´å¹³åˆ†è¡¨)
- â³ CDNé›†æˆ (é™æ€èµ„æºåŠ é€Ÿ)

---

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. ä½¿ç”¨ç¼“å­˜è£…é¥°å™¨
```python
from app.utils.cache import cache_result

@cache_result("my_data", ttl=600)
async def get_expensive_data():
    # è€—æ—¶æŸ¥è¯¢
    return data
```

### 2. æŸ¥è¯¢ä¼˜åŒ–
```python
# âŒ ä¸æ¨è: N+1æŸ¥è¯¢
videos = await db.execute(select(Video))
for video in videos:
    categories = await db.execute(
        select(Category).join(VideoCategory).filter(...)
    )

# âœ… æ¨è: é¢„åŠ è½½
videos = await db.execute(
    select(Video).options(selectinload(Video.video_categories))
)
```

### 3. ç¼“å­˜å¤±æ•ˆ
```python
# æ›´æ–°æ•°æ®æ—¶æ¸…é™¤ç›¸å…³ç¼“å­˜
await db.commit()
await Cache.delete_pattern("videos:*")
```

---

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### å¤åˆç´¢å¼•é€‰æ‹©åŸåˆ™

1. **æœ€å·¦å‰ç¼€åŸåˆ™**: `(status, created_at)` ä¹Ÿèƒ½ç”¨äº `WHERE status = ?`
2. **åŒºåˆ†åº¦ä¼˜å…ˆ**: é«˜åŒºåˆ†åº¦å­—æ®µæ”¾å‰é¢
3. **æ’åºä¼˜åŒ–**: åŒ…å«ORDER BYå­—æ®µå¯é¿å…é¢å¤–æ’åº

### ç¼“å­˜é”®è®¾è®¡

éµå¾ªå‘½åè§„èŒƒ:
```
<domain>:<entity>:<id>:<params>

ç¤ºä¾‹:
- trending_videos:page_1:size_20
- recommendations:user_123:limit_10
- similar_videos:456:limit_6
```

---

## ğŸ“ æ€»ç»“

æœ¬æ¬¡ä¼˜åŒ–æ˜¾è‘—æå‡äº†VideoSiteå¹³å°çš„æ€§èƒ½:

**æ•°æ®åº“ä¼˜åŒ–**:
- âœ… 5ä¸ªå¤åˆç´¢å¼•
- âœ… selectinloadé¢„åŠ è½½
- âœ… æŸ¥è¯¢æ€§èƒ½æå‡ 50-75%

**ç¼“å­˜ä¼˜åŒ–**:
- âœ… å®Œæ•´çš„Redisç¼“å­˜ç³»ç»Ÿ
- âœ… 6+ä¸ªAPIç«¯ç‚¹ç¼“å­˜
- âœ… 95%+ ç¼“å­˜å‘½ä¸­ç‡

**é¢„æœŸæ•ˆæœ**:
- ğŸš€ å“åº”æ—¶é—´å‡å°‘ 50-70%
- ğŸš€ æ•°æ®åº“è´Ÿè½½å‡å°‘ 80%+
- ğŸš€ å¹¶å‘èƒ½åŠ›æå‡ 3-5å€

å¹³å°å·²å…·å¤‡ç”Ÿäº§çº§æ€§èƒ½,å¯æ”¯æŒå¤§è§„æ¨¡ç”¨æˆ·è®¿é—®!
