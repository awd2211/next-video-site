# è§†é¢‘è½¬ç å’Œå¤šåˆ†è¾¨ç‡ç³»ç»Ÿ - å®Œæ•´è®¾è®¡æ–‡æ¡£

## ğŸ“‹ æ–‡æ¡£æ¦‚è¿°

**åŠŸèƒ½åç§°**: è§†é¢‘è½¬ç å’Œå¤šåˆ†è¾¨ç‡æ’­æ”¾ç³»ç»Ÿ (æ”¯æŒ2K/4K + å¹¶è¡Œè½¬ç )
**ä¼˜å…ˆçº§**: P1 (é«˜ä¼˜å…ˆçº§)
**é¢„è®¡å¼€å‘æ—¶é—´**: 4-5å‘¨
**æŠ€æœ¯å¤æ‚åº¦**: â­â­â­â­â­ (éå¸¸é«˜)
**èµ„æºéœ€æ±‚**: CPU/GPUå¯†é›†å‹ + å­˜å‚¨å¯†é›†å‹

**æ ¸å¿ƒç‰¹æ€§**:
- âœ… æ”¯æŒ2K (2560Ã—1440) å’Œ 4K (3840Ã—2160) é«˜æ¸…è§†é¢‘
- âœ… å¤šè§†é¢‘å¹¶è¡Œè½¬ç  (8-20ä¸ªè§†é¢‘åŒæ—¶å¤„ç†)
- âœ… è¾¹ä¸Šä¼ è¾¹è½¬ç  (é›¶ç­‰å¾…)
- âœ… GPUåŠ é€Ÿ (é€Ÿåº¦æå‡10å€)
- âœ… H.265 (HEVC) ç¼–ç  (èŠ‚çœ50%å¸¦å®½)

---

## ğŸ¯ åŠŸèƒ½ç›®æ ‡

### æ ¸å¿ƒéœ€æ±‚
1. **è‡ªåŠ¨è½¬ç **: è§†é¢‘ä¸Šä¼ åè‡ªåŠ¨è½¬æ¢ä¸º6ä¸ªåˆ†è¾¨ç‡ (360p â†’ 480p â†’ 720p â†’ 1080p â†’ 2K â†’ 4K)
2. **å¹¶è¡Œå¤„ç†**: æ”¯æŒ8-20ä¸ªè§†é¢‘åŒæ—¶è½¬ç ,æ— éœ€æ’é˜Ÿç­‰å¾…
3. **è¾¹ä¼ è¾¹è½¬**: ä¸Šä¼ å®Œæˆç«‹å³å¼€å§‹è½¬ç ,é›¶å»¶è¿Ÿ
4. **æ™ºèƒ½åˆ†è¾¨ç‡**: æ ¹æ®æºè§†é¢‘åˆ†è¾¨ç‡è‡ªåŠ¨é€‰æ‹©è½¬ç æ¡£ä½
5. **æµåª’ä½“æ”¯æŒ**: æ”¯æŒHLSè‡ªé€‚åº”ç ç‡æµåª’ä½“
6. **æ’­æ”¾å™¨å¢å¼º**: ç”¨æˆ·å¯æ‰‹åŠ¨/è‡ªåŠ¨åˆ‡æ¢æ¸…æ™°åº¦ (å«4Ké€‰é¡¹)
7. **GPUåŠ é€Ÿ**: æ”¯æŒNVIDIA/Intel/AMD GPUç¡¬ä»¶åŠ é€Ÿ
8. **é«˜æ•ˆç¼–ç **: ä½¿ç”¨H.265 (HEVC) èŠ‚çœ50%å¸¦å®½å’Œå­˜å‚¨ç©ºé—´
9. **é¢„è§ˆå›¾ç”Ÿæˆ**: è‡ªåŠ¨ç”Ÿæˆç¼©ç•¥å›¾å’Œæ—¶é—´è½´é¢„è§ˆå›¾

### ä¸šåŠ¡ä»·å€¼
- ğŸ“± **ç§»åŠ¨å‹å¥½**: ä½åˆ†è¾¨ç‡èŠ‚çœæµé‡,360pé€‚é…3Gç½‘ç»œ
- ğŸš€ **åŠ è½½é€Ÿåº¦**: è‡ªé€‚åº”ç ç‡æå‡è§‚çœ‹ä½“éªŒ,å‡å°‘ç¼“å†²
- ğŸ’¾ **å­˜å‚¨ä¼˜åŒ–**: HEVCç¼–ç èŠ‚çœ50%æˆæœ¬,4Kè§†é¢‘ä»…å 25GB/å°æ—¶
- ğŸ“Š **ç”¨æˆ·ä½“éªŒ**: 4Kè¶…é«˜æ¸…ç”»è´¨,æµç•…æ’­æ”¾æ— å¡é¡¿
- âš¡ **é«˜æ•ˆå¤„ç†**: å¹¶è¡Œè½¬ç æå‡10å€ååé‡,ç®¡ç†å‘˜æ— éœ€ç­‰å¾…
- ğŸ’° **æˆæœ¬èŠ‚çœ**: GPUåŠ é€Ÿå‡å°‘70%è½¬ç æ—¶é—´,é™ä½è®¡ç®—æˆæœ¬

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### æ•´ä½“æ¶æ„å›¾ (æ”¯æŒå¹¶è¡Œè½¬ç  + è¾¹ä¼ è¾¹è½¬)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ç®¡ç†å‘˜åå° - åˆ†ç‰‡ä¸Šä¼  (æ”¯æŒæ–­ç‚¹ç»­ä¼ )                    â”‚
â”‚  ä¸Šä¼ è§†é¢‘A (4K, 3GB) â”€â”€â”                                             â”‚
â”‚  ä¸Šä¼ è§†é¢‘B (2K, 2GB) â”€â”€â”¼â”€â†’ å¹¶è¡Œä¸Šä¼                                  â”‚
â”‚  ä¸Šä¼ è§†é¢‘C (1080p, 1GB)â”€â”˜                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚ 5MB åˆ†ç‰‡ä¸Šä¼ 
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       FastAPI - åˆ†ç‰‡ä¸Šä¼ API (backend/app/admin/upload.py)            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  complete_multipart_upload() - ä¸Šä¼ å®Œæˆé’©å­                  â”‚   â”‚
â”‚  â”‚  1. åˆå¹¶æ‰€æœ‰åˆ†ç‰‡                                              â”‚   â”‚
â”‚  â”‚  2. ä¸Šä¼ åˆ°MinIO                                               â”‚   â”‚
â”‚  â”‚  3. âœ¨ ç«‹å³è§¦å‘è½¬ç ä»»åŠ¡ (æ— éœ€ç­‰å¾…) âœ¨                        â”‚   â”‚
â”‚  â”‚     transcode_video_task.delay(video_id, source_url)          â”‚   â”‚
â”‚  â”‚  4. ç§’çº§è¿”å›HTTP 200 (è½¬ç åœ¨åå°è¿›è¡Œ)                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚ Celeryä»»åŠ¡ (å¼‚æ­¥)
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            Redis - ä»»åŠ¡é˜Ÿåˆ— (æ”¯æŒä¼˜å…ˆçº§å’Œå¹¶å‘æ§åˆ¶)                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  é«˜ä¼˜å…ˆçº§é˜Ÿåˆ— (high_priority):  4Kè§†é¢‘è½¬ç ä»»åŠ¡              â”‚   â”‚
â”‚  â”‚  æ™®é€šé˜Ÿåˆ— (normal):             1080p/2Kè½¬ç ä»»åŠ¡            â”‚   â”‚
â”‚  â”‚  ä½ä¼˜å…ˆçº§é˜Ÿåˆ— (low_priority):   ç¼©ç•¥å›¾ç”Ÿæˆä»»åŠ¡              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
    â”‚         â”‚         â”‚         â”‚         â”‚         â”‚          â”‚
    â”‚         â”‚         â”‚         â”‚         â”‚         â”‚          â”‚
    â–¼         â–¼         â–¼         â–¼         â–¼         â–¼          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Worker â”‚â”‚ Worker â”‚â”‚ Worker â”‚â”‚ Worker â”‚â”‚ Worker â”‚â”‚ Worker â”‚â”‚ Worker â”‚
â”‚   #1   â”‚â”‚   #2   â”‚â”‚   #3   â”‚â”‚   #4   â”‚â”‚   #5   â”‚â”‚   #6   â”‚â”‚   #7   â”‚
â”‚ 4Kè½¬ç  â”‚â”‚ 2Kè½¬ç  â”‚â”‚1080pè½¬ç â”‚â”‚ 720pè½¬ç â”‚â”‚ 480pè½¬ç â”‚â”‚ 360pè½¬ç â”‚â”‚ç¼©ç•¥å›¾  â”‚
â”‚ (GPU)  â”‚â”‚ (GPU)  â”‚â”‚ (GPU)  â”‚â”‚ (CPU)  â”‚â”‚ (CPU)  â”‚â”‚ (CPU)  â”‚â”‚ (CPU)  â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
    â”‚         â”‚         â”‚         â”‚         â”‚         â”‚          â”‚
    â”‚         â”‚         â”‚         â”‚         â”‚         â”‚          â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚         â”‚         â”‚         â”‚         â”‚
         â–¼         â–¼         â–¼         â–¼         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Celery Worker - FFmpegè½¬ç å¼•æ“                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  æ™ºèƒ½åˆ†è¾¨ç‡ç­–ç•¥:                                              â”‚   â”‚
â”‚  â”‚    â€¢ 4Kæº (3840Ã—2160) â†’ è½¬ç : 2K, 1080p, 720p, 480p, 360p   â”‚   â”‚
â”‚  â”‚    â€¢ 2Kæº (2560Ã—1440) â†’ è½¬ç : 1080p, 720p, 480p, 360p       â”‚   â”‚
â”‚  â”‚    â€¢ 1080pæº          â†’ è½¬ç : 720p, 480p, 360p              â”‚   â”‚
â”‚  â”‚    â€¢ 720pæº           â†’ è½¬ç : 480p, 360p                     â”‚   â”‚
â”‚  â”‚                                                               â”‚   â”‚
â”‚  â”‚  ç¼–ç å™¨é€‰æ‹©:                                                  â”‚   â”‚
â”‚  â”‚    â€¢ 4K/2K: hevc_nvenc (H.265 GPUåŠ é€Ÿ, èŠ‚çœ50%å¸¦å®½)         â”‚   â”‚
â”‚  â”‚    â€¢ 1080p: h264_nvenc (H.264 GPUåŠ é€Ÿ)                       â”‚   â”‚
â”‚  â”‚    â€¢ 720pä»¥ä¸‹: libx264 (CPUç¼–ç , ä½ä¼˜å…ˆçº§)                   â”‚   â”‚
â”‚  â”‚                                                               â”‚   â”‚
â”‚  â”‚  å¹¶å‘ç­–ç•¥:                                                    â”‚   â”‚
â”‚  â”‚    â€¢ ä½¿ç”¨ThreadPoolExecutorå¹¶è¡Œè½¬ç å¤šä¸ªåˆ†è¾¨ç‡                â”‚   â”‚
â”‚  â”‚    â€¢ GPU workerå¹¶å‘æ•°: 8-12 (å–å†³äºæ˜¾å­˜)                     â”‚   â”‚
â”‚  â”‚    â€¢ CPU workerå¹¶å‘æ•°: 4-8 (å–å†³äºæ ¸å¿ƒæ•°)                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚ è½¬ç å®Œæˆ
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    MinIO - å¯¹è±¡å­˜å‚¨ (S3å…¼å®¹)                         â”‚
â”‚  videos/                                                              â”‚
â”‚  â”œâ”€â”€ {video_id}/                                                     â”‚
â”‚  â”‚   â”œâ”€â”€ original/                                                   â”‚
â”‚  â”‚   â”‚   â””â”€â”€ source.mp4               (åŸå§‹æ–‡ä»¶, å¯é€‰ä¿ç•™)          â”‚
â”‚  â”‚   â”œâ”€â”€ hls/                                                        â”‚
â”‚  â”‚   â”‚   â”œâ”€â”€ master.m3u8               (ä¸»æ’­æ”¾åˆ—è¡¨ - å«æ‰€æœ‰åˆ†è¾¨ç‡)  â”‚
â”‚  â”‚   â”‚   â”œâ”€â”€ 4K/                       (3840Ã—2160)                  â”‚
â”‚  â”‚   â”‚   â”‚   â”œâ”€â”€ index.m3u8            (4Kæ’­æ”¾åˆ—è¡¨)                 â”‚
â”‚  â”‚   â”‚   â”‚   â””â”€â”€ segment_*.ts          (6ç§’åˆ‡ç‰‡, HEVCç¼–ç )          â”‚
â”‚  â”‚   â”‚   â”œâ”€â”€ 2K/                       (2560Ã—1440)                  â”‚
â”‚  â”‚   â”‚   â”‚   â”œâ”€â”€ index.m3u8                                          â”‚
â”‚  â”‚   â”‚   â”‚   â””â”€â”€ segment_*.ts          (HEVCç¼–ç )                   â”‚
â”‚  â”‚   â”‚   â”œâ”€â”€ 1080p/                    (1920Ã—1080)                  â”‚
â”‚  â”‚   â”‚   â”‚   â”œâ”€â”€ index.m3u8                                          â”‚
â”‚  â”‚   â”‚   â”‚   â””â”€â”€ segment_*.ts          (H.264ç¼–ç )                  â”‚
â”‚  â”‚   â”‚   â”œâ”€â”€ 720p/  â”œâ”€â”€ 480p/  â””â”€â”€ 360p/                           â”‚
â”‚  â”‚   â””â”€â”€ thumbnails/                                                 â”‚
â”‚  â”‚       â”œâ”€â”€ poster.jpg                (å°é¢ - ç¬¬5ç§’æˆªå›¾)           â”‚
â”‚  â”‚       â”œâ”€â”€ thumb_0001.jpg            (æ—¶é—´è½´ç¼©ç•¥å›¾ - æ¯10ç§’)      â”‚
â”‚  â”‚       â””â”€â”€ thumb_*.jpg                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              PostgreSQL - æ•°æ®åº“ (ä»»åŠ¡çŠ¶æ€è¿½è¸ª)                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  transcoding_tasks è¡¨:                                        â”‚   â”‚
â”‚  â”‚    - video_id: 123                                            â”‚   â”‚
â”‚  â”‚    - status: 'processing'                                     â”‚   â”‚
â”‚  â”‚    - progress: 65                        (å®æ—¶è¿›åº¦ 0-100)     â”‚   â”‚
â”‚  â”‚    - current_step: 'transcoding_1080p'                        â”‚   â”‚
â”‚  â”‚    - source_resolution: '3840x2160'      (4Kæº)               â”‚   â”‚
â”‚  â”‚    - resolutions: {                                           â”‚   â”‚
â”‚  â”‚         "4K": "videos/123/hls/4K/index.m3u8",                â”‚   â”‚
â”‚  â”‚         "2K": "videos/123/hls/2K/index.m3u8",                â”‚   â”‚
â”‚  â”‚         "1080p": "videos/123/hls/1080p/index.m3u8"           â”‚   â”‚
â”‚  â”‚      }                                                         â”‚   â”‚
â”‚  â”‚    - master_playlist_url: "videos/123/hls/master.m3u8"       â”‚   â”‚
â”‚  â”‚    - encoding_preset: 'medium'                                â”‚   â”‚
â”‚  â”‚    - hdr_support: true                   (æ”¯æŒHDR)            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Video.js HLS Player - å‰ç«¯æ’­æ”¾å™¨ (æ”¯æŒ4K + HDR)             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  1. åŠ è½½ master.m3u8 (åŒ…å«6ä¸ªåˆ†è¾¨ç‡é€‰é¡¹)                     â”‚   â”‚
â”‚  â”‚  2. æ£€æµ‹ç½‘é€Ÿè‡ªåŠ¨é€‰æ‹©åˆ†è¾¨ç‡ (ABR - è‡ªé€‚åº”ç ç‡)                â”‚   â”‚
â”‚  â”‚     â€¢ 100Mbps+ â†’ 4K                                          â”‚   â”‚
â”‚  â”‚     â€¢ 50Mbps â†’ 2K                                            â”‚   â”‚
â”‚  â”‚     â€¢ 20Mbps â†’ 1080p                                         â”‚   â”‚
â”‚  â”‚     â€¢ 5Mbps â†’ 720p                                           â”‚   â”‚
â”‚  â”‚     â€¢ 2Mbps â†’ 480p                                           â”‚   â”‚
â”‚  â”‚     â€¢ <2Mbps â†’ 360p                                          â”‚   â”‚
â”‚  â”‚  3. æ‰‹åŠ¨æ¸…æ™°åº¦èœå•: [4K] [2K] [1080p] [720p] [480p] [360p]  â”‚   â”‚
â”‚  â”‚  4. HDRæ”¯æŒ (å¦‚æœè®¾å¤‡æ”¯æŒ)                                   â”‚   â”‚
â”‚  â”‚  5. è¿›åº¦æ¡é¢„è§ˆå›¾ (æ‚¬åœæ˜¾ç¤ºç¼©ç•¥å›¾)                            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å¹¶è¡Œå¤„ç†æ—¶é—´çº¿ç¤ºä¾‹**:
```
æ—¶é—´  â”‚ è§†é¢‘A (4K, 3GB)      â”‚ è§†é¢‘B (2K, 2GB)      â”‚ è§†é¢‘C (1080p, 1GB)
â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
00:00 â”‚ å¼€å§‹ä¸Šä¼              â”‚                      â”‚
00:10 â”‚ ä¸Šä¼ å®Œæˆ             â”‚ å¼€å§‹ä¸Šä¼              â”‚
00:10 â”‚ âœ¨è½¬ç å¼€å§‹ (Worker#1)â”‚                      â”‚
00:20 â”‚ è½¬ç ä¸­ (40%)         â”‚ ä¸Šä¼ å®Œæˆ             â”‚ å¼€å§‹ä¸Šä¼ 
00:20 â”‚                      â”‚ âœ¨è½¬ç å¼€å§‹ (Worker#2)â”‚
00:25 â”‚                      â”‚                      â”‚ ä¸Šä¼ å®Œæˆ
00:25 â”‚                      â”‚                      â”‚ âœ¨è½¬ç å¼€å§‹ (Worker#3)
00:40 â”‚ è½¬ç å®Œæˆ âœ…          â”‚ è½¬ç ä¸­ (60%)         â”‚ è½¬ç ä¸­ (80%)
00:50 â”‚                      â”‚ è½¬ç å®Œæˆ âœ…          â”‚ è½¬ç å®Œæˆ âœ…

æ€»ç»“: 3ä¸ªè§†é¢‘åœ¨50åˆ†é’Ÿå†…å…¨éƒ¨å®Œæˆ (ä¸²è¡Œéœ€è¦2å°æ—¶+)
å¹¶å‘æå‡: 2.4å€æ•ˆç‡
```

---

## ğŸ’¾ æ•°æ®åº“è®¾è®¡

### 1. æ–°å¢è¡¨ï¼štranscoding_tasks (æ‰©å±•ç‰ˆ - æ”¯æŒ2K/4K)

```sql
CREATE TABLE transcoding_tasks (
    id SERIAL PRIMARY KEY,
    video_id INTEGER NOT NULL REFERENCES videos(id) ON DELETE CASCADE,
    status VARCHAR(20) NOT NULL DEFAULT 'pending',
    -- çŠ¶æ€: pending, processing, completed, failed, queued

    progress INTEGER DEFAULT 0,
    -- è½¬ç è¿›åº¦ 0-100

    current_step VARCHAR(50),
    -- å½“å‰æ­¥éª¤: analyzing, transcoding_4k, transcoding_2k, generating_hls, etc.

    source_resolution VARCHAR(20),
    -- æºè§†é¢‘åˆ†è¾¨ç‡ ä¾‹å¦‚: "3840x2160" (4K), "2560x1440" (2K), "1920x1080" (1080p)
    -- âœ¨ æ–°å¢å­—æ®µ - ç”¨äºæ™ºèƒ½å†³å®šè½¬ç æ¡£ä½

    source_codec VARCHAR(20),
    -- æºè§†é¢‘ç¼–ç  ä¾‹å¦‚: "h264", "hevc", "vp9"
    -- âœ¨ æ–°å¢å­—æ®µ

    source_bitrate BIGINT,
    -- æºè§†é¢‘ç ç‡ (bps)
    -- âœ¨ æ–°å¢å­—æ®µ

    resolutions JSONB DEFAULT '{}',
    -- å·²å®Œæˆçš„åˆ†è¾¨ç‡å’ŒURL (æ‰©å±•åˆ°6ä¸ªåˆ†è¾¨ç‡)
    -- ç¤ºä¾‹: {
    --   "4K": "videos/123/hls/4K/index.m3u8",
    --   "2K": "videos/123/hls/2K/index.m3u8",
    --   "1080p": "videos/123/hls/1080p/index.m3u8",
    --   "720p": "videos/123/hls/720p/index.m3u8",
    --   "480p": "videos/123/hls/480p/index.m3u8",
    --   "360p": "videos/123/hls/360p/index.m3u8"
    -- }

    master_playlist_url TEXT,
    -- HLSä¸»æ’­æ”¾åˆ—è¡¨URL (åŒ…å«æ‰€æœ‰åˆ†è¾¨ç‡)

    thumbnail_urls JSONB DEFAULT '[]',
    -- ç¼©ç•¥å›¾URLåˆ—è¡¨

    poster_url TEXT,
    -- å°é¢å›¾URL

    original_file_url TEXT,
    -- åŸå§‹è§†é¢‘æ–‡ä»¶URL

    original_size BIGINT,
    -- åŸå§‹æ–‡ä»¶å¤§å°(å­—èŠ‚)

    total_transcoded_size BIGINT,
    -- è½¬ç åæ€»å¤§å°(å­—èŠ‚) - æ‰€æœ‰åˆ†è¾¨ç‡æ€»å’Œ

    duration FLOAT,
    -- è§†é¢‘æ—¶é•¿(ç§’)

    fps FLOAT,
    -- å¸§ç‡
    -- âœ¨ æ–°å¢å­—æ®µ

    encoding_preset VARCHAR(20) DEFAULT 'medium',
    -- FFmpegç¼–ç é¢„è®¾: ultrafast, superfast, veryfast, faster, fast, medium, slow, slower, veryslow
    -- âœ¨ æ–°å¢å­—æ®µ

    hdr_support BOOLEAN DEFAULT FALSE,
    -- æ˜¯å¦æ”¯æŒHDR (High Dynamic Range)
    -- âœ¨ æ–°å¢å­—æ®µ - 4Kè§†é¢‘å¯èƒ½éœ€è¦HDR

    color_space VARCHAR(20),
    -- è‰²å½©ç©ºé—´: bt709 (HD), bt2020 (4K HDR)
    -- âœ¨ æ–°å¢å­—æ®µ

    gpu_accelerated BOOLEAN DEFAULT FALSE,
    -- æ˜¯å¦ä½¿ç”¨GPUåŠ é€Ÿ
    -- âœ¨ æ–°å¢å­—æ®µ

    gpu_type VARCHAR(50),
    -- GPUç±»å‹: nvidia_nvenc, intel_qsv, amd_vce, apple_videotoolbox
    -- âœ¨ æ–°å¢å­—æ®µ

    transcoding_time_seconds INTEGER,
    -- å®é™…è½¬ç è€—æ—¶(ç§’)
    -- âœ¨ æ–°å¢å­—æ®µ - ç”¨äºæ€§èƒ½åˆ†æ

    worker_id VARCHAR(100),
    -- å¤„ç†è¯¥ä»»åŠ¡çš„worker ID
    -- âœ¨ æ–°å¢å­—æ®µ - ç”¨äºå¹¶å‘è°ƒè¯•

    priority INTEGER DEFAULT 5,
    -- ä»»åŠ¡ä¼˜å…ˆçº§: 1-10 (10æœ€é«˜) - 4Kè§†é¢‘å¯è®¾ç½®æ›´é«˜ä¼˜å…ˆçº§
    -- âœ¨ æ–°å¢å­—æ®µ

    error_message TEXT,
    -- é”™è¯¯ä¿¡æ¯

    error_stack TEXT,
    -- å®Œæ•´é”™è¯¯å †æ ˆ
    -- âœ¨ æ–°å¢å­—æ®µ

    retry_count INTEGER DEFAULT 0,
    -- é‡è¯•æ¬¡æ•°

    max_retries INTEGER DEFAULT 3,
    -- æœ€å¤§é‡è¯•æ¬¡æ•°
    -- âœ¨ æ–°å¢å­—æ®µ

    started_at TIMESTAMP WITH TIME ZONE,
    -- å¼€å§‹æ—¶é—´

    completed_at TIMESTAMP WITH TIME ZONE,
    -- å®Œæˆæ—¶é—´

    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),

    CONSTRAINT unique_video_task UNIQUE(video_id)
);

-- ç´¢å¼• (ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½)
CREATE INDEX idx_transcoding_status ON transcoding_tasks(status);
CREATE INDEX idx_transcoding_video ON transcoding_tasks(video_id);
CREATE INDEX idx_transcoding_created ON transcoding_tasks(created_at DESC);
CREATE INDEX idx_transcoding_priority ON transcoding_tasks(priority DESC, created_at);
CREATE INDEX idx_transcoding_worker ON transcoding_tasks(worker_id);
CREATE INDEX idx_transcoding_resolution ON transcoding_tasks(source_resolution);

-- è‡ªåŠ¨æ›´æ–° updated_at è§¦å‘å™¨
CREATE OR REPLACE FUNCTION update_transcoding_tasks_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_update_transcoding_tasks_updated_at
BEFORE UPDATE ON transcoding_tasks
FOR EACH ROW
EXECUTE FUNCTION update_transcoding_tasks_updated_at();

-- æ³¨é‡Š
COMMENT ON TABLE transcoding_tasks IS 'è§†é¢‘è½¬ç ä»»åŠ¡è¡¨ - æ”¯æŒ2K/4Kå’Œå¹¶è¡Œè½¬ç ';
COMMENT ON COLUMN transcoding_tasks.source_resolution IS 'æºè§†é¢‘åˆ†è¾¨ç‡,ç”¨äºæ™ºèƒ½å†³å®šè½¬ç æ¡£ä½';
COMMENT ON COLUMN transcoding_tasks.hdr_support IS 'æ˜¯å¦æ”¯æŒHDR,4Kè§†é¢‘å¸¸ç”¨';
COMMENT ON COLUMN transcoding_tasks.gpu_accelerated IS 'æ˜¯å¦ä½¿ç”¨GPUåŠ é€Ÿ,æå‡10å€é€Ÿåº¦';
COMMENT ON COLUMN transcoding_tasks.priority IS 'ä»»åŠ¡ä¼˜å…ˆçº§,4Kè§†é¢‘å»ºè®®è®¾ç½®ä¸º8-10';
```

### 2. æ‰©å±• videos è¡¨

```sql
ALTER TABLE videos
ADD COLUMN has_hls BOOLEAN DEFAULT FALSE,
ADD COLUMN hls_master_url TEXT,
ADD COLUMN available_resolutions TEXT[] DEFAULT '{}',
ADD COLUMN transcoding_status VARCHAR(20) DEFAULT 'pending';

-- ç´¢å¼•
CREATE INDEX idx_videos_transcoding_status ON videos(transcoding_status);
```

---

## ğŸ”§ æŠ€æœ¯é€‰å‹

### 1. FFmpeg

**é€‰æ‹©åŸå› **:
- ä¸šç•Œæ ‡å‡†çš„å¼€æºè§†é¢‘å¤„ç†å·¥å…·
- æ”¯æŒå‡ ä¹æ‰€æœ‰è§†é¢‘æ ¼å¼
- é«˜æ€§èƒ½ï¼ŒGPUåŠ é€Ÿæ”¯æŒ
- ä¸°å¯Œçš„è¿‡æ»¤å™¨å’Œç¼–ç é€‰é¡¹

**ç‰ˆæœ¬è¦æ±‚**: >= 4.4

**å…³é”®å‚æ•°**:
```bash
# H.264ç¼–ç å™¨: libx264 (CPU) æˆ– h264_nvenc (GPU)
# éŸ³é¢‘ç¼–ç å™¨: aac
# å®¹å™¨æ ¼å¼: MP4 (ä¸‹è½½) / HLS (æµåª’ä½“)
```

### 2. Celery (å¹¶å‘ä»»åŠ¡é˜Ÿåˆ—)

**é€‰æ‹©åŸå› **:
- Pythonå¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ—æ ‡å‡†æ–¹æ¡ˆ
- âœ¨ æ”¯æŒå¤šworkerå¹¶è¡Œæ‰§è¡Œ (8-20ä¸ªè§†é¢‘åŒæ—¶è½¬ç )
- âœ¨ æ”¯æŒä»»åŠ¡ä¼˜å…ˆçº§é˜Ÿåˆ— (4Kè§†é¢‘ä¼˜å…ˆå¤„ç†)
- æ”¯æŒè‡ªåŠ¨é‡è¯•å’Œé”™è¯¯æ¢å¤
- åˆ†å¸ƒå¼æ‰§è¡Œï¼Œæ˜“äºæ‰©å±•
- ä¸°å¯Œçš„ç›‘æ§å·¥å…· (Flower)

**å¹¶å‘é…ç½®** (æ”¯æŒ20ä¸ªå¹¶å‘ä»»åŠ¡):
```python
# backend/app/core/celery_config.py

from celery import Celery
from kombu import Queue, Exchange

# åˆå§‹åŒ–Celery
celery_app = Celery('videosite')

# ===== æ ¸å¿ƒé…ç½® =====
celery_app.conf.update(
    # Redisä½œä¸ºæ¶ˆæ¯é˜Ÿåˆ—å’Œç»“æœå­˜å‚¨
    broker_url='redis://localhost:6379/0',
    result_backend='redis://localhost:6379/1',

    # ===== âœ¨ å¹¶å‘é…ç½® =====
    worker_concurrency=12,  # æ¯ä¸ªworkerè¿›ç¨‹12ä¸ªå¹¶å‘ä»»åŠ¡ (æ ¹æ®CPUæ ¸å¿ƒæ•°è°ƒæ•´)
    worker_prefetch_multiplier=1,  # æ¯æ¬¡åªé¢„å–1ä¸ªä»»åŠ¡,é¿å…workeré¥¿æ­»
    worker_max_tasks_per_child=50,  # æ¯ä¸ªworkerå¤„ç†50ä¸ªä»»åŠ¡åé‡å¯(é˜²æ­¢å†…å­˜æ³„æ¼)

    # ===== âœ¨ ä»»åŠ¡ä¼˜å…ˆçº§é˜Ÿåˆ— =====
    task_queues=(
        Queue('high_priority', Exchange('high_priority'), routing_key='high'),
        Queue('normal', Exchange('normal'), routing_key='normal'),
        Queue('low_priority', Exchange('low_priority'), routing_key='low'),
    ),
    task_default_queue='normal',
    task_default_exchange='normal',
    task_default_routing_key='normal',

    # ===== âœ¨ ä»»åŠ¡è·¯ç”±è§„åˆ™ =====
    task_routes={
        'transcode_4k': {'queue': 'high_priority', 'priority': 10},
        'transcode_2k': {'queue': 'high_priority', 'priority': 8},
        'transcode_1080p': {'queue': 'normal', 'priority': 6},
        'transcode_720p': {'queue': 'normal', 'priority': 4},
        'generate_thumbnails': {'queue': 'low_priority', 'priority': 2},
    },

    # ===== ä»»åŠ¡è¶…æ—¶é…ç½® =====
    task_time_limit=3600,  # ç¡¬è¶…æ—¶1å°æ—¶ (4Kè§†é¢‘å¯èƒ½éœ€è¦æ›´é•¿æ—¶é—´)
    task_soft_time_limit=3000,  # è½¯è¶…æ—¶50åˆ†é’Ÿ (å…ˆè­¦å‘Š)

    # ===== é‡è¯•é…ç½® =====
    task_autoretry_for=(Exception,),  # æ‰€æœ‰å¼‚å¸¸éƒ½è‡ªåŠ¨é‡è¯•
    task_retry_kwargs={'max_retries': 3, 'countdown': 300},  # æœ€å¤šé‡è¯•3æ¬¡,é—´éš”5åˆ†é’Ÿ
    task_retry_backoff=True,  # æŒ‡æ•°é€€é¿é‡è¯•
    task_retry_backoff_max=3600,  # æœ€å¤§é€€é¿æ—¶é—´1å°æ—¶

    # ===== åºåˆ—åŒ–é…ç½® =====
    task_serializer='json',
    accept_content=['json'],
    result_serializer='json',

    # ===== å…¶ä»–é…ç½® =====
    timezone='Asia/Shanghai',
    enable_utc=True,
    task_track_started=True,  # è·Ÿè¸ªä»»åŠ¡å¯åŠ¨çŠ¶æ€
    task_send_sent_event=True,  # å‘é€ä»»åŠ¡äº‹ä»¶
    worker_send_task_events=True,  # workerå‘é€äº‹ä»¶
    result_expires=86400,  # ç»“æœä¿ç•™24å°æ—¶
)

# ===== âœ¨ é€Ÿç‡é™åˆ¶ (é˜²æ­¢ç³»ç»Ÿè¿‡è½½) =====
celery_app.conf.task_annotations = {
    '*': {
        'rate_limit': '100/m',  # å…¨å±€æ¯åˆ†é’Ÿæœ€å¤š100ä¸ªä»»åŠ¡
    },
    'transcode_4k': {
        'rate_limit': '10/m',  # 4Kè½¬ç æ¯åˆ†é’Ÿæœ€å¤š10ä¸ª (èµ„æºå¯†é›†)
    },
    'transcode_2k': {
        'rate_limit': '20/m',
    },
}
```

**å¯åŠ¨å¤šä¸ªWorkerç¤ºä¾‹**:
```bash
# æ–¹å¼1: å•æœºå¤šworker (æ¨èå¼€å‘ç¯å¢ƒ)
celery -A app.tasks.transcoding multi start worker1 worker2 worker3 \
  --concurrency=8 \
  --loglevel=INFO \
  --logfile=/var/log/celery/%n%I.log \
  --pidfile=/var/run/celery/%n.pid

# æ–¹å¼2: å•workerå¤šå¹¶å‘ (æ¨èç”Ÿäº§ç¯å¢ƒ + GPU)
celery -A app.tasks.transcoding worker \
  --concurrency=12 \
  --loglevel=INFO \
  --max-tasks-per-child=50 \
  -Q high_priority,normal,low_priority

# æ–¹å¼3: åˆ†å¸ƒå¼é›†ç¾¤ (å¤§è§„æ¨¡éƒ¨ç½²)
# æœåŠ¡å™¨1: ä¸“é—¨å¤„ç†4K/2Ké«˜ä¼˜å…ˆçº§ä»»åŠ¡ (é…GPU)
celery -A app.tasks worker -Q high_priority --concurrency=8 --hostname=gpu_worker@%h

# æœåŠ¡å™¨2: å¤„ç†1080p/720pæ™®é€šä»»åŠ¡
celery -A app.tasks worker -Q normal --concurrency=16 --hostname=cpu_worker@%h

# æœåŠ¡å™¨3: å¤„ç†ç¼©ç•¥å›¾ç­‰è½»é‡ä»»åŠ¡
celery -A app.tasks worker -Q low_priority --concurrency=32 --hostname=light_worker@%h
```

**æ€§èƒ½å¯¹æ¯”**:
| å¹¶å‘æ•° | CPUä½¿ç”¨ç‡ | å†…å­˜ä½¿ç”¨ | æ¯å°æ—¶å¤„ç†è§†é¢‘æ•° | é€‚ç”¨åœºæ™¯ |
|--------|-----------|----------|-----------------|---------|
| 1 | 12% | 2GB | 3-5ä¸ª | æµ‹è¯•ç¯å¢ƒ |
| 4 | 50% | 8GB | 12-16ä¸ª | å°è§„æ¨¡ |
| 8 | 80% | 16GB | 24-32ä¸ª | ä¸­ç­‰è§„æ¨¡ (æ¨è) |
| 12 | 95% | 24GB | 36-48ä¸ª | å¤§è§„æ¨¡ |
| 20 (GPU) | 60% | 32GB | 60-80ä¸ª | è¶…å¤§è§„æ¨¡ + GPU |
```

### 3. Redis

**ç”¨é€”**:
- Celeryæ¶ˆæ¯é˜Ÿåˆ— (Broker)
- Celeryç»“æœå­˜å‚¨ (Backend)
- è½¬ç è¿›åº¦ç¼“å­˜
- ä»»åŠ¡é” (é˜²æ­¢é‡å¤è½¬ç )

### 4. MinIO

**å­˜å‚¨ç»“æ„**:
```
videos/
â”œâ”€â”€ {video_id}/
â”‚   â”œâ”€â”€ original/
â”‚   â”‚   â””â”€â”€ video.mp4
â”‚   â”œâ”€â”€ transcoded/
â”‚   â”‚   â”œâ”€â”€ 1080p/
â”‚   â”‚   â”œâ”€â”€ 720p/
â”‚   â”‚   â”œâ”€â”€ 480p/
â”‚   â”‚   â””â”€â”€ 360p/
â”‚   â”œâ”€â”€ hls/
â”‚   â”‚   â”œâ”€â”€ master.m3u8
â”‚   â”‚   â”œâ”€â”€ 1080p/
â”‚   â”‚   â”œâ”€â”€ 720p/
â”‚   â”‚   â”œâ”€â”€ 480p/
â”‚   â”‚   â””â”€â”€ 360p/
â”‚   â””â”€â”€ thumbnails/
â”‚       â”œâ”€â”€ poster.jpg
â”‚       â””â”€â”€ timeline_{timestamp}.jpg
```

### 5. Video.js + HLSæ’ä»¶

**å‰ç«¯æ’­æ”¾å™¨**:
```javascript
// æ’ä»¶
- video.js (æ ¸å¿ƒæ’­æ”¾å™¨)
- videojs-contrib-hls (HLSæ”¯æŒ)
- videojs-contrib-quality-levels (æ¸…æ™°åº¦åˆ‡æ¢)

// åŠŸèƒ½
- è‡ªé€‚åº”ç ç‡ (ABR)
- æ‰‹åŠ¨æ¸…æ™°åº¦åˆ‡æ¢
- ç¼“å†²ä¼˜åŒ–
- è¿›åº¦æ¡é¢„è§ˆå›¾
```

---

## ğŸ“ è½¬ç å‚æ•°é…ç½®

### åˆ†è¾¨ç‡å’Œç ç‡é…ç½® (æ‰©å±•åˆ°6æ¡£ - æ”¯æŒ2K/4K)

```python
TRANSCODING_PROFILES = {
    # âœ¨ 4K - è¶…é«˜æ¸… (ä½¿ç”¨H.265èŠ‚çœå¸¦å®½)
    "4K": {
        "resolution": "3840x2160",
        "video_bitrate": "25000k",  # 25Mbps
        "audio_bitrate": "256k",     # AAC 256kbps
        "fps": 60,                   # æ”¯æŒ60fpsé«˜å¸§ç‡
        "preset": "slow",            # æ…¢é€Ÿç¼–ç ä¿è¯è´¨é‡
        "crf": 20,                   # ä½CRFä¿è¯ç”»è´¨
        "codec": "hevc",             # H.265/HEVCç¼–ç 
        "gpu_encoder": "hevc_nvenc", # NVIDIA GPUåŠ é€Ÿ
        "profile": "main10",         # 10-bitè‰²æ·±
        "pixel_format": "yuv420p10le",
        "hdr": True,                 # æ”¯æŒHDR
        "color_space": "bt2020nc",   # å¹¿è‰²åŸŸ
        "color_transfer": "smpte2084",  # HDR10
        "max_bitrate": "30000k",
        "bufsize": "50000k",
    },

    # âœ¨ 2K - é«˜æ¸…+ (ä½¿ç”¨H.265èŠ‚çœå¸¦å®½)
    "2K": {
        "resolution": "2560x1440",
        "video_bitrate": "12000k",  # 12Mbps
        "audio_bitrate": "192k",
        "fps": 60,
        "preset": "medium",
        "crf": 21,
        "codec": "hevc",             # H.265
        "gpu_encoder": "hevc_nvenc",
        "profile": "main",
        "pixel_format": "yuv420p",
        "hdr": False,
        "max_bitrate": "15000k",
        "bufsize": "24000k",
    },

    # 1080p - å…¨é«˜æ¸…
    "1080p": {
        "resolution": "1920x1080",
        "video_bitrate": "5000k",   # 5Mbps
        "audio_bitrate": "192k",
        "fps": 30,
        "preset": "medium",
        "crf": 23,
        "codec": "h264",             # H.264 (å…¼å®¹æ€§æ›´å¥½)
        "gpu_encoder": "h264_nvenc",
        "profile": "high",
        "pixel_format": "yuv420p",
        "hdr": False,
        "max_bitrate": "5500k",
        "bufsize": "10000k",
    },

    # 720p - é«˜æ¸…
    "720p": {
        "resolution": "1280x720",
        "video_bitrate": "2500k",
        "audio_bitrate": "128k",
        "fps": 30,
        "preset": "medium",
        "crf": 23,
        "codec": "h264",
        "gpu_encoder": "h264_nvenc",
        "profile": "high",
        "pixel_format": "yuv420p",
        "hdr": False,
        "max_bitrate": "3000k",
        "bufsize": "5000k",
    },

    # 480p - æ ‡æ¸…
    "480p": {
        "resolution": "854x480",
        "video_bitrate": "1000k",
        "audio_bitrate": "96k",
        "fps": 30,
        "preset": "fast",
        "crf": 24,
        "codec": "h264",
        "gpu_encoder": "h264_nvenc",  # GPUä¹Ÿèƒ½å¤„ç†ä½åˆ†è¾¨ç‡
        "profile": "main",
        "pixel_format": "yuv420p",
        "hdr": False,
        "max_bitrate": "1200k",
        "bufsize": "2000k",
    },

    # 360p - æµç•… (ç§»åŠ¨ç½‘ç»œ)
    "360p": {
        "resolution": "640x360",
        "video_bitrate": "600k",
        "audio_bitrate": "64k",
        "fps": 30,
        "preset": "fast",
        "crf": 25,
        "codec": "h264",
        "gpu_encoder": None,  # 360pä½¿ç”¨CPUç¼–ç å³å¯
        "profile": "baseline",  # æœ€å¤§å…¼å®¹æ€§
        "pixel_format": "yuv420p",
        "hdr": False,
        "max_bitrate": "700k",
        "bufsize": "1200k",
    },
}

# HLSé…ç½®
HLS_CONFIG = {
    "segment_time": 6,  # æ¯ä¸ªåˆ‡ç‰‡6ç§’ (å»ºè®®4-10ç§’)
    "segment_format": "mpegts",
    "hls_list_size": 0,  # ä¿ç•™æ‰€æœ‰åˆ‡ç‰‡ (VODæ¨¡å¼)
    "hls_playlist_type": "vod",  # ç‚¹æ’­æ¨¡å¼
    "hls_segment_type": "mpegts",  # ä½¿ç”¨MPEG-TSå®¹å™¨
}

# GPUåŠ é€Ÿé…ç½®
GPU_CONFIG = {
    "nvidia": {
        "h264_encoder": "h264_nvenc",
        "hevc_encoder": "hevc_nvenc",
        "decode_hwaccel": "cuda",
        "required_vram": "4GB",  # æœ€å°æ˜¾å­˜è¦æ±‚
        "max_concurrent": 12,    # æœ€å¤§å¹¶å‘ä»»åŠ¡æ•°
    },
    "intel": {
        "h264_encoder": "h264_qsv",
        "hevc_encoder": "hevc_qsv",
        "decode_hwaccel": "qsv",
        "required_vram": "shared",
        "max_concurrent": 8,
    },
    "amd": {
        "h264_encoder": "h264_amf",
        "hevc_encoder": "hevc_amf",
        "decode_hwaccel": "dxva2",
        "required_vram": "4GB",
        "max_concurrent": 10,
    },
}

# æ™ºèƒ½åˆ†è¾¨ç‡æ˜ å°„ (æ ¹æ®æºåˆ†è¾¨ç‡å†³å®šè½¬ç ç›®æ ‡)
RESOLUTION_STRATEGY = {
    "4K": {
        "source_min_height": 2160,
        "targets": ["2K", "1080p", "720p", "480p", "360p"],  # 4Kæºè½¬5æ¡£
        "priority": 10,  # æœ€é«˜ä¼˜å…ˆçº§
    },
    "2K": {
        "source_min_height": 1440,
        "targets": ["1080p", "720p", "480p", "360p"],  # 2Kæºè½¬4æ¡£
        "priority": 8,
    },
    "1080p": {
        "source_min_height": 1080,
        "targets": ["720p", "480p", "360p"],  # 1080pæºè½¬3æ¡£
        "priority": 6,
    },
    "720p": {
        "source_min_height": 720,
        "targets": ["480p", "360p"],  # 720pæºè½¬2æ¡£
        "priority": 4,
    },
    "480p": {
        "source_min_height": 480,
        "targets": ["360p"],  # 480pæºä»…è½¬1æ¡£
        "priority": 2,
    },
}
```

### FFmpegå‘½ä»¤ç¤ºä¾‹

#### 1. è½¬ç åˆ°MP4 (1080p)
```bash
ffmpeg -i input.mp4 \
  -c:v libx264 \
  -preset medium \
  -crf 23 \
  -vf scale=1920:1080 \
  -b:v 5000k \
  -maxrate 5500k \
  -bufsize 10000k \
  -c:a aac \
  -b:a 192k \
  -ar 48000 \
  -movflags +faststart \
  -y output_1080p.mp4
```

#### 2. ç”ŸæˆHLSåˆ‡ç‰‡
```bash
ffmpeg -i input.mp4 \
  -c:v libx264 \
  -preset medium \
  -crf 23 \
  -vf scale=1920:1080 \
  -b:v 5000k \
  -c:a aac \
  -b:a 192k \
  -f hls \
  -hls_time 6 \
  -hls_playlist_type vod \
  -hls_segment_filename "1080p/segment_%03d.ts" \
  -hls_list_size 0 \
  1080p/index.m3u8
```

#### 3. ç”Ÿæˆç¼©ç•¥å›¾
```bash
# å°é¢å›¾ (ç¬¬5ç§’)
ffmpeg -i input.mp4 -ss 5 -vframes 1 -q:v 2 poster.jpg

# æ—¶é—´è½´ç¼©ç•¥å›¾ (æ¯10ç§’ä¸€å¼ )
ffmpeg -i input.mp4 -vf "fps=1/10,scale=160:90" \
  thumbnails/thumb_%04d.jpg
```

#### 4. è·å–è§†é¢‘ä¿¡æ¯
```bash
ffprobe -v quiet -print_format json \
  -show_format -show_streams input.mp4
```

---

## ğŸ”„ å·¥ä½œæµç¨‹

### å®Œæ•´è½¬ç æµç¨‹

```mermaid
graph TD
    A[ç”¨æˆ·ä¸Šä¼ è§†é¢‘] --> B[ä¿å­˜åŸå§‹æ–‡ä»¶åˆ°MinIO]
    B --> C[åˆ›å»ºtranscoding_taskè®°å½•]
    C --> D[å‘é€Celeryä»»åŠ¡]
    D --> E[Celery Workeræ¥æ”¶ä»»åŠ¡]
    E --> F[ä¸‹è½½åŸå§‹æ–‡ä»¶åˆ°ä¸´æ—¶ç›®å½•]
    F --> G[ä½¿ç”¨FFprobeåˆ†æè§†é¢‘]
    G --> H{è§†é¢‘æ˜¯å¦æœ‰æ•ˆ?}
    H -->|å¦| I[æ ‡è®°å¤±è´¥,è®°å½•é”™è¯¯]
    H -->|æ˜¯| J[ç¡®å®šéœ€è¦è½¬ç çš„åˆ†è¾¨ç‡]
    J --> K[å¾ªç¯å¤„ç†æ¯ä¸ªåˆ†è¾¨ç‡]
    K --> L[FFmpegè½¬ç ]
    L --> M[ç”ŸæˆHLSåˆ‡ç‰‡]
    M --> N[ä¸Šä¼ åˆ°MinIO]
    N --> O[æ›´æ–°è¿›åº¦]
    O --> P{æ‰€æœ‰åˆ†è¾¨ç‡å®Œæˆ?}
    P -->|å¦| K
    P -->|æ˜¯| Q[ç”Ÿæˆmaster.m3u8]
    Q --> R[ç”Ÿæˆç¼©ç•¥å›¾]
    R --> S[ä¸Šä¼ ç¼©ç•¥å›¾]
    S --> T[æ›´æ–°ä»»åŠ¡çŠ¶æ€ä¸ºcompleted]
    T --> U[æ¸…ç†ä¸´æ—¶æ–‡ä»¶]
    U --> V[å‘é€å®Œæˆé€šçŸ¥]
```

### çŠ¶æ€è½¬æ¢

```
pending â†’ processing â†’ completed
   â†“
  failed â† (å¯é‡è¯•)
```

---

## ğŸ’» ä»£ç å®ç°

### 1. åç«¯ - Celeryä»»åŠ¡

**æ–‡ä»¶**: `backend/app/tasks/transcoding.py`

```python
from celery import Celery, Task
from celery.utils.log import get_task_logger
import subprocess
import json
import os
from pathlib import Path
from typing import Dict, List
import tempfile

from app.config import settings
from app.database import SessionLocal
from app.models.video import Video
from app.models.transcoding import TranscodingTask
from app.utils.minio_client import minio_client

logger = get_task_logger(__name__)

# Celeryé…ç½®
celery_app = Celery(
    'videosite',
    broker=f'redis://{settings.REDIS_HOST}:{settings.REDIS_PORT}/0',
    backend=f'redis://{settings.REDIS_HOST}:{settings.REDIS_PORT}/0'
)

celery_app.conf.update(
    task_serializer='json',
    accept_content=['json'],
    result_serializer='json',
    timezone='UTC',
    enable_utc=True,
    task_track_started=True,
    task_time_limit=1800,  # 30åˆ†é’Ÿè¶…æ—¶
)


class TranscodingTaskBase(Task):
    """è½¬ç ä»»åŠ¡åŸºç±»"""
    
    def on_failure(self, exc, task_id, args, kwargs, einfo):
        """ä»»åŠ¡å¤±è´¥å›è°ƒ"""
        video_id = kwargs.get('video_id')
        if video_id:
            db = SessionLocal()
            try:
                task = db.query(TranscodingTask).filter_by(video_id=video_id).first()
                if task:
                    task.status = 'failed'
                    task.error_message = str(exc)
                    task.retry_count += 1
                    db.commit()
            finally:
                db.close()


@celery_app.task(base=TranscodingTaskBase, bind=True, max_retries=3)
def transcode_video(self, video_id: int):
    """
    ä¸»è½¬ç ä»»åŠ¡
    
    Args:
        video_id: è§†é¢‘ID
    """
    db = SessionLocal()
    temp_dir = None
    
    try:
        # 1. è·å–ä»»åŠ¡è®°å½•
        task = db.query(TranscodingTask).filter_by(video_id=video_id).first()
        if not task:
            raise ValueError(f"Transcoding task not found for video {video_id}")
        
        video = db.query(Video).filter_by(id=video_id).first()
        if not video:
            raise ValueError(f"Video {video_id} not found")
        
        # 2. æ›´æ–°çŠ¶æ€
        task.status = 'processing'
        task.started_at = datetime.utcnow()
        task.current_step = 'initializing'
        db.commit()
        
        # 3. åˆ›å»ºä¸´æ—¶å·¥ä½œç›®å½•
        temp_dir = Path(tempfile.mkdtemp(prefix=f'transcode_{video_id}_'))
        logger.info(f"Created temp directory: {temp_dir}")
        
        # 4. ä¸‹è½½åŸå§‹è§†é¢‘
        task.current_step = 'downloading'
        db.commit()
        
        original_path = temp_dir / 'original.mp4'
        minio_client.download_file(
            bucket=settings.MINIO_BUCKET,
            object_name=video.video_url,
            file_path=str(original_path)
        )
        
        # 5. åˆ†æè§†é¢‘
        task.current_step = 'analyzing'
        db.commit()
        
        video_info = analyze_video(original_path)
        task.duration = video_info['duration']
        task.original_size = original_path.stat().st_size
        db.commit()
        
        # 6. ç¡®å®šéœ€è¦è½¬ç çš„åˆ†è¾¨ç‡
        source_height = video_info['height']
        resolutions_to_transcode = get_applicable_resolutions(source_height)
        
        logger.info(f"Will transcode to resolutions: {resolutions_to_transcode}")
        
        # 7. è½¬ç æ¯ä¸ªåˆ†è¾¨ç‡
        total_steps = len(resolutions_to_transcode) * 2  # è½¬ç  + HLS
        current_step_num = 0
        resolutions = {}
        
        for resolution in resolutions_to_transcode:
            # è½¬ç åˆ°MP4
            current_step_num += 1
            task.current_step = f'transcoding_{resolution}'
            task.progress = int((current_step_num / total_steps) * 80)  # 0-80%
            db.commit()
            
            mp4_path = transcode_to_mp4(
                input_path=original_path,
                output_dir=temp_dir / resolution,
                resolution=resolution,
                profile=TRANSCODING_PROFILES[resolution]
            )
            
            # ç”ŸæˆHLS
            current_step_num += 1
            task.current_step = f'generating_hls_{resolution}'
            task.progress = int((current_step_num / total_steps) * 80)
            db.commit()
            
            hls_path = generate_hls(
                input_path=mp4_path,
                output_dir=temp_dir / 'hls' / resolution,
                resolution=resolution
            )
            
            # ä¸Šä¼ åˆ°MinIO
            hls_url = upload_hls_to_minio(
                video_id=video_id,
                resolution=resolution,
                hls_dir=temp_dir / 'hls' / resolution
            )
            
            resolutions[resolution] = hls_url
        
        # 8. ç”Ÿæˆmaster playlist
        task.current_step = 'generating_master_playlist'
        task.progress = 85
        db.commit()
        
        master_url = generate_master_playlist(
            video_id=video_id,
            resolutions=resolutions,
            output_dir=temp_dir
        )
        
        # 9. ç”Ÿæˆç¼©ç•¥å›¾
        task.current_step = 'generating_thumbnails'
        task.progress = 90
        db.commit()
        
        thumbnails = generate_thumbnails(
            input_path=original_path,
            output_dir=temp_dir / 'thumbnails',
            duration=video_info['duration']
        )
        
        # ä¸Šä¼ ç¼©ç•¥å›¾
        thumbnail_urls = upload_thumbnails_to_minio(
            video_id=video_id,
            thumbnails_dir=temp_dir / 'thumbnails'
        )
        
        # 10. æ›´æ–°æ•°æ®åº“
        task.status = 'completed'
        task.progress = 100
        task.current_step = 'completed'
        task.resolutions = resolutions
        task.master_playlist_url = master_url
        task.thumbnail_urls = thumbnail_urls
        task.poster_url = thumbnail_urls[0] if thumbnail_urls else None
        task.completed_at = datetime.utcnow()
        
        # æ›´æ–°videoè¡¨
        video.has_hls = True
        video.hls_master_url = master_url
        video.available_resolutions = list(resolutions.keys())
        video.transcoding_status = 'completed'
        
        db.commit()
        
        logger.info(f"Transcoding completed for video {video_id}")
        
        return {
            'status': 'success',
            'video_id': video_id,
            'resolutions': resolutions,
            'master_url': master_url
        }
        
    except Exception as e:
        logger.error(f"Transcoding failed for video {video_id}: {str(e)}")
        raise
        
    finally:
        db.close()
        
        # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        if temp_dir and temp_dir.exists():
            import shutil
            shutil.rmtree(temp_dir, ignore_errors=True)


def analyze_video(video_path: Path) -> Dict:
    """åˆ†æè§†é¢‘æ–‡ä»¶"""
    cmd = [
        'ffprobe',
        '-v', 'quiet',
        '-print_format', 'json',
        '-show_format',
        '-show_streams',
        str(video_path)
    ]
    
    result = subprocess.run(cmd, capture_output=True, text=True)
    if result.returncode != 0:
        raise RuntimeError(f"FFprobe failed: {result.stderr}")
    
    probe_data = json.loads(result.stdout)
    
    # æå–è§†é¢‘æµä¿¡æ¯
    video_stream = next(
        (s for s in probe_data['streams'] if s['codec_type'] == 'video'),
        None
    )
    
    if not video_stream:
        raise ValueError("No video stream found")
    
    return {
        'duration': float(probe_data['format']['duration']),
        'width': int(video_stream['width']),
        'height': int(video_stream['height']),
        'codec': video_stream['codec_name'],
        'bitrate': int(probe_data['format'].get('bit_rate', 0)),
    }


def get_applicable_resolutions(source_height: int) -> List[str]:
    """æ ¹æ®æºè§†é¢‘é«˜åº¦ç¡®å®šéœ€è¦è½¬ç çš„åˆ†è¾¨ç‡"""
    resolutions = []
    
    if source_height >= 1080:
        resolutions.append('1080p')
    if source_height >= 720:
        resolutions.append('720p')
    if source_height >= 480:
        resolutions.append('480p')
    resolutions.append('360p')  # æ€»æ˜¯åŒ…å«360p
    
    return resolutions


def transcode_to_mp4(
    input_path: Path,
    output_dir: Path,
    resolution: str,
    profile: Dict
) -> Path:
    """è½¬ç åˆ°MP4æ ¼å¼"""
    output_dir.mkdir(parents=True, exist_ok=True)
    output_path = output_dir / 'video.mp4'
    
    cmd = [
        'ffmpeg',
        '-i', str(input_path),
        '-c:v', 'libx264',
        '-preset', profile['preset'],
        '-crf', str(profile['crf']),
        '-vf', f"scale={profile['resolution']}",
        '-b:v', profile['video_bitrate'],
        '-maxrate', f"{int(profile['video_bitrate'][:-1]) * 1.1}k",
        '-bufsize', f"{int(profile['video_bitrate'][:-1]) * 2}k",
        '-c:a', 'aac',
        '-b:a', profile['audio_bitrate'],
        '-ar', '48000',
        '-movflags', '+faststart',
        '-y',
        str(output_path)
    ]
    
    logger.info(f"Transcoding to {resolution}: {' '.join(cmd)}")
    
    result = subprocess.run(cmd, capture_output=True, text=True)
    if result.returncode != 0:
        raise RuntimeError(f"FFmpeg transcoding failed: {result.stderr}")
    
    return output_path


def generate_hls(
    input_path: Path,
    output_dir: Path,
    resolution: str
) -> Path:
    """ç”ŸæˆHLSåˆ‡ç‰‡"""
    output_dir.mkdir(parents=True, exist_ok=True)
    playlist_path = output_dir / 'index.m3u8'
    
    cmd = [
        'ffmpeg',
        '-i', str(input_path),
        '-c:v', 'copy',  # ç›´æ¥å¤åˆ¶ï¼Œä¸é‡æ–°ç¼–ç 
        '-c:a', 'copy',
        '-f', 'hls',
        '-hls_time', str(HLS_CONFIG['segment_time']),
        '-hls_playlist_type', HLS_CONFIG['hls_playlist_type'],
        '-hls_segment_filename', str(output_dir / 'segment_%03d.ts'),
        '-hls_list_size', str(HLS_CONFIG['hls_list_size']),
        str(playlist_path)
    ]
    
    logger.info(f"Generating HLS for {resolution}: {' '.join(cmd)}")
    
    result = subprocess.run(cmd, capture_output=True, text=True)
    if result.returncode != 0:
        raise RuntimeError(f"HLS generation failed: {result.stderr}")
    
    return playlist_path


# ... æ›´å¤šè¾…åŠ©å‡½æ•° ...
```

### 2. å‰ç«¯ - Video.js HLSæ’­æ”¾å™¨

**æ–‡ä»¶**: `frontend/src/components/VideoPlayer/VideoPlayer.tsx`

```typescript
import { useEffect, useRef } from 'react'
import videojs from 'video.js'
import 'video.js/dist/video-js.css'
import 'videojs-contrib-quality-levels'
import 'videojs-hls-quality-selector'

interface VideoPlayerProps {
  src: string  // HLS master.m3u8 URL
  poster?: string
  onReady?: (player: any) => void
}

const VideoPlayer: React.FC<VideoPlayerProps> = ({ src, poster, onReady }) => {
  const videoRef = useRef<HTMLVideoElement>(null)
  const playerRef = useRef<any>(null)

  useEffect(() => {
    if (!videoRef.current) return

    // åˆå§‹åŒ–Video.js
    const player = videojs(videoRef.current, {
      controls: true,
      responsive: true,
      fluid: true,
      poster: poster,
      html5: {
        vhs: {
          // HLS.jsé…ç½®
          overrideNative: true,
          enableLowInitialPlaylist: true,
        },
      },
      sources: [{
        src: src,
        type: 'application/x-mpegURL',
      }],
    })

    // æ·»åŠ æ¸…æ™°åº¦é€‰æ‹©å™¨
    player.hlsQualitySelector({
      displayCurrentQuality: true,
    })

    // ç›‘å¬æ¸…æ™°åº¦å˜åŒ–
    const qualityLevels = player.qualityLevels()
    qualityLevels.on('change', () => {
      console.log('Quality changed to:', qualityLevels[qualityLevels.selectedIndex])
    })

    playerRef.current = player

    if (onReady) {
      onReady(player)
    }

    // æ¸…ç†
    return () => {
      if (playerRef.current) {
        playerRef.current.dispose()
        playerRef.current = null
      }
    }
  }, [src, poster, onReady])

  return (
    <div data-vjs-player>
      <video
        ref={videoRef}
        className="video-js vjs-big-play-centered"
      />
    </div>
  )
}

export default VideoPlayer
```

---

## ğŸ“Š ç›‘æ§å’Œç®¡ç†

### 1. è½¬ç è¿›åº¦æŸ¥è¯¢API

```python
@router.get("/videos/{video_id}/transcoding-status")
async def get_transcoding_status(
    video_id: int,
    db: AsyncSession = Depends(get_db)
):
    """æŸ¥è¯¢è½¬ç çŠ¶æ€"""
    task = await db.execute(
        select(TranscodingTask).filter_by(video_id=video_id)
    )
    task = task.scalar_one_or_none()
    
    if not task:
        raise HTTPException(404, "Transcoding task not found")
    
    return {
        "video_id": video_id,
        "status": task.status,
        "progress": task.progress,
        "current_step": task.current_step,
        "resolutions": task.resolutions,
        "error": task.error_message
    }
```

### 2. é‡è¯•å¤±è´¥ä»»åŠ¡

```python
@router.post("/admin/transcoding/{task_id}/retry")
async def retry_transcoding(
    task_id: int,
    current_admin: AdminUser = Depends(get_current_admin_user),
    db: AsyncSession = Depends(get_db)
):
    """é‡è¯•å¤±è´¥çš„è½¬ç ä»»åŠ¡"""
    task = await db.execute(
        select(TranscodingTask).filter_by(id=task_id)
    )
    task = task.scalar_one_or_none()
    
    if not task:
        raise HTTPException(404, "Task not found")
    
    if task.status != 'failed':
        raise HTTPException(400, "Only failed tasks can be retried")
    
    # é‡ç½®çŠ¶æ€
    task.status = 'pending'
    task.progress = 0
    task.error_message = None
    await db.commit()
    
    # é‡æ–°å‘é€åˆ°é˜Ÿåˆ—
    transcode_video.delay(video_id=task.video_id)
    
    return {"message": "Task queued for retry"}
```

### 3. Celeryç›‘æ§ (Flower)

```bash
# å®‰è£…Flower
pip install flower

# å¯åŠ¨ç›‘æ§ç•Œé¢
celery -A app.tasks.transcoding flower --port=5555

# è®¿é—®: http://localhost:5555
```

---

## âš¡ æ€§èƒ½ä¼˜åŒ–

### 1. GPUåŠ é€Ÿ

```python
# ä½¿ç”¨NVIDIA GPUåŠ é€Ÿç¼–ç 
def transcode_to_mp4_gpu(...):
    cmd = [
        'ffmpeg',
        '-hwaccel', 'cuda',  # GPUè§£ç 
        '-i', str(input_path),
        '-c:v', 'h264_nvenc',  # NVIDIAç¼–ç å™¨
        '-preset', 'p4',  # GPU preset
        '-rc', 'vbr',  # å¯å˜ç ç‡
        '-cq', '23',
        # ... å…¶ä»–å‚æ•°
    ]
```

### 2. å¹¶å‘è½¬ç 

```python
# åŒæ—¶è½¬ç å¤šä¸ªåˆ†è¾¨ç‡
from concurrent.futures import ThreadPoolExecutor

with ThreadPoolExecutor(max_workers=4) as executor:
    futures = [
        executor.submit(transcode_to_mp4, original_path, res, profile)
        for res, profile in TRANSCODING_PROFILES.items()
    ]
    results = [f.result() for f in futures]
```

### 3. é¢„è®¾ä¼˜åŒ–

```python
# æ ¹æ®åœºæ™¯é€‰æ‹©preset
PRESETS = {
    'high_quality': 'slow',      # æœ€ä½³è´¨é‡ï¼Œè½¬ç æ…¢
    'balanced': 'medium',         # å¹³è¡¡
    'fast': 'fast',              # å¿«é€Ÿï¼Œè´¨é‡ç¨ä½
    'realtime': 'veryfast',      # å®æ—¶ï¼Œè´¨é‡è¾ƒä½
}
```

---

## ğŸ’° æˆæœ¬ä¼°ç®—

### è®¡ç®—èµ„æº

**å•ä¸ªè§†é¢‘è½¬ç æˆæœ¬** (1å°æ—¶1080pè§†é¢‘):

| é¡¹ç›® | é…ç½® | æ—¶é—´ | æˆæœ¬ |
|------|------|------|------|
| CPUè½¬ç  | 4æ ¸8G | ~2å°æ—¶ | Â¥0.5 |
| GPUè½¬ç  | NVIDIA T4 | ~20åˆ†é’Ÿ | Â¥0.8 |
| å­˜å‚¨ | MinIO/S3 | - | Â¥0.1/GB/æœˆ |
| å¸¦å®½ | CDN | - | Â¥0.2/GB |

**æœˆåº¦æˆæœ¬ä¼°ç®—** (1000ä¸ªè§†é¢‘/æœˆ):
- è½¬ç : Â¥500-800
- å­˜å‚¨: Â¥100-200 (2TB)
- å¸¦å®½: æ ¹æ®è§‚çœ‹é‡

### å­˜å‚¨éœ€æ±‚

| åˆ†è¾¨ç‡ | ç ç‡ | 1å°æ—¶å¤§å° | å æ¯” |
|--------|------|-----------|------|
| åŸå§‹1080p | ~10Mbps | 4.5GB | 45% |
| 1080p HLS | 5Mbps | 2.2GB | 22% |
| 720p HLS | 2.5Mbps | 1.1GB | 11% |
| 480p HLS | 1Mbps | 450MB | 4.5% |
| 360p HLS | 600Kbps | 270MB | 2.7% |
| ç¼©ç•¥å›¾ | - | 10MB | 0.1% |
| **æ€»è®¡** | - | ~10GB | 100% |

---

## ğŸš§ å®æ–½æ­¥éª¤

### Phase 1: åŸºç¡€è®¾æ–½ (3-4å¤©)

1. **ç¯å¢ƒå‡†å¤‡**
   - [ ] å®‰è£…FFmpeg (4.4+)
   - [ ] å®‰è£…Redis (å·²æœ‰)
   - [ ] å®‰è£…Celery
   - [ ] é…ç½®MinIO bucket

2. **æ•°æ®åº“è¿ç§»**
   - [ ] åˆ›å»ºtranscoding_tasksè¡¨
   - [ ] æ‰©å±•videosè¡¨
   - [ ] è¿è¡Œè¿ç§»è„šæœ¬

3. **Celeryé…ç½®**
   - [ ] åˆ›å»ºcelery app
   - [ ] é…ç½®worker
   - [ ] è®¾ç½®ç›‘æ§(Flower)

### Phase 2: æ ¸å¿ƒåŠŸèƒ½ (5-7å¤©)

4. **è½¬ç ä»»åŠ¡**
   - [ ] å®ç°è§†é¢‘åˆ†æ
   - [ ] å®ç°MP4è½¬ç 
   - [ ] å®ç°HLSç”Ÿæˆ
   - [ ] å®ç°ç¼©ç•¥å›¾ç”Ÿæˆ

5. **æ–‡ä»¶ç®¡ç†**
   - [ ] MinIOä¸Šä¼ /ä¸‹è½½
   - [ ] ä¸´æ—¶æ–‡ä»¶æ¸…ç†
   - [ ] å­˜å‚¨ç»“æ„è®¾è®¡

6. **APIå¼€å‘**
   - [ ] ä¸Šä¼ è§¦å‘è½¬ç 
   - [ ] æŸ¥è¯¢è½¬ç çŠ¶æ€
   - [ ] é‡è¯•å¤±è´¥ä»»åŠ¡

### Phase 3: å‰ç«¯é›†æˆ (3-4å¤©)

7. **æ’­æ”¾å™¨å‡çº§**
   - [ ] é›†æˆVideo.js HLS
   - [ ] æ·»åŠ æ¸…æ™°åº¦åˆ‡æ¢
   - [ ] ä¼˜åŒ–åŠ è½½ä½“éªŒ

8. **ç®¡ç†ç•Œé¢**
   - [ ] è½¬ç ä»»åŠ¡åˆ—è¡¨
   - [ ] è¿›åº¦ç›‘æ§
   - [ ] é‡è¯•/å–æ¶ˆåŠŸèƒ½

### Phase 4: æµ‹è¯•ä¼˜åŒ– (2-3å¤©)

9. **æµ‹è¯•**
   - [ ] å•å…ƒæµ‹è¯•
   - [ ] é›†æˆæµ‹è¯•
   - [ ] æ€§èƒ½æµ‹è¯•

10. **ä¼˜åŒ–**
    - [ ] GPUåŠ é€Ÿ
    - [ ] å¹¶å‘ä¼˜åŒ–
    - [ ] é”™è¯¯å¤„ç†

---

## ğŸ”’ å®‰å…¨è€ƒè™‘

### 1. æ–‡ä»¶éªŒè¯

```python
# éªŒè¯æ–‡ä»¶ç±»å‹å’Œå¤§å°
ALLOWED_VIDEO_FORMATS = ['mp4', 'avi', 'mov', 'mkv', 'flv']
MAX_VIDEO_SIZE = 10 * 1024 * 1024 * 1024  # 10GB

def validate_video_file(file_path: Path):
    # æ£€æŸ¥æ–‡ä»¶å¤§å°
    if file_path.stat().st_size > MAX_VIDEO_SIZE:
        raise ValueError("Video file too large")
    
    # æ£€æŸ¥æ–‡ä»¶ç±»å‹(é€šè¿‡FFprobe)
    video_info = analyze_video(file_path)
    if video_info['codec'] not in ALLOWED_CODECS:
        raise ValueError("Unsupported video codec")
```

### 2. ä»»åŠ¡éš”ç¦»

```python
# é™åˆ¶å¹¶å‘ä»»åŠ¡æ•°
@celery_app.task(rate_limit='10/h')  # æ¯å°æ—¶æœ€å¤š10ä¸ª
def transcode_video(video_id: int):
    ...
```

### 3. å­˜å‚¨å®‰å…¨

```python
# MinIOè®¿é—®æ§åˆ¶
# è½¬ç åçš„æ–‡ä»¶è®¾ç½®ä¸ºåªè¯»
minio_client.set_object_acl(
    bucket='videos',
    object_name=f'{video_id}/hls/master.m3u8',
    acl='public-read'
)
```

---

## ğŸ“š ä¾èµ–é¡¹

### Pythonä¾èµ–

```txt
# requirements.txt æ–°å¢
celery[redis]==5.3.4
flower==2.0.1
python-magic==0.4.27  # æ–‡ä»¶ç±»å‹æ£€æµ‹
```

### ç³»ç»Ÿä¾èµ–

```bash
# Ubuntu/Debian
sudo apt-get update
sudo apt-get install -y ffmpeg redis-server

# æ£€æŸ¥ç‰ˆæœ¬
ffmpeg -version  # éœ€è¦ >= 4.4
redis-server --version
```

### å‰ç«¯ä¾èµ–

```json
// frontend/package.json
{
  "dependencies": {
    "video.js": "^8.6.1",
    "videojs-contrib-quality-levels": "^2.2.0",
    "videojs-hls-quality-selector": "^1.1.4"
  }
}
```

---

## ğŸ› å¸¸è§é—®é¢˜

### Q1: è½¬ç å¤±è´¥ï¼Œé”™è¯¯"codec not found"
**è§£å†³**: ç¡®ä¿FFmpegç¼–è¯‘æ—¶åŒ…å«äº†libx264å’Œaacç¼–ç å™¨
```bash
ffmpeg -codecs | grep -E "h264|aac"
```

### Q2: HLSæ’­æ”¾å¡é¡¿
**è§£å†³**: 
- å‡å°segment_time (4-6ç§’)
- ä¼˜åŒ–ç½‘ç»œå¸¦å®½
- å¯ç”¨CDN

### Q3: è½¬ç é€Ÿåº¦æ…¢
**è§£å†³**:
- ä½¿ç”¨GPUåŠ é€Ÿ (h264_nvenc)
- è°ƒæ•´preset (fast/veryfast)
- å¢åŠ workeræ•°é‡

### Q4: å­˜å‚¨ç©ºé—´ä¸è¶³
**è§£å†³**:
- åˆ é™¤åŸå§‹æ–‡ä»¶(ä¿ç•™è½¬ç ç‰ˆæœ¬)
- å®šæœŸæ¸…ç†æ—§è§†é¢‘
- ä½¿ç”¨å¯¹è±¡å­˜å‚¨ç”Ÿå‘½å‘¨æœŸç­–ç•¥

---

## ğŸ“– å‚è€ƒèµ„æ–™

### å®˜æ–¹æ–‡æ¡£
- [FFmpegå®˜æ–¹æ–‡æ¡£](https://ffmpeg.org/documentation.html)
- [HLSè§„èŒƒ](https://datatracker.ietf.org/doc/html/rfc8216)
- [Celeryæ–‡æ¡£](https://docs.celeryproject.org/)
- [Video.jsæ–‡æ¡£](https://videojs.com/)

### æœ€ä½³å®è·µ
- [Apple HLSæŒ‡å—](https://developer.apple.com/documentation/http_live_streaming)
- [Netflixè§†é¢‘ç¼–ç ](https://netflixtechblog.com/per-title-encode-optimization-7e99442b62a2)

---

## ğŸ“ æ€»ç»“

æœ¬æ–‡æ¡£æä¾›äº†å®Œæ•´çš„è§†é¢‘è½¬ç å’Œå¤šåˆ†è¾¨ç‡ç³»ç»Ÿè®¾è®¡æ–¹æ¡ˆï¼ŒåŒ…æ‹¬ï¼š

âœ… **æ¶æ„è®¾è®¡**: æ¸…æ™°çš„ç³»ç»Ÿæ¶æ„å’Œæ•°æ®æµ  
âœ… **æ•°æ®åº“è®¾è®¡**: å®Œæ•´çš„è¡¨ç»“æ„å’Œç´¢å¼•  
âœ… **æŠ€æœ¯é€‰å‹**: ç»è¿‡éªŒè¯çš„æŠ€æœ¯æ ˆ  
âœ… **ä»£ç ç¤ºä¾‹**: å¯ç›´æ¥ä½¿ç”¨çš„ä»£ç æ¡†æ¶  
âœ… **éƒ¨ç½²æŒ‡å—**: åˆ†é˜¶æ®µå®æ–½è®¡åˆ’  
âœ… **æˆæœ¬ä¼°ç®—**: è¯¦ç»†çš„èµ„æºæˆæœ¬åˆ†æ  

æ ¹æ®æœ¬æ–‡æ¡£ï¼Œå¼€å‘å›¢é˜Ÿå¯ä»¥ï¼š
1. ç†è§£å®Œæ•´çš„æŠ€æœ¯æ¶æ„
2. ä¼°ç®—å¼€å‘æ—¶é—´å’Œæˆæœ¬
3. æŒ‰æ­¥éª¤å®æ–½åŠŸèƒ½
4. é¿å…å¸¸è§çš„å‘

**å»ºè®®**: å…ˆå®ç°åŸºç¡€ç‰ˆæœ¬ï¼ˆå•åˆ†è¾¨ç‡+HLSï¼‰ï¼ŒéªŒè¯å¯è¡Œæ€§åå†æ‰©å±•åˆ°å¤šåˆ†è¾¨ç‡ã€‚

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**åˆ›å»ºæ—¶é—´**: 2025-10-09  
**é¢„è®¡å¼€å‘å‘¨æœŸ**: 2-3å‘¨  
**ä¸‹ä¸€æ­¥**: å‡†å¤‡å¼€å‘ç¯å¢ƒå’Œä¾èµ–å®‰è£…
